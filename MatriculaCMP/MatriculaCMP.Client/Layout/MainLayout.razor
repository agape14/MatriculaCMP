@using MatriculaCMP.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-3">
            <div class="d-flex justify-content-between align-items-center w-100 flex-wrap">
                <div class="d-flex align-items-center flex-grow-1 min-width-0">
                    <i class="ri-user-heart-line me-2 fs-5 d-none d-sm-inline"></i>
                    <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center flex-grow-1 min-width-0">
                        <span class="text-info text-truncate me-sm-3 mb-1 mb-sm-0">
                            <i class="ri-user-line me-1 d-sm-none"></i>
                            <strong>@nombresCompletos</strong>
                        </span>
                        <div class="vr mx-2 d-none d-sm-inline" style="height: 20px; opacity: 0.3;"></div>
                        <span class="text-info text-truncate">
                            <i class="ri-shield-user-line me-1"></i>
                            <strong>@nombrePerfil</strong>
                        </span>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-2 flex-shrink-0">
                    <!-- Mobile Menu Button (Bootstrap Collapse) -->
                    <button id="btnMobileMenu" class="btn btn-outline-light btn-sm d-md-none" type="button"
                            data-bs-toggle="collapse" data-bs-target=".mobile-collapse" aria-controls="mobileMenu mobileMenuBackdrop"
                            aria-expanded="false" aria-label="Toggle navigation" title="Menú">
                        <i class="ri-menu-line"></i>
                    </button>

                    <!-- Logout Button -->
                    <button class="btn btn-danger btn-sm d-flex align-items-center" @onclick="Salir" title="Cerrar sesión">
                        <i class="ri-logout-box-r-line me-1"></i>
                        <span class="d-none d-sm-inline">Cerrar Sesión</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- .NET 8 Style Mobile Dropdown Menu (Bootstrap Collapse) -->
        <div id="mobileMenu" class="mobile-collapse collapse d-md-none" aria-labelledby="btnMobileMenu">
            <div class="mobile-menu-content">
                <div class="mobile-menu-header">
                    <i class="ri-building-2-line me-2"></i>
                    <strong>MatriculaCMP</strong>
                </div>
                
                <div class="mobile-menu-items">
                    <!-- Always show Inicio -->
                    <a href="/home" class="mobile-menu-item">
                        <i class="ri-home-line"></i>
                        <span>Inicio</span>
                    </a>
                    
                    @if (perfilUsuario == "2" || perfilUsuario == "1")
                    {
                        <!-- Solicitante -->
                        <div class="mobile-menu-section">
                            <i class="ri-user-line"></i>
                            <strong>Solicitante</strong>
                        </div>
                        <a href="/solicitudes/prematricula" class="mobile-menu-item">
                            <i class="ri-file-add-line"></i>
                            <span>Reg. Pre-matricula</span>
                        </a>
                        <a href="/solicitudes/seguimiento" class="mobile-menu-item">
                            <i class="ri-timer-line"></i>
                            <span>Seguimiento Trámite</span>
                        </a>
                    }
                    
                    @if (perfilUsuario == "3" || perfilUsuario == "4" || perfilUsuario == "1")
                    {
                        <!-- Consejo Regional -->
                        <div class="mobile-menu-section">
                            <i class="ri-government-line"></i>
                            <strong>Consejo Regional</strong>
                        </div>
                        <a href="/consejoregional/lista" class="mobile-menu-item">
                            <i class="ri-folder-list-line"></i>
                            <span>Solicitudes</span>
                        </a>
                        <a href="/consejoregional/firmar-diplomas" class="mobile-menu-item">
                            <i class="ri-shield-check-line"></i>
                            <span>Firmar Diplomas</span>
                        </a>
                    }
                    
                    @if (perfilUsuario == "3" || perfilUsuario == "5" || perfilUsuario == "1")
                    {
                        <!-- Secretaría General -->
                        <div class="mobile-menu-section">
                            <i class="ri-shield-star-line"></i>
                            <strong>Secretaría General</strong>
                        </div>
                        <a href="/secretariageneral/lista" class="mobile-menu-item">
                            <i class="ri-folder-shield-line"></i>
                            <span>Solicitudes CR</span>
                        </a>
                        <a href="/secretariageneral/firmar-diplomas" class="mobile-menu-item">
                            <i class="ri-shield-check-line"></i>
                            <span>Firmar Diplomas</span>
                        </a>
                    }
                    
                    @if (perfilUsuario == "6" || perfilUsuario == "1")
                    {
                        <!-- Oficina Matrícula -->
                        <div class="mobile-menu-section">
                            <i class="ri-building-line"></i>
                            <strong>Oficina Matrícula</strong>
                        </div>
                        <a href="/oficinamatricula/lista" class="mobile-menu-item">
                            <i class="ri-check-double-line"></i>
                            <span>Lista Autorizadas</span>
                        </a>
                    }
                    
                    @if (perfilUsuario == "7" || perfilUsuario == "1")
                    {
                        <!-- Decanato -->
                        <div class="mobile-menu-section">
                            <i class="ri-award-line"></i>
                            <strong>Decanato</strong>
                        </div>
                        <a href="/decanato/lista" class="mobile-menu-item">
                            <i class="ri-file-list-3-line"></i>
                            <span>Lista de Diplomas</span>
                        </a>
                    }
                    
                    @if (perfilUsuario == "1")
                    {
                        <!-- Administrador -->
                        <div class="mobile-menu-section">
                            <i class="ri-settings-3-line"></i>
                            <strong>Administrador</strong>
                        </div>
                        <a href="/admin/usuarios" class="mobile-menu-item">
                            <i class="ri-user-add-line"></i>
                            <span>Crear Usuarios</span>
                        </a>
                        <a href="/admin/perfiles" class="mobile-menu-item">
                            <i class="ri-user-settings-line"></i>
                            <span>Perfil</span>
                        </a>
                        <a href="/admin/perfiles-menu" class="mobile-menu-item">
                            <i class="ri-menu-add-line"></i>
                            <span>Menú Perfiles</span>
                        </a>
                    }

                    @if (string.IsNullOrEmpty(perfilUsuario))
                    {
                        <div class="mobile-menu-section">
                            <i class="ri-alert-line"></i>
                            <strong>Menú de Prueba</strong>
                        </div>
                        <a href="/test1" class="mobile-menu-item">
                            <i class="ri-file-line"></i>
                            <span>Opción 1</span>
                        </a>
                        <a href="/test2" class="mobile-menu-item">
                            <i class="ri-folder-line"></i>
                            <span>Opción 2</span>
                        </a>
                        <a href="/test3" class="mobile-menu-item">
                            <i class="ri-settings-line"></i>
                            <span>Opción 3</span>
                        </a>
                    }
                </div>
            </div>
        </div>

        <!-- Backdrop that also collapses the menu when tapped -->
        <div id="mobileMenuBackdrop" class="mobile-backdrop mobile-collapse collapse d-md-none" role="button"
             data-bs-toggle="collapse" data-bs-target=".mobile-collapse" aria-controls="mobileMenu mobileMenuBackdrop"
             aria-label="Cerrar menú móvil"></div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui">
    Se ha producido un error no manejado.
    <a href="" class="reload">Recargar Página</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private string nombresCompletos;
    private string nombrePerfil;
    private string perfilUsuario = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated ?? false)
            {
                nombresCompletos = user.FindFirst("NombresCompletos")?.Value ?? "-";
                nombrePerfil = user.FindFirst("PerfilNombre")?.Value ?? "-";
                perfilUsuario = user.FindFirst("PerfilId")?.Value ?? "1";
            }
            else
            {
                perfilUsuario = "1"; // Default fallback
            }
        }
        catch (Exception ex)
        {
            perfilUsuario = "1"; // Default fallback
        }
    }

    // Using Bootstrap Collapse data attributes for mobile menu toggle; no C# toggle needed

    async Task Salir()
    {
        // Mostrar confirmación con SweetAlert
        var result = await JS.InvokeAsync<bool>("confirmarCerrarSesion");
        
        if (result)
        {
            await JS.InvokeVoidAsync("localStorage.removeItem", "Token");
            await AuthenticationStateProvider.GetAuthenticationStateAsync();
            Navigation.NavigateTo("/", true);
        }
    }
}
