@page "/"
@layout LoginLayout
@using MatriculaCMP.Client.Layout
@using MatriculaCMP.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.IdentityModel.Tokens.Jwt
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
</style>

<div class="login-container">
    <div class="row p-4">
        <div class="col-sm-2">
            <div class="form-group mb-3">
                <label for="numeroDocumento" class="mb-1">DNI</label>
                <input type="text"
                       id="numeroDocumento"
                       class="form-control"
                       @bind="NumeroDocumento"
                       maxlength="8"
                       placeholder="Ingrese su DNI" />
            </div>
        </div>
        <div class="col-sm-4">
            <button class="btn btn-danger  waves-effect waves-light mt-4" disabled="@loginSgdCargando" @onclick="IniciarSesion">
                @if (loginSgdCargando) { <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> }
                INICIAR SESIÓN DESDE SGD
            </button>
        </div>
        <div class="col-sm-6">
            <button class="btn btn-primary  waves-effect waves-light mt-4" disabled="@irALoginCargando" @onclick="IniciarSesionUsuarioContraseña">
                @if (irALoginCargando) { <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> }
                INICIAR CON USUARIO Y CONTRASEÑA
            </button>
        </div>
        
    </div>
    
</div>

@code {
    private string mensaje;
    // Valores por defecto 41342572
    private string TipoDocumento = "DNI";
    private string NumeroDocumento = "76777223";

    protected override async Task OnInitializedAsync()
    {
        Salir();
    }

    private async Task IniciarSesion()
    {
        try
        {
            // Validar que el número de documento no esté vacío
            if (string.IsNullOrWhiteSpace(NumeroDocumento))
            {
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "warning",
                    title = "Datos incompletos",
                    text = "Por favor, ingrese su DNI.",
                    confirmButtonText = "Aceptar"
                });
                return;
            }

            // Validar que el DNI tenga 8 dígitos
            if (NumeroDocumento.Length != 8 || !NumeroDocumento.All(char.IsDigit))
            {
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "warning",
                    title = "DNI inválido",
                    text = "El DNI debe tener 8 dígitos.",
                    confirmButtonText = "Aceptar"
                });
                return;
            }

            loginSgdCargando = true;
            StateHasChanged();
            
            // 1. Verificar que el DNI NO sea de un médico colegiado CMP (antes de consultar SGD/BD)
            await JS.InvokeVoidAsync("mostrarSpinnerLogin", "Verificando documento...");
            await Task.Delay(100);
            
            var consultaEsMedicoResp = await Http.GetAsync($"api/reniec/consulta-es-medico/{NumeroDocumento}");
            if (consultaEsMedicoResp.IsSuccessStatusCode)
            {
                var consultaJson = await consultaEsMedicoResp.Content.ReadFromJsonAsync<JsonElement>();
                if (consultaJson.TryGetProperty("esMedico", out var esMedicoEl) && esMedicoEl.GetBoolean())
                {
                    await JS.InvokeVoidAsync("Swal.close");
                    await JS.InvokeVoidAsync("Swal.fire", new
                    {
                        icon = "warning",
                        title = "Acceso no permitido",
                        text = "El DNI ingresado corresponde a un médico colegiado del CMP. Para iniciar sesión utilice la opción 'Iniciar con usuario y contraseña'.",
                        confirmButtonText = "Aceptar"
                    });
                    return;
                }
            }
            
            // 2. Continuar con login SGD (DNI no es médico o no se pudo verificar)
            await JS.InvokeVoidAsync("mostrarSpinnerLogin", "Validando usuario...");
            await Task.Delay(100);
            
            string tipoEncriptado = await JS.InvokeAsync<string>("btoa", TipoDocumento);
            string numeroEncriptado = await JS.InvokeAsync<string>("btoa", NumeroDocumento);

            var dto = new UsuarioLoginEncryptedDTO
            {
                TipoDocumentoEncrypted = tipoEncriptado,
                NumeroDocumentoEncrypted = numeroEncriptado,
                PerfilId = 2
            };

            var response = await Http.PostAsJsonAsync("api/usuario/LoginSgd", dto);
            
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadFromJsonAsync<JsonElement>();
                
                if (json.TryGetProperty("token", out JsonElement tokenElement))
                {
                    var token = tokenElement.GetString();
                    
                    if (!string.IsNullOrEmpty(token))
                    {
                        await JS.InvokeVoidAsync("Swal.close");
                        
                        // Guardar el token directamente en localStorage
                        await JS.InvokeVoidAsync("localStorage.setItem", "Token", token);
                        
                        // Pequeña pausa antes de navegar
                        await Task.Delay(100);
                        
                        // Navegar directamente a home
                        Nav.NavigateTo("/home", forceLoad: true);
                    }
                    else
                    {
                        throw new Exception("Token vacío recibido del servidor.");
                    }
                }
                else
                {
                    throw new Exception("No se recibió un token válido del servidor.");
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                await JS.InvokeVoidAsync("Swal.close");
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "error",
                    title = "Usuario no encontrado",
                    text = "Comuníquese con el administrador.",
                    confirmButtonText = "Aceptar"
                });
            }
            else
            {
                await JS.InvokeVoidAsync("Swal.close");
                var errorContent = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "error",
                    title = "Error al iniciar sesión",
                    text = $"Código: {(int)response.StatusCode}. {errorContent}",
                    confirmButtonText = "Cerrar"
                });
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("Swal.close");
            await JS.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error inesperado",
                text = $"Detalles: {ex.Message}",
                confirmButtonText = "Cerrar"
            });
            Console.WriteLine($"Error en IniciarSesion: {ex}");
        }
        finally
        {
            loginSgdCargando = false;
            StateHasChanged();
        }
    }

    private async Task IniciarSesionUsuarioContraseña()
    {
        try
        {
            irALoginCargando = true;
            StateHasChanged();
            await Task.Delay(10);
            Nav.NavigateTo("/login");
        }
        finally
        {
            irALoginCargando = false;
        }
    }

    async Task Salir()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "Token");
        await AuthenticationStateProvider.GetAuthenticationStateAsync();
    }
    private bool loginSgdCargando = false;
    private bool irALoginCargando = false;
}