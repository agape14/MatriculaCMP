@page "/solicitudes/prematricula"
@page "/solicitudes/prematricula/{SolicitudId:int}"
@using MatriculaCMP.Client.Services
@using System.Net.Http.Headers;
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using MatriculaCMP.Shared
@using System.Text.Json
@using System.IO
@using System.Threading


@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject HttpClient Http
@inject AuthenticationStateProvider AuthenticationStateProvider

<style>
	.loading-overlay {
	position: fixed;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	background-color: rgba(255, 255, 255, 0.7);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 2000; /* aseguramos que est√© encima */
}
</style>


@if (charging)
{
	<div class="loading-overlay">
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Cargando...</span>
		</div>
	</div>
}

<!-- Bot√≥n flotante para ver observaciones -->
@if (esCorreccionPorObservacion && !mostrarObservaciones)
{
	<button type="button" class="btn btn-warning position-fixed shadow" 
			style="bottom: 20px; right: 20px; z-index: 1000; border-radius: 50px;"
			@onclick="() => mostrarObservaciones = true">
		<i class="ri-alert-line me-1"></i>
		<span class="d-none d-md-inline">Ver Observaciones</span>
		<span class="d-inline d-md-none">‚ö†Ô∏è</span>
	</button>
}

<!-- Modal para mostrar observaciones -->
@if (mostrarObservaciones)
{
	<div class="modal fade show" style="display: block;" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header bg-warning text-dark">
					<h5 class="modal-title">
						‚ö†Ô∏è Observaciones de la Solicitud
					</h5>
					<button type="button" class="btn-close" @onclick="CerrarObservaciones"></button>
				</div>
				<div class="modal-body">
					<div class="alert alert-warning">
						<h6><strong>Estado Actual:</strong> @estadoActual</h6>
						<p><strong>Observaciones:</strong></p>
						<div class="border p-3 bg-light">
							@observacionesSolicitud
						</div>
					</div>
					<div class="alert alert-info">
						<p><strong>Instrucciones:</strong></p>
						<ul>
							<li>Revise cuidadosamente las observaciones indicadas</li>
							<li>Corrija los campos que necesiten ajustes</li>
							<li>Una vez corregido, guarde los cambios</li>
							<li>Despu√©s de guardar, regrese al listado y haga clic en "Reenviar"</li>
						</ul>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" @onclick="CerrarObservaciones">Cerrar</button>
					<button type="button" class="btn btn-primary" @onclick="CerrarObservaciones">Entendido</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal-backdrop fade show"></div>
}
<div class="container-fluid">
	<!-- start page title -->
	<div class="row">
		<div class="col-12">
			<div class="page-title-box d-sm-flex align-items-center justify-content-between">
				<h4 class="mb-sm-0">Ficha Pre-matricula</h4>
				<div class="page-title-right">
					<ol class="breadcrumb m-0">
						<li class="breadcrumb-item"><a href="javascript: void(0);">Inicio</a></li>
						<li class="breadcrumb-item active">Ficha Pre-matricula</li>
					</ol>
				</div>

			</div>
		</div>
	</div>
	<!-- end page title -->
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="container-contact100">
						<div class="wrap-contact100">
							@* Callout Consulta Es M√©dico: arriba de todo, antes del stepper. Mensaje indica si el DNI es m√©dico o no. *@
							@if (mostrarCalloutEsMedico)
							{
								<div class="mb-3 @(resultadoEsMedico == true ? "bd-callout bd-callout-danger" : "bd-callout bd-callout-info")">
									<strong>@(resultadoEsMedico == true ? "‚ö†Ô∏è Atenci√≥n:" : "‚ÑπÔ∏è Informaci√≥n:")</strong>
									@mensajeConsultaMedico
								</div>
							}

							<!-- Stepper -->
							<div class="cmp-stepper mb-3">
								<ol class="cmp-steps">
									<li class="@StepClass(1)">
										<span class="cmp-step-circle">
											@if (ShouldShowCheck(1))
											{
												<i class="ri-check-line" aria-hidden="true"></i>
											}
										</span>
										<span class="cmp-step-label">1. Registro inicial</span>
									</li>
									<li class="@StepClass(2)">
										<span class="cmp-step-circle">
											@if (ShouldShowCheck(2))
											{
												<i class="ri-check-line" aria-hidden="true"></i>
											}
										</span>
										<span class="cmp-step-label">2. Curso de √âtica</span>
									</li>
									<li class="@StepClass(3)">
										<span class="cmp-step-circle">
											@if (ShouldShowCheck(3))
											{
												<i class="ri-check-line" aria-hidden="true"></i>
											}
										</span>
										<span class="cmp-step-label">3. Completar datos</span>
									</li>
									<li class="@StepClass(4)">
										<span class="cmp-step-circle">
											@if (ShouldShowCheck(4))
											{
												<i class="ri-check-line" aria-hidden="true"></i>
											}
										</span>
										<span class="cmp-step-label">4. Pago</span>
									</li>
									<li class="@StepClass(5)">
										<span class="cmp-step-circle">
											@if (ShouldShowCheck(5))
											{
												<i class="ri-check-line" aria-hidden="true"></i>
											}
										</span>
										<span class="cmp-step-label">5. Solicitud enviada</span>
									</li>
								</ol>
							</div>

							@* Banner de observaciones si viene de correcci√≥n *@
							@if (esCorreccionPorObservacion)
							{
								<div class="alert alert-warning d-flex align-items-start mb-3">
									<div class="me-2">‚ö†Ô∏è</div>
									<div class="flex-grow-1">
										<div class="fw-bold">Esta solicitud tiene observaciones</div>
										<div class="small">Revise y corrija los campos indicados seg√∫n las observaciones del revisor.</div>
									</div>
									<button type="button" class="btn btn-sm btn-outline-warning" @onclick="() => mostrarObservaciones = true">
										<i class="ri-eye-line"></i> Ver Observaciones
									</button>
								</div>
							}

							@* PASO 1: Registro inicial *@
							@if (currentStep == 1)
							{
								<div>
									<div class="row">
										<div class="col-md-12">
											<div class="form-group">
												<label class="fw-bold">Seleccione su perfil *</label>
												<InputSelect TValue="string"
															 Value="@perfilSeleccionado"
															 ValueChanged="@((string val) => OnPerfilSeleccionado(val))"
															 ValueExpression="@(() => perfilSeleccionado)"
															 class="@($"form-control {(string.IsNullOrWhiteSpace(perfilSeleccionado) && intentadoEnviar ? "is-invalid" : "")}")">
													<option value="">Seleccione perfil</option>
													<option value="1">1. Profesional peruano con t√≠tulo de universidad peruana</option>
													<option value="2">2. Profesional peruano con t√≠tulo de universidad extranjera</option>
													<option value="3">3. Profesional extranjero con t√≠tulo otorgado en el Per√∫</option>
													<option value="4">4. Profesional extranjero con t√≠tulo otorgado en el extranjero</option>
												</InputSelect>
												@if (string.IsNullOrWhiteSpace(perfilSeleccionado) && intentadoEnviar)
												{
													<div class="invalid-feedback d-block">Seleccione un perfil.</div>
												}
												<div class="small text-muted mt-1">
													Perfil gu√≠a los requisitos del curso de √âtica y la documentaci√≥n a presentar.
												</div>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-md-12">
											<div class="form-group">
												<label for="lblConsejoRegional">Consejo Regional *</label>
												<InputSelect @bind-Value="formData.ConsejoRegional" class="@($"form-control {(EsConsejoInvalido() && intentadoEnviar ? "is-invalid" : "")}")" id="cbxConsejoRegional" requiered>
													<option value="">Seleccione...</option>
													@foreach (var consejo in consejos)
													{
														<option value="@consejo.ConsejoRegional_Key">@consejo.Nombre</option>
													}
												</InputSelect>
												@if (EsConsejoInvalido() && intentadoEnviar)
												{
													<div class="invalid-feedback d-block">Seleccione Consejo Regional.</div>
												}
											</div>
										</div>
									</div>

									<div class="card">
										<h5 class="card-header card-title bg-morado ">Datos Personales</h5>
										<div class="card-body">
											<div class="row">
												<div class="col-md-4">
													<div class="form-group">
														<label for="td">Tipo de Documento *</label>
														<InputSelect TValue="string"
																	 Value="@formData.TipoDocumento"
																	 ValueChanged="@((string val) => OnTipoDocSeleccionado(val))"
																	 ValueExpression="@(() => formData.TipoDocumento)"
																	 class="@($"form-control {(string.IsNullOrWhiteSpace(formData.TipoDocumento) && intentadoEnviar ? "is-invalid" : "")}")">
															<option value="">Seleccione Tipo de Documento</option>
															@foreach (var td in tipodoc)
															{
																<option value="@td.MaestroRegistro_Key.ToString()">@td.Nombre</option>
															}
														</InputSelect>
														@if (string.IsNullOrWhiteSpace(formData.TipoDocumento) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Seleccione tipo de documento.</div>
														}
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="nd">Nro. documento *</label>
														<InputText @bind-Value="formData.NumeroDocumento" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.NumeroDocumento) && intentadoEnviar ? "is-invalid" : "")}")" id="nd" @onblur="OnNumeroDocumentoBlur" disabled="@consultandoReniec" />
														@if (string.IsNullOrWhiteSpace(formData.NumeroDocumento) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Ingrese n√∫mero de documento.</div>
														}
														@if (consultandoReniec)
														{
															<small class="text-muted"><span class="spinner-border spinner-border-sm" role="status"></span> Consultando RENIEC‚Ä¶</small>
														}
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="gs">Grupo Sanguineo *</label>
														<InputSelect @bind-Value="formData.GrupoSanguineo" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.GrupoSanguineo) && intentadoEnviar ? "is-invalid" : "")}")" id="gs">
															<option value="">Seleccione...</option>
															@foreach (var gs in gruposang)
															{
																<option value="@gs.MaestroRegistro_Key">@gs.Nombre</option>
															}
														</InputSelect>
														@if (string.IsNullOrWhiteSpace(formData.GrupoSanguineo) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Seleccione grupo sangu√≠neo.</div>
														}
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="nombres">Nombres Completos *</label>
														<InputText @bind-Value="formData.Nombres" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.Nombres) && intentadoEnviar ? "is-invalid" : "")}")" id="nombres" requiered />
														@if (string.IsNullOrWhiteSpace(formData.Nombres) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Ingrese nombres.</div>
														}
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="nombres">Apellido Paterno *</label>
														<InputText @bind-Value="formData.ApellidoPaterno" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.ApellidoPaterno) && intentadoEnviar ? "is-invalid" : "")}")" id="apaterno" requiered />
														@if (string.IsNullOrWhiteSpace(formData.ApellidoPaterno) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Ingrese apellido paterno.</div>
														}
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="nombres">Apellido Materno *</label>
														<InputText @bind-Value="formData.ApellidoMaterno" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.ApellidoMaterno) && intentadoEnviar ? "is-invalid" : "")}")" id="amaterno" requiered />
														@if (string.IsNullOrWhiteSpace(formData.ApellidoMaterno) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Ingrese apellido materno.</div>
														}
													</div>
												</div>

												<div class="col-md-6">
													<div class="form-group">
														<label for="sexo">Sexo *</label>
														<InputSelect @bind-Value="formData.Sexo" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.Sexo) && intentadoEnviar ? "is-invalid" : "")}")" id="sexo">
															<option value="">Seleccione...</option>
															<option value="1">Masculino</option>
															<option value="0">Femenino</option>
														</InputSelect>
														@if (string.IsNullOrWhiteSpace(formData.Sexo) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Seleccione sexo.</div>
														}
													</div>
												</div>
												<div class="col-md-6">
													<div class="form-group">
														<label for="ec">Estado Civil *</label>
														<InputSelect @bind-Value="formData.EstadoCivil" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.EstadoCivil) && intentadoEnviar ? "is-invalid" : "")}")" id="ec">
															<option value="">Seleccione...</option>
															@foreach (var ec in estacivil)
															{
																<option value="@ec.MaestroRegistro_Key">@ec.Nombre</option>
															}
														</InputSelect>
														@if (string.IsNullOrWhiteSpace(formData.EstadoCivil) && intentadoEnviar)
														{
															<div class="invalid-feedback d-block">Seleccione estado civil.</div>
														}
													</div>
												</div>

												@* Carnet de Extranjer√≠a: pedir PDF escaneado y mostrar ejemplo *@
												@if (tipoDocSeleccionado == "64")
												{
													<div class="col-12 mt-2">
														<div class="alert alert-info d-flex align-items-start mb-2" role="alert">
															<span class="me-2">‚ÑπÔ∏è</span>
															<div>
																<strong>Ejemplo de c√≥mo cargar el PDF:</strong> escaneado de ambas caras del carnet de extranjer√≠a.
															</div>
														</div>
														<div class="form-group">
															<label class="fw-bold">Carnet de Extranjer√≠a ‚Äì PDF escaneado *</label>
															<div class="input-group">
																<div class="custom-file" style="flex-grow: 1;">
																	<InputFile @bind-Value="formData.CarnetExtranjeriaPath" OnChange="@(async e => await OnFileSelected(e, nameof(formData.CarnetExtranjeriaPath)))" class="custom-file-input form-control" accept=".pdf" />
																	<label class="custom-file-label form-control">@(pdfCarnetExtranjeria != null ? pdfCarnetExtranjeria.Name : "Seleccione PDF (ambas caras del carnet)")</label>
																</div>
															</div>
														</div>
													</div>
												}
											</div>
										</div>
									</div>

									<div class="card mt-3">
										<h5 class="card-header card-title bg-morado">Datos de Universidad</h5>
										<div class="card-body">
											<div class="row">
												<div class="col-md-6">
													<div class="form-group">
														<label for="uniori">Origen de Universidad *</label>
														<InputSelect TValue="string"
																	 Value="@formData.UniversidadOrigen"
																	 ValueChanged="@((string val) => OnTipoSeleccionado(val))"
																	 ValueExpression="@(() => formData.UniversidadOrigen)"
																	 class="form-control">
															<option value="">Seleccione Universidad</option>
															<option value="1">Nacional</option>
															<option value="0">Extranjera</option>
														</InputSelect>
													</div>
												</div>

												<div class="col-md-6">
													<div class="form-group">
														<label for="pais_uni_paso1">Pa√≠s de universidad *</label>
														<select id="pais_uni_paso1"
																class="form-control"
																value="@formData.PaisUniversidad"
																disabled="@paisBloqueado"
																@onchange="@(async (ChangeEventArgs e) => await OnPaisSeleccionadoAsync(e.Value?.ToString() ?? ""))">
															<option value="">Seleccione pa√≠s</option>
															@foreach (var pais in paisesFiltrados)
															{
																<option value="@pais.Id.ToString()" selected="@(formData.PaisUniversidad == pais.Id.ToString())">
																	@pais.Nombre
																</option>
															}
														</select>
													</div>
												</div>

												@if (tipoSeleccionado == "1")
												{
													<div class="col-md-6">
														<div class="form-group">
															<label for="nombre_uni">Nombre de Universidad*</label>
															<InputSelect @bind-Value="formData.Universidad" class="form-control" id="nombre_uni">
																<option value="">Seleccione Universidad</option>
																@foreach (var uni in universidades)
																{
																	<option value="@uni.Id">@uni.Nombre</option>
																}
															</InputSelect>
														</div>
													</div>
												}
												else
												{
													<div class="col-md-6">
														<div class="form-group">
															<label for="nombre_uni_ext">Nombre de Universidad*</label>
															
															@if (cargandoUniversidadesExtranjeras)
															{
																<div class="form-control">
																	<span class="spinner-border spinner-border-sm me-2"></span>
																	Cargando universidades...
																</div>
															}
															else if (universidadesExtranjeras.Count > 0 && !mostrarCampoTextoUniversidadExtranjera)
															{
																<!-- Select2 con universidades de la API -->
																<select id="select_universidad_extranjera_paso1" 
																		class="form-control"
																		@onchange="@((ChangeEventArgs e) => { formData.NombreUniversidadExtranjera = e.Value?.ToString(); })">
																	<option value="">Seleccione o escriba para buscar...</option>
																	@foreach (var uni in universidadesExtranjeras)
																	{
																		<option value="@uni.name" selected="@(formData.NombreUniversidadExtranjera == uni.name)">@uni.name</option>
																	}
																</select>
																<div class="small text-muted mt-1">
																	<button type="button" class="btn btn-link btn-sm p-0" @onclick="CambiarATextoManualPaso1">
																		¬øNo encuentra su universidad? Haga clic aqu√≠ para escribirla manualmente
																	</button>
																</div>
															}
															else
															{
																<!-- Campo de texto manual -->
																<InputText @bind-Value="formData.NombreUniversidadExtranjera"
																		   class="form-control" 
																		   id="nombre_uni_ext_paso1"
																		   placeholder="Escriba el nombre de la universidad" />
																
																@if (universidadesExtranjeras.Count > 0 && mostrarCampoTextoUniversidadExtranjera)
																{
																	<div class="small text-muted mt-1">
																		<button type="button" class="btn btn-link btn-sm p-0" @onclick="VolverABusquedaAutomaticaPaso1">
																			Volver a la b√∫squeda autom√°tica
																		</button>
																	</div>
																}
															}
														</div>
													</div>
												}

												@if (tipoSeleccionado == "0" || tipoDocSeleccionado == "64")
												{
													<div class="col-md-6">
														<div class="form-group">
															<label for="tipo_validacion">Tipo de validaci√≥n *</label>
															<InputSelect TValue="string"
																		 Value="@formData.TipoValidacion"
																		 ValueChanged="@((string val) => OnTipoValidacionSeleccionado(val))"
																		 ValueExpression="@(() => formData.TipoValidacion)"
																		 class="@($"form-control {(esExtranjeroSinTipoValidacion && intentadoEnviar ? "is-invalid" : "")}")">
																<option value="">Seleccione Tipo de validaci√≥n</option>
																<option value="reconocimiento">Reconocimiento de Sunedu</option>
																<option value="revalidacion">Revalidaci√≥n</option>
															</InputSelect>
															@if (esExtranjeroSinTipoValidacion && intentadoEnviar)
															{
																<div class="invalid-feedback d-block">Seleccione Tipo de validaci√≥n.</div>
															}
														</div>
													</div>
													@if (tipoValidacionExtranjera == "reconocimiento")
													{
														<div class="col-md-6">
															<div class="form-group">
																<label>Resoluci√≥n de Reconocimiento Universidad Nacional *</label>
																<InputText @bind-Value="formData.NumeroResolucion" class="form-control" />
															</div>
														</div>
														<div class="col-md-6">
															<div class="form-group">
																<label>Fecha de reconocimiento *</label>
																<InputDate TValue="DateTime?" @bind-Value="formData.FechaReconocimiento" class="form-control" />
															</div>
														</div>
													}
													else if (tipoValidacionExtranjera == "revalidacion")
													{
														<div class="col-md-6">
															<div class="form-group">
																<label>Resoluci√≥n de Revalidaci√≥n Universidad Nacional *</label>
																<InputText @bind-Value="formData.NumeroResolucion" class="form-control" />
															</div>
														</div>
														<div class="col-md-6">
															<div class="form-group">
																<label>Universidad Peruana *</label>
																<InputSelect @bind-Value="formData.UniversidadPeruana" class="form-control">
																	<option value="">Seleccione universidad</option>
																	@foreach (var uniper in universidadesperuanas)
																	{
																		<option value="@uniper.Id">@uniper.Nombre</option>
																	}
																</InputSelect>
															</div>
														</div>
														<div class="col-md-6">
															<div class="form-group">
																<label>Fecha de revalidaci√≥n *</label>
																<InputDate TValue="DateTime?" @bind-Value="formData.FechaRevalidacion" class="form-control" />
															</div>
														</div>
													}
												}
											</div>
										</div>
									</div>

								<div class="d-flex justify-content-end mt-3 gap-2">
									@if (esCorreccionPorObservacion)
									{
										<!-- Solo mostrar bot√≥n para volver al paso 3 cuando est√° en correcci√≥n -->
										<button type="button" class="btn btn-primary btn-lg" @onclick="() => currentStep = 3">
											<i class="ri-arrow-right-line"></i>
											<span>Ir a Paso 3</span>
										</button>
									}
									else
									{
										<!-- Solo mostrar bot√≥n de registro cuando NO est√° en correcci√≥n -->
										<button type="button" class="btn btn-primary btn-lg btn-action" disabled="@isSavingInicial" @onclick="RegistrarInicialAsync">
											@if (isSavingInicial)
											{
												<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
												<span class="ms-2">Registrando...</span>
											}
											else
											{
												<i class="ri-save-3-line" aria-hidden="true"></i>
												<span>Registrar</span>
											}
										</button>
									}
								</div>
								</div>
							}

							@* PASO 2: Aula Virtual *@
							@if (currentStep == 2)
							{
								<div class="d-flex justify-content-start mb-3">
									<button type="button" class="btn btn-outline-primary" @onclick="VolverAPaso1">
										<i class="ri-arrow-left-line"></i> Volver a Paso 1
									</button>
								</div>
								<div class="alert alert-info d-flex align-items-start">
									<div class="me-2">üìò</div>
									<div>
										<div class="fw-bold">Estado de la solicitud: @(!string.IsNullOrWhiteSpace(estadoActual) ? estadoActual : "Pendiente de curso √âtica")</div>
										<div class="small text-muted">Complete el curso de √âtica en el Aula Virtual para continuar.</div>
										@if (!string.IsNullOrEmpty(avanceCursoDetalle))
										{
											<div class="mt-2 small">
												<strong>Avance actual:</strong> @avanceCursoDetalle
											</div>
										}
									</div>
								</div>
								<div class="d-flex gap-2">
									<button type="button" class="btn btn-primary" disabled="@abriendonAulaVirtual" @onclick="IrAlAulaVirtual">
										@if (abriendonAulaVirtual)
										{
											<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
											<span class="ms-2">Abriendo...</span>
										}
										else
										{
											<span>Ir al Aula Virtual</span>
										}
									</button>
									<button type="button" class="btn btn-outline-secondary" disabled="@verificandoCurso" @onclick="VerificarCursoEticaAsync">
										@if (verificandoCurso)
										{
											<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
											<span class="ms-2">Verificando...</span>
										}
										else
										{
											<span>Verificar avance</span>
										}
									</button>
									@* Bot√≥n fallback para desarrollo 
									@if (esAmbienteDesarrollo)
									{*@
										<button type="button" class="btn btn-warning" @onclick="SimularCursoCompletado">
											<i class="ri-test-tube-line"></i>
											<span>Simular Curso Completado (DEV)</span>
										</button>
									@*}*@
								</div>
							}

							@* PASO 3: Formulario completo y env√≠o *@
							@if (currentStep == 3)
							{
							<EditForm Model="@formData" OnValidSubmit="@HandleValidSubmit">
								<div class="d-flex justify-content-start mb-3">
									@if (cursoEticaCompletado)
									{
										<button type="button" class="btn btn-outline-primary" @onclick="() => currentStep = 2">
											<i class="ri-arrow-left-line"></i> Volver a Paso 2
										</button>
									}
									else
									{
										<button type="button" class="btn btn-outline-primary" @onclick="VolverAPaso1">
											<i class="ri-arrow-left-line"></i> Volver a Paso 1
										</button>
									}
								</div>
								<div class="card">
									<h5 class="card-header card-title bg-morado ">Resumen de Registro Inicial</h5>
									<div class="card-body">
										<div class="row">
											<div class="col-md-6 mb-2">
												<strong>Consejo Regional:</strong>
												<div>@GetConsejoNombre(formData.ConsejoRegional)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Tipo de Documento:</strong>
												<div>@GetMaestroNombre(tipodoc, formData.TipoDocumento)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Nro. Documento:</strong>
												<div>@(formData.NumeroDocumento)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Grupo Sangu√≠neo:</strong>
												<div>@GetMaestroNombre(gruposang, formData.GrupoSanguineo)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Nombres:</strong>
												<div>@(formData.Nombres)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Apellido Paterno:</strong>
												<div>@(formData.ApellidoPaterno)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Apellido Materno:</strong>
												<div>@(formData.ApellidoMaterno)</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Sexo:</strong>
												<div>@(formData.Sexo == "1" ? "Masculino" : formData.Sexo == "0" ? "Femenino" : "-")</div>
											</div>
											<div class="col-md-6 mb-2">
												<strong>Estado Civil:</strong>
												<div>@GetMaestroNombre(estacivil, formData.EstadoCivil)</div>
											</div>
										</div>
										@if (!string.IsNullOrWhiteSpace(perfilSeleccionado))
										{
											<div class="alert alert-info mt-3">
												<strong>Perfil seleccionado:</strong>
												<div>
													@perfilSeleccionadoTexto
												</div>
												@if (perfilSeleccionado == "1" || perfilSeleccionado == "2")
												{
													<div class="mt-2">
														‚Ä¢ La validaci√≥n se realizar√° con ID Per√∫ durante la Declaraci√≥n Jurada.<br />
														‚Ä¢ Aseg√∫rese de contar con su identidad verificada para continuar el tr√°mite.
													</div>
												}
												else if (perfilSeleccionado == "3" || perfilSeleccionado == "4")
												{
													<div class="mt-2">
														‚Ä¢ Debe adjuntar el PDF del t√≠tulo y certificado (paso 3).<br />
														‚Ä¢ Adem√°s, deber√° presentar los documentos f√≠sicos en mesa de partes.
													</div>
												}
											</div>
										}
										<div class="alert alert-info mt-2">
											Los datos anteriores provienen del registro inicial y no son editables en este paso.
										</div>
									</div>
								</div>
								<div class="card">
									<h5 class="card-header card-title bg-morado">Datos de nacimiento</h5>
									<div class="card-body">
										<div class="row">
											<div class="col-md-3">
												<div class="form-group">
													<label for="pais">Pa√≠s *</label>
													<InputSelect @bind-Value="formData.PaisNacimiento" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.PaisNacimiento) && intentadoEnviar ? "is-invalid" : "")}")" id="pais">
														<option value="">Seleccione Pais Nacimiento</option>
														@foreach (var pais in matpaises)
														{
															<option value="@pais.Pais_key" >
																@pais.Nombre
															</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.PaisNacimiento)" />
												</div>
											</div>
											<div class="col-md-3">
												<div class="form-group">
													<label for="departamentonac">Departamento *</label>
													<InputSelect TValue="string"
													 Value="@formData.DepartamentoNacimiento"
													 ValueChanged="@((string val) => OnLoadProvincias(val))"
													 ValueExpression="@(() => formData.DepartamentoNacimiento)"
													 class="@($"form-control {(string.IsNullOrWhiteSpace(formData.DepartamentoNacimiento) && intentadoEnviar ? "is-invalid" : "")}")">
														<option value="">Seleccione Departamento Nacimiento</option>
														@foreach (var depto in departamentos)
														{
															<option value="@depto.DepartamentoId">@depto.Nombre</option>
														}
													</InputSelect>

													<ValidationMessage For="@(() => formData.DepartamentoNacimiento)" />
												</div>
											</div>
											<div class="col-md-3">
												<div class="form-group">
													<label for="provincia">Provincia *</label>
													<InputSelect TValue="string"
																 Value="@formData.ProvinciaNacimiento"
																 ValueChanged="@((string prov) => OnLoadDistritos(prov))"
																 ValueExpression="@(() => formData.ProvinciaNacimiento)"
																 class="@($"form-control {(string.IsNullOrWhiteSpace(formData.ProvinciaNacimiento) && intentadoEnviar ? "is-invalid" : "")}")">
														<option value="">Seleccione Provincia Nacimiento</option>
														@foreach (var prov in provincias)
														{
															<option value="@prov.ProvinciaId">@prov.Nombre</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.ProvinciaNacimiento)" />
												</div>
											</div>
											<div class="col-md-3">
												<div class="form-group">
													<label for="distrito">Distrito *</label>
													<InputSelect @bind-Value="formData.DistritoNacimiento" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.DistritoNacimiento) && intentadoEnviar ? "is-invalid" : "")}")" id="distrito">
														<option value="">Seleccione Distrito Nacimiento</option>
														@foreach (var dist in distritos)
														{
															<option value="@dist.UbigeoId">@dist.Nombre</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.DistritoNacimiento)" />
												</div>
											</div>
											<div class="col-md-3">
												<div class="form-group">
													<label for="fnac">Fecha de Nacimiento *</label>
													<InputDate @bind-Value="formData.FechaNacimiento" class="form-control" id="fnac" max="@MaxFechaNacimiento.ToString("yyyy-MM-dd")" @onchange="@(() => ValidarFechaNacimiento())"  />
													<ValidationMessage For="@(() => formData.FechaNacimiento)" />
													@if (fechaInvalida)
													{
														<span class="text-danger">Debes tener al menos 18 a√±os.</span>
													}
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="card ">
									<h4 class="card-header card-title bg-morado">Datos de domicilio</h4>
									<div class="card-body">
										<div class="row">
											<div class="col-md-6">
												<div class="form-group">
													<label for="zona">Zona *</label>
													<InputSelect @bind-Value="formData.ZonaDomicilio" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.ZonaDomicilio) && intentadoEnviar ? "is-invalid" : "")}")" id="zona">
														<option value="">Seleccione Zona Domicilio</option>
														@foreach (var zona in zonas)
														{
															<option value="@zona.MaestroRegistro_Key">@zona.Nombre</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.ZonaDomicilio)" />
												</div>
											</div>
											<div class="col-md-6">
												<div class="form-group">
													<label for="domicilio1">Descripci√≥n Zona *</label>
													<InputText @bind-Value="formData.DescripcionZona" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.DescripcionZona) && intentadoEnviar ? "is-invalid" : "")}")" id="domicilio1" />
													<ValidationMessage For="@(() => formData.DescripcionZona)" />
												</div>
											</div>
											<div class="col-md-6">
												<div class="form-group">
													<label for="via">V√≠a *</label>
													<InputSelect @bind-Value="formData.ViaDomicilio" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.ViaDomicilio) && intentadoEnviar ? "is-invalid" : "")}")" id="via">
														<option value="">Seleccione Via Domicilio</option>
														@foreach (var via in vias)
														{
															<option value="@via.MaestroRegistro_Key">@via.Nombre</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.ViaDomicilio)" />
												</div>
											</div>
											<div class="col-md-6">
												<div class="form-group">
													<label for="domicilio1">Descripci√≥n V√≠a *</label>
													<InputText @bind-Value="formData.DescripcionVia" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.DescripcionVia) && intentadoEnviar ? "is-invalid" : "")}")" id="domicilio2" />
													<ValidationMessage For="@(() => formData.DescripcionVia)" />
												</div>
											</div>
											<div class="col-md-4">
												<div class="form-group">
													<label for="departamento_id">Departamento  *</label>
													<InputSelect TValue="string"
																 Value="@formData.DepartamentoDomicilio"
																 ValueChanged="@((string val) => OnLoadProvinciasdm(val))"
																 ValueExpression="@(() => formData.DepartamentoDomicilio)"
																 class="@($"form-control {(string.IsNullOrWhiteSpace(formData.DepartamentoDomicilio) && intentadoEnviar ? "is-invalid" : "")}")">
														<option value="">Seleccione Departamento Domicilio</option>
														@foreach (var deptodm in departamentosdm)
														{
															<option value="@deptodm.DepartamentoId">@deptodm.Nombre</option>
														}
													</InputSelect>

													<ValidationMessage For="@(() => formData.DepartamentoDomicilio)" />
													
												</div>
											</div>
											<div class="col-md-4">
												<div class="form-group">
													<label for="provincia_id">Provincia *</label>
													<InputSelect TValue="string"
																 Value="@formData.ProvinciaDomicilio"
																 ValueChanged="@((string prov) => OnLoadDistritosdm(prov))"
																 ValueExpression="@(() => formData.ProvinciaDomicilio)"
																 class="@($"form-control {(string.IsNullOrWhiteSpace(formData.ProvinciaDomicilio) && intentadoEnviar ? "is-invalid" : "")}")">
														<option value="">Seleccione Provincia Domicilio</option>
														@foreach (var provdm in provinciasdm)
														{
															<option value="@provdm.ProvinciaId">@provdm.Nombre</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.ProvinciaDomicilio)" />
												</div>
											</div>
											<div class="col-md-4">
												<div class="form-group">
													<label for="distrito_id">Distrito *</label>
													<InputSelect @bind-Value="formData.DistritoDomicilio" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.DistritoDomicilio) && intentadoEnviar ? "is-invalid" : "")}")" id="distrito">
														<option value="">Seleccione Distrito Domicilio</option>
														@foreach (var distdn in distritosdm)
														{
															<option value="@distdn.UbigeoId">@distdn.Nombre</option>
														}
													</InputSelect>
													<ValidationMessage For="@(() => formData.DistritoDomicilio)" />
												</div>
											</div>
											<div class="col-md-4">
												<div class="form-group">
													<label for="telefono">Tel√©fono fijo</label>
													<InputText @bind-Value="formData.Telefono" class="form-control" id="telefono" />
													<ValidationMessage For="@(() => formData.Telefono)" />
												</div>
											</div>
											<div class="col-md-4">
												<div class="form-group">
													<label for="celular">Tel√©fono celular *</label>
													<InputText @bind-Value="formData.Celular" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.Celular) && intentadoEnviar ? "is-invalid" : "")}")" id="celular" />
													<ValidationMessage For="@(() => formData.Celular)" />
												</div>
											</div>
											<div class="col-md-4">
												<div class="form-group">
													<label for="email">Correo *</label>
													<InputText @bind-Value="formData.Email" class="@($"form-control {(string.IsNullOrWhiteSpace(formData.Email) && intentadoEnviar ? "is-invalid" : "")}")" id="email" />
													<ValidationMessage For="@(() => formData.Email)" />
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="card">
									<h5 class="card-header card-title bg-morado">Documentos a adjuntar</h5>
									<div class="card-body">
										<p class="text-muted small mb-3">Los datos de universidad (origen, pa√≠s, nombre, tipo de validaci√≥n, etc.) se completaron en el Paso 1. Debe indicar la fecha de titulaci√≥n a continuaci√≥n.</p>
										<div class="row mb-3">
											<div class="col-md-6">
												<div class="form-group">
													<label for="fegreso_paso3">Fecha de titulaci√≥n *</label>
													<InputDate @bind-Value="formData.FechaEmisionTitulo" class="@($"form-control {(formData.FechaEmisionTitulo == default(DateTime) && intentadoEnviar ? "is-invalid" : "")}")" id="fegreso_paso3" />
													@if (formData.FechaEmisionTitulo == default(DateTime) && intentadoEnviar)
													{
														<div class="invalid-feedback d-block">Seleccione la fecha de titulaci√≥n.</div>
													}
												</div>
											</div>
										</div>
										<div class="row">
											@* Para los nacionales y extranjeros*@
											<div class="col-md-6">
												<div class="form-group">
													<h4 class="card-title">Titulo Medico Cirujano (escaneado por ambas caras)</h4>
													<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
														<span class="text-muted small">@TextoArchivo("TituloMedicoCirujano", pdfTituloMedicoCirujano, "Titulo Medico Cirujano")</span>
														<InputFile Id="file_titulo" @bind-Value="formData.TituloMedicoCirujanoPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.TituloMedicoCirujanoPath)))" accept=".pdf" />
														<label class="btn btn-outline-secondary btn-sm mb-0" for="file_titulo">Examinar</label>
													</div>
												</div>
											</div>
											@* <div class="col-md-6">
												<div class="form-group">
													<h4 class="card-title">Constancia Inscripcion Sunedu</h4>
													<div class="custom-file">
														<div class="input-group">
															<div class="custom-file" style="flex-grow: 1;">
																<InputFile @bind-Value="formData.ConstanciaInscripcionSuneduPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.ConstanciaInscripcionSuneduPath)))" class="custom-file-input form-control" accept=".pdf" />
																<label class="custom-file-label form-control" for="customFile">@(pdfConstanciaInscripcionSunedu != null ? pdfConstanciaInscripcionSunedu.Name : "Seleccione Constancia Inscripcion Sunedu")</label>
															</div>
														</div>
													</div>
												</div>
											</div> *@
											@if (tipoSeleccionado == "1")
											{
												<div class="col-md-6">
													<div class="form-group">
														<h4 class="card-title">Certificado Antecedentes Penales o Certificado √önico Laboral </h4>
														<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
															<span class="text-muted small">@TextoArchivo("CertificadoAntecedentesPenales", pdfCertificadoAntecedentesPenales, "Certificado Antecedentes Penales")</span>
															<InputFile Id="file_cert" @bind-Value="formData.CertificadoAntecedentesPenalesPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.CertificadoAntecedentesPenalesPath)))" accept=".pdf" />
															<label class="btn btn-outline-secondary btn-sm mb-0" for="file_cert">Examinar</label>
														</div>
													</div>
												</div>
											}
											else if(tipoSeleccionado == "0")
											{
												<div class="col-md-6">
													<div class="form-group">
														<h4 class="card-title">Antecedentes de Pais de origen O INTERPOL</h4>
														<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
															<span class="text-muted small">@TextoArchivo("CertificadoAntecedentesPenales", pdfCertificadoAntecedentesPenales, "Antecedentes de Pais de origen O INTERPOL")</span>
															<InputFile Id="file_dj" @bind-Value="formData.CertificadoAntecedentesPenalesPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.CertificadoAntecedentesPenalesPath)))" accept=".pdf" />
															<label class="btn btn-outline-secondary btn-sm mb-0" for="file_dj">Examinar</label>
														</div>
													</div>
												</div>
											}

											@* Solo para extranjeros (Carnet se sube en Paso 1 cuando tipo doc = Carnet) *@
											@if (tipoSeleccionado == "0")
											{
												@if (tipoValidacionExtranjera == "reconocimiento")
												{
													<div class="col-md-6">
														<div class="form-group">
															<h4 class="card-title">Constancia Inscripcion Reconocimiento Sunedu</h4>
															<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
																<span class="text-muted small">@TextoArchivo("ConstanciaInscripcionReconocimientoSunedu", pdfConstanciaInscripcionReconocimientoSunedu, "Constancia Inscripcion Reconocimiento Sunedu")</span>
																<InputFile Id="file_const_recon" @bind-Value="formData.ConstanciaInscripcionReconocimientoSuneduPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.ConstanciaInscripcionReconocimientoSuneduPath)))" accept=".pdf" />
																<label class="btn btn-outline-secondary btn-sm mb-0" for="file_const_recon">Examinar</label>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<h4 class="card-title">Reconocimiento Sunedu - PDF</h4>
															<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
																<span class="text-muted small">@TextoArchivo("ReconocimientoSunedu", pdfReconocimientoSunedu, "Reconocimiento Sunedu")</span>
																<InputFile Id="file_recon" @bind-Value="formData.ReconocimientoSuneduPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.ReconocimientoSuneduPath)))" accept=".pdf" />
																<label class="btn btn-outline-secondary btn-sm mb-0" for="file_recon">Examinar</label>
															</div>
														</div>
													</div>
												}
												else if (tipoValidacionExtranjera == "revalidacion")
												{
													<div class="col-md-6">
														<div class="form-group">
															<h4 class="card-title">Constancia Inscripcion Revalidacion Universidad Nacional</h4>
															<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
																<span class="text-muted small">@TextoArchivo("ConstanciaInscripcionRevalidacionUniversidadNacional", pdfConstanciaInscripcionRevalidacionUniversidadNacional, "Constancia Inscripcion Revalidacion Universidad Nacional")</span>
																<InputFile Id="file_const_rev" @bind-Value="formData.ConstanciaInscripcionRevalidacionUniversidadNacionalPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.ConstanciaInscripcionRevalidacionUniversidadNacionalPath)))" accept=".pdf" />
																<label class="btn btn-outline-secondary btn-sm mb-0" for="file_const_rev">Examinar</label>
															</div>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<h4 class="card-title">Revalidacion Universidad Nacional - PDF</h4>
															<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
																<span class="text-muted small">@TextoArchivo("RevalidacionUniversidadNacional", pdfRevalidacionUniversidadNacional, "Revalidacion Universidad Nacional")</span>
																<InputFile Id="file_rev" @bind-Value="formData.RevalidacionUniversidadNacionalPath" OnChange="@(async args => await OnFileSelected(args, nameof(formData.RevalidacionUniversidadNacionalPath)))" accept=".pdf" />
																<label class="btn btn-outline-secondary btn-sm mb-0" for="file_rev">Examinar</label>
															</div>
														</div>
													</div>
												}
											}
										</div>
									</div>
								</div>
								<div class="card">
									<h5 class="card-header card-title bg-morado bg-morado">Foto a Adjuntar</h5>
									<div class="card-body">
										<div class="row">
											<div class="col-md-12">
												<div class="form-group">
													<h4 class="card-title " >Adjuntar Foto</h4>
													<div class="prema-file-wrap d-flex align-items-center gap-2 flex-wrap">
														<span class="text-muted small">@TextoFoto()</span>
														<InputFile Id="file_foto" OnChange="@OnFotoSelected" @bind-Value="formData.FotoMedico" accept=".jpg,.jpeg,.png" />
														<label class="btn btn-outline-secondary btn-sm mb-0" for="file_foto">Examinar</label>
														<button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => mostrarEjemplos = true">
															<i class="fas fa-question-circle"></i>
															<span class="d-none d-sm-inline"> Ver ejemplos</span>
														</button>
													</div>
														@if (mostrarEjemplos)
														{
															<div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5)" id="exampleModal">
																<div class="modal-dialog modal-lg">
																	<div class="modal-content">
																		<div class="modal-header">
																			<h5 class="modal-title">Ejemplos de fotos v√°lidas</h5>
																			<button type="button" class="btn-close" @onclick="() => mostrarEjemplos = false"></button>
																		</div>
																		<div class="modal-body">
																			<div class="row">
																				<div class="col-md-6">
																					<h6>Ejemplo para caballeros</h6>
																					<img src="@GetImageUrl("hombre_formal.jpg")" class="img-fluid border" alt="Ejemplo hombre formal" style="height:350px" />
																				</div>
																				<div class="col-md-6">
																					<h6>Ejemplo para damas</h6>
																					<img src="@GetImageUrl("mujer_formal.jpg")" class="img-fluid border" alt="Ejemplo mujer formal" style="height:350px" />
																				</div>
																			</div>
																			<div class="mt-3 alert alert-info">
																				<h6>Requisitos:</h6>
																				<ul>
																					<li>Fondo blanco o claro uniforme</li>
																					<li>Rostro completamente visible</li>
																					<li>Postura frontal</li>
																					<li>Vestimenta formal (caballeros: terno y corbata; damas: blusa/vestido formal)</li>
																				</ul>
																			</div>
																		</div>
																		<div class="modal-footer">
																			<button type="button" class="btn btn-secondary" @onclick="() => mostrarEjemplos = false">Cerrar</button>
																		</div>
																	</div>
																</div>
															</div>
														}
														<!-- Vista previa de la imagen -->
														@if (fotoFile != null && imagePreviewUrl != null)
														{
															<div class="mt-3">
																<img src="@imagePreviewUrl" class="img-thumbnail" style="max-width: 200px; max-height: 200px;" alt="Vista previa de la imagen seleccionada" />
															</div>
														}

														<!-- Mensajes de estado -->
														<div class="mt-2">
															@if (estaValidando)
															{
																<div class="spinner-border text-primary" role="status">
																	<span class="visually-hidden">Cargando...</span>
																</div>
																<span class="ms-2">@mensajeValidacion</span>
															}
															else if (mostrarErrorFoto)
															{
																<div class="text-danger">@mensajeValidacion</div>
															}
															else if (!string.IsNullOrEmpty(mensajeValidacion))
															{
																<div class="text-success">@mensajeValidacion</div>
															}
														</div>
														<ValidationMessage For="@(() => formData.FotoMedico)" />
													<div class="alert alert-warning mb-4 mt-2" role="alert">
														<ul>
															<li>
																Adjuntar foto tama√±o pasaporte a color en fondo blanco <em>(caballeros: terno y corbata; damas: con blusa de vestir) </em> *
															</li>
															<li>
																Debe de ser un solo archivo en formato <strong>JPG</strong> y deber√° pesar hasta <strong>@maxFileSizeMBFormatted MB</strong>
															</li>
														</ul>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							<div class="row">
								<div class="col-md-12">
									<div class="form-group">
										@if (!esCorreccionPorObservacion)
										{
											<div class="custom-control custom-switch mb-2" dir="ltr">
												<input type="checkbox" class="custom-control-input" id="customSwitch1" 
													   checked="@formData.AceptaPoliticas" 
													   disabled="@tienePoliticasAceptadasEnServidor"
													   @onchange="OnTogglePoliticas" />
												<label class="custom-control-label" for="customSwitch1">
													Acepto las <a href="javascript:void(0);" @onclick="AbrirPoliticasModal">Pol√≠ticas de Privacidad</a> de este sitio
												</label>
												@if (tienePoliticasAceptadasEnServidor)
												{
													<span class="badge bg-success ms-2"><i class="ri-check-line"></i> Aceptadas</span>
												}
												<ValidationMessage For="@(() => formData.AceptaPoliticas)" />
											</div>
											<div class="custom-control custom-switch mt-2" dir="ltr">
												<input id="acepta_ddjj" type="checkbox" class="custom-control-input @( !ddjjValida && intentadoEnviar ? "invalid" : "")" checked="@aceptaDDJJ" @onchange="OnToggleDDJJ" disabled="@ddjjFirmada" />
												<label class="custom-control-label" style="cursor:pointer;" @onclick="OnLabelDDJJClick">
													Declaro bajo juramento (DDJJ) que la informaci√≥n proporcionada es veraz y completa.
												</label>
											</div>
											@if (tieneDDJJFirmadaEnServidor)
											{
												<div class="alert alert-success mt-2 d-flex align-items-center justify-content-between">
													<div>
														<i class="ri-shield-check-fill text-success me-2"></i>
														<strong>DDJJ validada con ID PER√ö</strong>
														@if (fechaFirmaDDJJ.HasValue)
														{
															<span class="ms-2 text-muted">(@fechaFirmaDDJJ.Value.ToString("dd/MM/yyyy HH:mm"))</span>
														}
													</div>
													<button type="button" class="btn btn-sm btn-outline-success" @onclick="DescargarDDJJFirmada">
														<i class="ri-download-line me-1"></i> Descargar PDF
													</button>
												</div>
											}
											@if (!ddjjValida && intentadoEnviar)
											{
												<div class="text-danger mt-1">Debe aceptar la DDJJ para continuar.</div>
											}
										}
										else
										{
											<div class="alert alert-info">
												<i class="ri-information-line me-1"></i>
												<strong>Modo de correcci√≥n:</strong> Actualice los datos observados y presione "Actualizar Solicitud".
											</div>
										}
									</div>
								</div>
							</div>
								<DataAnnotationsValidator />
								<ValidationSummary />
								<!-- Mostrar mensajes de error -->
								@if (!string.IsNullOrEmpty(mensajeError))
								{
									<div class="alert alert-danger">@mensajeError</div>
								}
								<button type="submit"  class="btn btn-primary bg btn-lg btn-block waves-effect waves-light mb-1">
									@if (enviando)
									{
										<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
										<span> Procesando...</span>
									}
									else
									{
										if (SolicitudId > 0)
										{
											@if (tieneDDJJFirmadaEnServidor && _fileBuffers.Count == 0 && fotoFile == null && (_fotoBuffer == null || _fotoBuffer.Length == 0))
											{
												<span>Continuar al Pago</span>
											}
											else
											{
												<span>Actualizar Solicitud</span>
											}
										}
										else
										{
											<span>Enviar Solicitud</span>
										}
										<i class="ri-arrow-right-line align-middle ml-2"></i>
									}
								</button>
								

							</EditForm>
							}
							@if (mostrarPoliticasModal)
							{
								<div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5)">
									<div class="modal-dialog modal-lg">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="card-header card-title bg-morado bg-morado">Pol√≠ticas de Privacidad y T√©rminos</h5>
												<button type="button" class="btn-close" @onclick="() => mostrarPoliticasModal = false"></button>
											</div>
											<div class="modal-body">
												<p class="mb-2"><strong>Ejemplo (personalizar):</strong></p>
												<p>
													Autorizo al Colegio M√©dico del Per√∫ a tratar mis datos personales conforme a la Ley N¬∞ 29733 y su Reglamento.
													Declaro haber le√≠do y aceptado la Pol√≠tica de Privacidad y los T√©rminos y Condiciones del servicio.
												</p>
												<ul>
													<li>Finalidad: gestionar el proceso de matr√≠cula y servicios relacionados.</li>
													<li>Plazo de conservaci√≥n: seg√∫n normativa aplicable.</li>
													<li>Derechos ARCO: podr√° ejercerlos a trav√©s de los canales oficiales del CMP.</li>
												</ul>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary" @onclick="() => mostrarPoliticasModal = false">Cerrar</button>
											</div>
										</div>
									</div>
								</div>
							}

							@* Modal DDJJ *@
							@if (mostrarDDJJModal)
							{
								<div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5)">
									<div class="modal-dialog modal-xl">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="card-header card-title bg-morado bg-morado">Declaraci√≥n Jurada (DDJJ)</h5>
												<button type="button" class="btn-close" @onclick="CancelarFirmaDDJJ"></button>
											</div>
											<div class="modal-body">
												<div class="mb-3">
													<object data="@ddjjPdfUrl" type="application/pdf" style="width:100%;height:70vh;">
														<p>Tu navegador no puede mostrar el PDF. <a href="@ddjjPdfUrl" target="_blank">Descargar DDJJ</a></p>
													</object>
												</div>
												<div class="d-flex justify-content-between align-items-center">
													<small class="text-muted">Versi√≥n: @ddjjVersion</small>
													<div class="d-flex gap-2">
														<button type="button" class="btn btn-outline-primary" @onclick="DescargarDDJJ">
															<i class="ri-download-line"></i> Descargar
														</button>
														<button type="button" class="btn btn-success" disabled="@ddjjFirmaEnProceso" @onclick="IniciarFirmaIdPeru">
															@if (ddjjFirmaEnProceso)
															{
																<div class= "spinner-border text-primary spinner-border-sm" role = "status" >
																	<span class= "visually-hidden" > Firmando...</span >
																</div >
																<span class="ms-2">Firmando...</span>
															}
															else
															{
																<i class="ri-shield-check-line"></i>
																<span>Firmar con ID Per√∫</span>
															}
														</button>
														@* Bot√≥n de simulaci√≥n solo en desarrollo 
														@if (esAmbienteDesarrollo)
														{*@
															<button type="button" class="btn btn-warning" disabled="@ddjjFirmaEnProceso" @onclick="SimularFirmaIdPeru">
																<i class="ri-test-tube-line"></i>
																<span>Simular ID Per√∫ (DEV)</span>
															</button>
														@*}*@
													</div>
												</div>
											</div>
											<div class="modal-footer">
												<button type="button" class="btn btn-secondary" @onclick="CancelarFirmaDDJJ">Cerrar</button>
											</div>
										</div>
									</div>
								</div>
							}

							@* PASO 4: Pago *@
							@if (currentStep == 4)
							{
								<div class="d-flex justify-content-start mb-3">
									<button type="button" class="btn btn-outline-primary" @onclick="() => currentStep = 3">
										<i class="ri-arrow-left-line"></i> Volver a Paso 3
									</button>
								</div>
								<div class="alert alert-info d-flex align-items-start">
									<div class="me-2">üí≥</div>
									<div>
										<div class="fw-bold">Estado del pago: @(!pagoCompletado ? "Pendiente" : "Completado")</div>
										<div class="small text-muted">Complete el pago de la matr√≠cula para continuar con el proceso.</div>
										@if (pagoCompletado && !string.IsNullOrEmpty(comprobantePago))
										{
											<div class="mt-2 small">
												<strong>Comprobante:</strong> @comprobantePago
											</div>
										}
									</div>
								</div>
								<div class="d-flex gap-2">
									<button type="button" class="btn btn-primary" disabled="@abriendoPasarela" @onclick="AbrirPasarelaPago">
										@if (abriendoPasarela)
										{
											<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
											<span class="ms-2">Abriendo...</span>
										}
										else
										{
											<span>Entrar Pasarela</span>
										}
									</button>
									<button type="button" class="btn btn-outline-secondary" disabled="@verificandoPago" @onclick="VerificarPagoAsync">
										@if (verificandoPago)
										{
											<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
											<span class="ms-2">Verificando...</span>
										}
										else
										{
											<span>Verificar Pago</span>
										}
									</button>
									<button type="button" class="btn btn-outline-warning" disabled="@(simulandoPagoDev || pagoCompletado)" title="Solo desarrollo: marca pago como verificado, actualiza a Registrado y env√≠a correo" @onclick="SimularPagoDesarrolloAsync">
										@if (simulandoPagoDev)
										{
											<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
											<span class="ms-2">Procesando...</span>
										}
										else
										{
											<span>Simular pago (DEV)</span>
										}
									</button>
								</div>
								@if (pagoCompletado)
								{
									<div class="mt-3">
										<button type="button" class="btn btn-success btn-lg" @onclick="() => currentStep = 5">
											<i class="ri-arrow-right-line"></i>
											<span>Continuar a Paso 5</span>
										</button>
									</div>
								}
							}

							@* PASO 5: Resumen final - Solicitud enviada *@
							@if (currentStep == 5)
							{
								<div class="d-flex justify-content-start mb-3">
									@if (pagoCompletado)
									{
										<button type="button" class="btn btn-outline-primary" @onclick="() => currentStep = 4">
											<i class="ri-arrow-left-line"></i> Volver a Paso 4
										</button>
									}
								</div>
								<div class="alert alert-success d-flex align-items-start mb-4">
									<div class="me-2">‚úÖ</div>
									<div>
										<div class="fw-bold">¬°Solicitud enviada correctamente!</div>
										<div class="small">Su solicitud ha sido enviada y est√° en revisi√≥n por la oficina de matr√≠cula.</div>
									</div>
								</div>

								<div class="card mb-3">
									<h5 class="card-header card-title bg-morado">Resumen de su Solicitud</h5>
									<div class="card-body">
										<div class="row">
											<div class="col-md-12 mb-3">
												<div class="alert alert-info">
													<strong>Estado actual:</strong> @(!string.IsNullOrWhiteSpace(estadoActual) ? estadoActual : "En revisi√≥n")<br />
													<strong>ID de Solicitud:</strong> @SolicitudId
												</div>
											</div>
										</div>

										<h6 class="fw-bold text-primary">Perfil Seleccionado</h6>
										<div class="row mb-3">
											<div class="col-md-12">
												<div>@perfilSeleccionadoTexto</div>
											</div>
										</div>

										<h6 class="fw-bold text-primary">Consejo Regional</h6>
										<div class="row mb-3">
											<div class="col-md-6">
												<strong>Consejo:</strong> @GetConsejoNombre(formData.ConsejoRegional)
											</div>
										</div>

										<h6 class="fw-bold text-primary">Datos Personales</h6>
										<div class="row mb-3">
											<div class="col-md-4 mb-2">
												<strong>Tipo de Documento:</strong><br />
												@GetMaestroNombre(tipodoc, formData.TipoDocumento)
											</div>
											<div class="col-md-4 mb-2">
												<strong>Nro. Documento:</strong><br />
												@(formData.NumeroDocumento)
											</div>
											<div class="col-md-4 mb-2">
												<strong>Grupo Sangu√≠neo:</strong><br />
												@GetMaestroNombre(gruposang, formData.GrupoSanguineo)
											</div>
											<div class="col-md-4 mb-2">
												<strong>Nombres:</strong><br />
												@(formData.Nombres)
											</div>
											<div class="col-md-4 mb-2">
												<strong>Apellido Paterno:</strong><br />
												@(formData.ApellidoPaterno)
											</div>
											<div class="col-md-4 mb-2">
												<strong>Apellido Materno:</strong><br />
												@(formData.ApellidoMaterno)
											</div>
											<div class="col-md-4 mb-2">
												<strong>Sexo:</strong><br />
												@(formData.Sexo == "1" ? "Masculino" : formData.Sexo == "0" ? "Femenino" : "-")
											</div>
											<div class="col-md-4 mb-2">
												<strong>Estado Civil:</strong><br />
												@GetMaestroNombre(estacivil, formData.EstadoCivil)
											</div>
										</div>

										<h6 class="fw-bold text-primary">Datos de Universidad</h6>
										<div class="row mb-3">
											<div class="col-md-6 mb-2">
												<strong>Origen:</strong><br />
												@(formData.UniversidadOrigen == "1" ? "Nacional" : "Extranjera")
											</div>
											<div class="col-md-6 mb-2">
												<strong>Fecha de Emisi√≥n del T√≠tulo:</strong><br />
												@(formData.FechaEmisionTitulo != default(DateTime) ? formData.FechaEmisionTitulo.ToString("dd/MM/yyyy") : "-")
											</div>
										</div>

										<div class="alert alert-warning mt-4">
											<h6><strong>Pr√≥ximos pasos:</strong></h6>
											<ul class="mb-0">
												<li>La oficina de matr√≠cula revisar√° su solicitud.</li>
												<li>Recibir√° notificaciones sobre el estado de su solicitud.</li>
												<li>Puede consultar el seguimiento en la secci√≥n "Seguimiento de tr√°mite".</li>
												@if (perfilSeleccionado == "3" || perfilSeleccionado == "4")
												{
													<li><strong>Recuerde:</strong> Debe presentar los documentos f√≠sicos en mesa de partes.</li>
												}
											</ul>
										</div>
									</div>
								</div>

								<div class="d-flex justify-content-between mt-3">
									<button type="button" class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/solicitudes/seguimiento", forceLoad: true)'>
										<i class="ri-list-check" aria-hidden="true"></i>
										<span>Ver seguimiento</span>
									</button>
									<button type="button" class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/home", forceLoad: true)'>
										<i class="ri-home-line" aria-hidden="true"></i>
										<span>Volver al inicio</span>
									</button>
								</div>
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
</div>

@code {
    private class ReniecResultDto
    {
        public string? Nombres { get; set; }
        public string? ApellidoPaterno { get; set; }
        public string? ApellidoMaterno { get; set; }
        public DateTime? FechaNacimiento { get; set; }
        public string? Sexo { get; set; }
        public string? EstadoCivil { get; set; }
        public string? Fuente { get; set; }
    }

	private class UniversidadExtranjera
	{
		public string name { get; set; } = string.Empty;
		public string country { get; set; } = string.Empty;
		public List<string> web_pages { get; set; } = new();
		public string alpha_two_code { get; set; } = string.Empty;
		public List<string> domains { get; set; } = new();
	}

	// Control de pasos y Aula Virtual
	private int currentStep = 1;
	private bool cursoEticaCompletado = false;
	private bool verificandoCurso = false;
	private bool isSavingInicial = false;
	private bool abriendonAulaVirtual = false;
	private string perfilSeleccionado = string.Empty;
	private string avanceCursoDetalle = string.Empty;
	private string tokenAulaVirtual = string.Empty;
	private bool esAmbienteDesarrollo = false;

	// Control de pago
	private bool pagoCompletado = false;
	private bool verificandoPago = false;
	private bool abriendoPasarela = false;
	private bool simulandoPagoDev = false;
	private string comprobantePago = string.Empty;

	private class EstadoCursoResponse
	{
		public bool Completado { get; set; }
		public string? Estado { get; set; }
		public int? PorcentajeAvance { get; set; }
	}

	private class AulaVirtualLoginRequest
	{
		public string SecreyKey { get; set; } = string.Empty;
		public string numeroDocumento { get; set; } = string.Empty;
		public string email { get; set; } = string.Empty;
	}

	private class AulaVirtualLoginResponse
	{
		public bool success { get; set; }
		public string? token { get; set; }
		public string? mensaje { get; set; }
		public string? urlAulaVirtual { get; set; }
	}

	private class VerificarAvanceRequest
	{
		public string token { get; set; } = string.Empty;
		public string codigoCurso { get; set; } = string.Empty;
	}

	private class VerificarAvanceResponse
	{
		public bool success { get; set; }
		public string? estado { get; set; } // EN curso, Aprobado, desaprobado
		public int? porcentajeAvance { get; set; }
		public string? mensaje { get; set; }
	}

	private class PasarelaPagoResponse
	{
		public bool success { get; set; }
		public string? url { get; set; }
		public Dictionary<string, string>? postParams { get; set; }
		public string? mensaje { get; set; }
	}

	private class VerificarPagoResponse
	{
		public bool pagado { get; set; }
		public string? comprobante { get; set; }
		public string? mensaje { get; set; }
	}

	private class GuardarResponse
	{
		public bool Success { get; set; }
		public string? Message { get; set; }
		public int? Id { get; set; }
		public int? SolicitudId { get; set; }
	}

    private static bool NombreEsPeru(string? nombre)
    {
        if (string.IsNullOrWhiteSpace(nombre)) return false;
        var lower = nombre.ToLowerInvariant();
        return lower.Contains("peru") || lower.Contains("per√∫");
    }
	[Parameter]
	public int SolicitudId { get; set; }

	string tipoSeleccionado = "1"; // Nacional por defecto
	string tipoDocSeleccionado = "62"; // DNI por defecto
	int paisId;
	bool paisBloqueado = true;
	string tipoValidacionExtranjera = "";
	private string perfilSeleccionadoTexto => perfilSeleccionado switch
	{
		"1" => "1. Profesional peruano con t√≠tulo de universidad peruana",
		"2" => "2. Profesional peruano con t√≠tulo de universidad extranjera",
		"3" => "3. Profesional extranjero con t√≠tulo otorgado en el Per√∫",
		"4" => "4. Profesional extranjero con t√≠tulo otorgado en el extranjero",
		_ => "-"
	};

	private bool esExtranjeroSinTipoValidacion => (tipoSeleccionado == "0" || tipoDocSeleccionado == "64") && string.IsNullOrWhiteSpace(formData?.TipoValidacion);

	/// <summary>Infiere perfil desde TipoDocumento + UniversidadOrigen cuando al volver a Paso 1 no est√° seleccionado.</summary>
	private void SyncPerfilFromForm()
	{
		if (!string.IsNullOrWhiteSpace(perfilSeleccionado)) return;
		var td = formData?.TipoDocumento ?? "";
		var uo = formData?.UniversidadOrigen ?? "";
		if (string.IsNullOrWhiteSpace(td) || string.IsNullOrWhiteSpace(uo)) return;
		// 62+1‚Üí1, 62+0‚Üí2, 64+1‚Üí3, 64+0‚Üí4
		if (td == "62" && uo == "1") perfilSeleccionado = "1";
		else if (td == "62" && uo == "0") perfilSeleccionado = "2";
		else if (td == "64" && uo == "1") perfilSeleccionado = "3";
		else if (td == "64" && uo == "0") perfilSeleccionado = "4";
		StateHasChanged();
	}

	private void VolverAPaso1()
	{
		currentStep = 1;
		SyncPerfilFromForm();
	}

	List<Pais> paises = new();
	List<Pais> paisesFiltrados = new();
	List<Universidad> universidades = new();
	List<Universidad> universidadesperuanas = new();
	List<UniversidadExtranjera> universidadesExtranjeras = new();
	bool cargandoUniversidadesExtranjeras = false;
	bool mostrarCampoTextoUniversidadExtranjera = false;
	string? nombrePaisSeleccionado = null;

	// Diccionario de mapeo de pa√≠ses espa√±ol -> ingl√©s para la API de universidades
	private static readonly Dictionary<string, string> PaisesEspanolIngles = new(StringComparer.OrdinalIgnoreCase)
	{
		{"ALEMANIA", "Germany"}, {"ARGENTINA", "Argentina"}, {"AUSTRALIA", "Australia"},
		{"AUSTRIA", "Austria"}, {"BELGICA", "Belgium"}, {"B√âLGICA", "Belgium"},
		{"BOLIVIA", "Bolivia"}, {"BRASIL", "Brazil"}, {"CANADA", "Canada"}, {"CANAD√Å", "Canada"},
		{"CHILE", "Chile"}, {"CHINA", "China"}, {"COLOMBIA", "Colombia"},
		{"COREA DEL SUR", "South Korea"}, {"COSTA RICA", "Costa Rica"}, {"CUBA", "Cuba"},
		{"DINAMARCA", "Denmark"}, {"ECUADOR", "Ecuador"}, {"EGIPTO", "Egypt"},
		{"EL SALVADOR", "El Salvador"}, {"EMIRATOS ARABES UNIDOS", "United Arab Emirates"},
		{"ESLOVAQUIA", "Slovakia"}, {"ESLOVENIA", "Slovenia"}, {"ESPA√ëA", "Spain"},
		{"ESTADOS UNIDOS", "United States"}, {"FILIPINAS", "Philippines"}, {"FINLANDIA", "Finland"},
		{"FRANCIA", "France"}, {"GRECIA", "Greece"}, {"GUATEMALA", "Guatemala"},
		{"HOLANDA", "Netherlands"}, {"HONDURAS", "Honduras"}, {"HUNGRIA", "Hungary"}, {"HUNGR√çA", "Hungary"},
		{"INDIA", "India"}, {"INDONESIA", "Indonesia"}, {"IRLANDA", "Ireland"},
		{"ISRAEL", "Israel"}, {"ITALIA", "Italy"}, {"JAPON", "Japan"}, {"JAP√ìN", "Japan"},
		{"MEXICO", "Mexico"}, {"M√âXICO", "Mexico"}, {"NICARAGUA", "Nicaragua"},
		{"NORUEGA", "Norway"}, {"NUEVA ZELANDA", "New Zealand"}, {"PAISES BAJOS", "Netherlands"},
		{"PANAMA", "Panama"}, {"PANAM√Å", "Panama"}, {"PARAGUAY", "Paraguay"},
		{"PERU", "Peru"}, {"PER√ö", "Peru"}, {"POLONIA", "Poland"}, {"PORTUGAL", "Portugal"},
		{"PUERTO RICO", "Puerto Rico"}, {"REINO UNIDO", "United Kingdom"},
		{"REPUBLICA CHECA", "Czech Republic"}, {"REP√öBLICA CHECA", "Czech Republic"},
		{"REPUBLICA DOMINICANA", "Dominican Republic"}, {"REP√öBLICA DOMINICANA", "Dominican Republic"},
		{"RUMANIA", "Romania"}, {"RUSIA", "Russia"}, {"SINGAPUR", "Singapore"},
		{"SUDAFRICA", "South Africa"}, {"SUD√ÅFRICA", "South Africa"}, {"SUECIA", "Sweden"},
		{"SUIZA", "Switzerland"}, {"TAILANDIA", "Thailand"}, {"TAIWAN", "Taiwan"},
		{"TURQUIA", "Turkey"}, {"TURQU√çA", "Turkey"}, {"UCRANIA", "Ukraine"},
		{"URUGUAY", "Uruguay"}, {"VENEZUELA", "Venezuela"}, {"VIETNAM", "Vietnam"}
	};

	private string ObtenerNombrePaisIngles(string nombreEspanol)
	{
		if (string.IsNullOrWhiteSpace(nombreEspanol))
			return nombreEspanol;

		// Intentar buscar en el diccionario
		if (PaisesEspanolIngles.TryGetValue(nombreEspanol.Trim(), out var nombreIngles))
			return nombreIngles;

		// Si no est√° en el diccionario, devolver el nombre original (quiz√°s ya est√° en ingl√©s)
		return nombreEspanol;
	}

	// Helper para parsear query string sin depender de System.Web
	private Dictionary<string, string> ParseQueryString(string query)
	{
		var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
		if (string.IsNullOrEmpty(query)) return result;
		
		// Remover el ? inicial si existe
		if (query.StartsWith("?")) query = query.Substring(1);
		
		foreach (var pair in query.Split('&'))
		{
			var parts = pair.Split('=');
			if (parts.Length == 2)
			{
				var key = Uri.UnescapeDataString(parts[0]);
				var value = Uri.UnescapeDataString(parts[1]);
				result[key] = value;
			}
			else if (parts.Length == 1 && !string.IsNullOrEmpty(parts[0]))
			{
				result[Uri.UnescapeDataString(parts[0])] = string.Empty;
			}
		}
		
		return result;
	}

	//Guardar Formulario
	private FormData formData = new FormData();
	private EditContext editContext;
	private MatriculaRequest MatriculaRequestModel = new MatriculaRequest();
	private List<Mat_ConsejoRegional> consejos = new();
	private List<MaestroRegistro> estacivil = new();
	private List<MaestroRegistro> tipodoc = new();
	private List<MaestroRegistro> gruposang = new();
	private List<MaestroRegistro> zonas = new();
	private List<MaestroRegistro> vias = new();
	private List<Mat_Pais> matpaises = new();

	private IBrowserFile fotoFile;
	private IBrowserFile pdfTituloMedicoCirujano;
	private IBrowserFile pdfConstanciaInscripcionSunedu;
	private IBrowserFile pdfCertificadoAntecedentesPenales;
	private IBrowserFile pdfCarnetExtranjeria;
	private IBrowserFile pdfConstanciaInscripcionReconocimientoSunedu;
	private IBrowserFile pdfConstanciaInscripcionRevalidacionUniversidadNacional;
	private IBrowserFile pdfReconocimientoSunedu;
	private IBrowserFile pdfRevalidacionUniversidadNacional;
	private IBrowserFile resolucionFile;

	/// <summary>Buffers de archivos le√≠dos al seleccionar; evita '_blazorFilesById' null al enviar.</summary>
	private byte[]? _fotoBuffer;
	private string? _fotoFileName;
	private string? _fotoContentType;
	private readonly Dictionary<string, (byte[] Bytes, string FileName)> _fileBuffers = new();
	private const int _pdfMaxBytes = 10 * 1024 * 1024;

	private string? imagePreviewUrl;
	private string mensajeError;
	private bool enviando = false;
	private bool mostrarErrorFoto = false;
	private bool estaValidando = false;
	private string mensajeValidacion = string.Empty;
	
	// Configuraci√≥n de tama√±o m√°ximo de archivo
	private long maxFileSizeBytes = 4 * 1024 * 1024; // 4MB por defecto
	private string maxFileSizeMBFormatted = "4.0";
	private bool mostrarEjemplos = false;
	private bool formularioEsValido = false;
	private bool aceptaDDJJ = false;
	private bool mostrarPoliticasModal = false;
	private bool ddjjValida = true;
	private bool intentadoEnviar = false;
	private string ddjjVersion = "v1.0";
	private string ddjjTexto = "Declaro bajo juramento (DDJJ) que la informaci√≥n proporcionada es veraz y completa. Autorizo el tratamiento de mis datos conforme a la normativa vigente.";
	private bool mostrarDDJJModal = false;
	private bool ddjjFirmaEnProceso = false;
	private bool ddjjFirmada = false;
	private string? ddjjCallbackResult = null; // Para mostrar el modal despu√©s del render
	private string ddjjPdfUrl = "/docs/ddjj-ejemplo.pdf";
	
	// Campos para DDJJ validada con ID Per√∫ (persistidos en BD)
	private DateTime? fechaFirmaDDJJ = null;
	private string? documentoFirmanteDDJJ = null;
	private bool tieneDDJJFirmadaEnServidor = false;
	
	// Campo para Pol√≠ticas de Privacidad persistido en BD
	private bool tienePoliticasAceptadasEnServidor = false;

	private List<Mat_Ubigeo> departamentos = new List<Mat_Ubigeo>();
	private List<Mat_Ubigeo> provincias = new List<Mat_Ubigeo>();
	private List<Mat_Ubigeo> distritos = new List<Mat_Ubigeo>();
	private List<Mat_Ubigeo> departamentosdm = new List<Mat_Ubigeo>();
	private List<Mat_Ubigeo> provinciasdm = new List<Mat_Ubigeo>();
	private List<Mat_Ubigeo> distritosdm = new List<Mat_Ubigeo>();
	private string selectedDepartamento;
	private string selectedProvincia;
	private string PersonaId;
	private bool charging = true;
	private DateTime MaxFechaNacimiento = DateTime.Today.AddYears(-18);
	private bool fechaInvalida = false;
	
	// Variables para el modal de observaciones
	private bool mostrarObservaciones = false;
	private string observacionesSolicitud = "";
	private bool tieneCarnetEnServidor = false;
	private readonly Dictionary<string, string> _documentosCargadosServidor = new();
	private string estadoActual = "";
	private int estadoIdActual = 0; // Para determinar si viene de observaci√≥n
	private bool esCorreccionPorObservacion => estadoIdActual == 3 || estadoIdActual == 5 || estadoIdActual == 7;

	// Alerta de requisitos previos: solo la primera vez en paso 1, no en correcci√≥n
	private bool yaMostramosAlertaRequisitos = false;
	private string requisitosPreviosTitulo = "Requisitos previos para el registro";
	private string requisitosPreviosHtml = "";
	private string requisitosPreviosConfirmar = "Entendido";
	private bool mostrarCalloutEsMedicoContinuo = false;

	private async Task OnFotoSelected(InputFileChangeEventArgs e)
	{
		try
		{
			// Resetear estados y vista previa
			imagePreviewUrl = null;
			fotoFile = null;
			_fotoBuffer = null;
			_fotoFileName = null;
			_fotoContentType = null;
			estaValidando = true;
			mensajeValidacion = "Validando imagen...";
			mostrarErrorFoto = false;
			StateHasChanged(); // Forzar actualizaci√≥n de la UI

			fotoFile = e.File;

			// Validaci√≥n b√°sica del archivo antes de enviar
			if (fotoFile == null || fotoFile.Size == 0)
			{
				mostrarErrorFoto = true;
				mensajeValidacion = "El archivo est√° vac√≠o";
				return;
			}

			// Validar tipo de archivo
			var allowedExtensions = new[] { ".jpg", ".jpeg", ".png" };
			var fileExtension = Path.GetExtension(fotoFile.Name).ToLowerInvariant();
			if (!allowedExtensions.Contains(fileExtension))
			{
				mostrarErrorFoto = true;
				mensajeValidacion = "Formato no soportado. Use JPG, JPEG o PNG";
				return;
			}

			// Validar tama√±o usando configuraci√≥n
			if (fotoFile.Size > maxFileSizeBytes)
			{
				mostrarErrorFoto = true;
				mensajeValidacion = $"La imagen no debe exceder {maxFileSizeMBFormatted}MB";
				return;
			}

			// Generar vista previa antes de enviar a la API
			var format = "image/jpeg"; // o "image/png" seg√∫n necesites
			var resizedImage = await fotoFile.RequestImageFileAsync(format, 300, 300);
			var buffer = new byte[resizedImage.Size];
			await resizedImage.OpenReadStream().ReadAsync(buffer);
			imagePreviewUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
			StateHasChanged(); // Actualizar para mostrar vista previa

			using var content = new MultipartFormDataContent();
			using var stream = fotoFile.OpenReadStream(maxAllowedSize: maxFileSizeBytes);
			content.Add(new StreamContent(stream), "file", fotoFile.Name);

			var response = await Http.PostAsync("api/FotoValidator/validar", content);

			if (!response.IsSuccessStatusCode)
			{
				mostrarErrorFoto = true;
				mensajeValidacion = "Error al validar la imagen";
				return;
			}

			var resultJson = await response.Content.ReadAsStringAsync();
			var result = JsonSerializer.Deserialize<FotoValidationResult>(resultJson);

			if (result == null)
			{
				mostrarErrorFoto = true;
				mensajeValidacion = "Respuesta inv√°lida del servidor";
				return;
			}

			// Evaluar respuesta completa del JSON
			if (result.valido)
			{
				mostrarErrorFoto = false;
				mensajeValidacion = "‚úì Imagen v√°lida";
				formData.FotoMedico = fotoFile;
				// Buffer para env√≠o (evita _blazorFilesById null al submit)
				await using var bs = fotoFile.OpenReadStream(maxAllowedSize: maxFileSizeBytes);
				using var ms = new MemoryStream();
				await bs.CopyToAsync(ms);
				_fotoBuffer = ms.ToArray();
				_fotoFileName = fotoFile.Name;
				_fotoContentType = fotoFile.ContentType ?? "image/jpeg";
			}
			else
			{
				mostrarErrorFoto = true;
				mensajeValidacion = result.mensaje ?? "La imagen no cumple los requisitos";
				formData.FotoMedico = null;
				_fotoBuffer = null;
				_fotoFileName = null;
				_fotoContentType = null;
			}
		}
		catch (Exception ex)
		{
			mostrarErrorFoto = true;
			mensajeValidacion = "Error al procesar la imagen";
			imagePreviewUrl = null; // Limpiar vista previa en caso de error
			Console.WriteLine($"Error: {ex.Message}");
		}
		finally
		{
			enviando = false;
			estaValidando = false;
			StateHasChanged(); // Actualizar UI al finalizar
		}
	}

	// Clase para deserializar la respuesta JSON
	public class FotoValidationResult
	{
		public string? genero { get; set; }
		public bool valido { get; set; }
		public string? mensaje { get; set; }
	}

	// Clase para la configuraci√≥n del validador
	public class FotoValidatorConfig
	{
		public long MaxFileSizeBytes { get; set; }
		public double MaxFileSizeMB { get; set; }
		public string MaxFileSizeMBFormatted { get; set; } = "4.0";
	}

	protected override async Task OnInitializedAsync()
	{
		try
		{
			// Detectar si estamos en ambiente de desarrollo (localhost)
			var currentUri = Navigation.Uri.ToLowerInvariant();
			esAmbienteDesarrollo = currentUri.Contains("localhost") || currentUri.Contains("127.0.0.1");
			
			// Verificar si viene del callback de ID PERU (par√°metro ddjj en la URL)
			var uri = new Uri(Navigation.Uri);
			if (!string.IsNullOrEmpty(uri.Query))
			{
				var queryParams = ParseQueryString(uri.Query);
				queryParams.TryGetValue("ddjj", out var ddjjResult);
				queryParams.TryGetValue("solicitudId", out var callbackSolicitudId);
				
				if (!string.IsNullOrEmpty(ddjjResult))
				{
					// Guardar el resultado para mostrar el modal despu√©s del render
					ddjjCallbackResult = ddjjResult;
					
					if (ddjjResult == "ok")
					{
						// Firma exitosa - recargar estado desde el servidor para actualizar el checkbox
						if (int.TryParse(callbackSolicitudId, out var sId))
						{
							SolicitudId = sId;
							// Cargar el estado actualizado de DDJJ desde el servidor
							await CargarEstadoDDJJ(SolicitudId);
						}
						else if (SolicitudId > 0)
						{
							// Si no viene en la URL, usar el SolicitudId actual
							await CargarEstadoDDJJ(SolicitudId);
						}
						else
						{
							// Fallback: establecer flags localmente si no hay SolicitudId
							ddjjFirmada = true;
							aceptaDDJJ = true;
							ddjjValida = true;
						}
					}
				}
			}
			
			// Cargar configuraci√≥n de tama√±o m√°ximo de archivo
			try
			{
				var configResponse = await Http.GetAsync("api/FotoValidator/config");
				if (configResponse.IsSuccessStatusCode)
				{
					var configJson = await configResponse.Content.ReadAsStringAsync();
					await JS.InvokeVoidAsync("console.log", new { 
						tag = "FotoValidatorConfig", 
						rawJson = configJson 
					});
					
					var config = JsonSerializer.Deserialize<FotoValidatorConfig>(configJson, new JsonSerializerOptions 
					{ 
						PropertyNameCaseInsensitive = true 
					});
					
					if (config != null && config.MaxFileSizeBytes > 0)
					{
						var bytes = config.MaxFileSizeBytes;
						var mb = config.MaxFileSizeMB;
						var formatted = !string.IsNullOrEmpty(config.MaxFileSizeMBFormatted) ? config.MaxFileSizeMBFormatted : $"{mb:F1}";
						
						maxFileSizeBytes = bytes;
						maxFileSizeMBFormatted = formatted;
						
						await JS.InvokeVoidAsync("console.log", new { 
							tag = "FotoValidatorConfig", 
							loaded = true, 
							maxBytes = maxFileSizeBytes, 
							maxMB = maxFileSizeMBFormatted 
						});
					}
					else
					{
						await JS.InvokeVoidAsync("console.warn", new { 
							tag = "FotoValidatorConfig", 
							message = "Config es null o MaxFileSizeBytes es 0, usando valores por defecto",
							config = config 
						});
					}
				}
				else
				{
					var errorContent = await configResponse.Content.ReadAsStringAsync();
					await JS.InvokeVoidAsync("console.warn", new { 
						tag = "FotoValidatorConfig", 
						statusCode = (int)configResponse.StatusCode,
						errorContent = errorContent,
						message = "No se pudo cargar la configuraci√≥n, usando valores por defecto" 
					});
				}
			}
			catch (Exception ex)
			{
				// Si falla, usar valores por defecto
				await JS.InvokeVoidAsync("console.error", new { 
					tag = "FotoValidatorConfig", 
					error = ex.Message,
					stackTrace = ex.StackTrace,
					message = "Error al cargar configuraci√≥n, usando valores por defecto" 
				});
			}

			var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
			var user = authState.User;

			if (user.Identity?.IsAuthenticated ?? false)
			{
				PersonaId = user.FindFirst("PersonaId")?.Value ?? "-";
			}

			consejos = await Http.GetFromJsonAsync<List<Mat_ConsejoRegional>>("api/consejoregional");
			tipodoc = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/23");
			estacivil = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/21");
			gruposang = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/19");
			zonas = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/17");
			vias = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/16");
			matpaises = await Http.GetFromJsonAsync<List<Mat_Pais>>("/api/MatPais");
			departamentos = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>("api/MatUbigeo/departamentos");
			departamentosdm = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>("api/MatUbigeo/departamentos");
			paises = await Http.GetFromJsonAsync<List<Pais>>("api/Pais");

			

            var peru = paises.FirstOrDefault(p => NombreEsPeru(p.Nombre));
			if (peru != null)
			{
				paisId = peru.Id;
			}

			paisesFiltrados = paises;


			if (SolicitudId > 0)
			{
				await CargarSolicitudExistente(SolicitudId);
			}
            else
            {
				// Si no hay SolicitudId en la URL, verificar si el usuario tiene solicitudes activas
				if (int.TryParse(PersonaId, out var personaIdInt) && personaIdInt > 0)
				{
					var solicitudesActivas = await Http.GetFromJsonAsync<List<SolicitudSeguimientoDto>>(
						$"api/personaseducacion/mis-solicitudes/{personaIdInt}");
					
					// Buscar solicitud activa (estado != 13 que es "rechazado/completado")
					var solicitudActiva = solicitudesActivas?
						.Where(s => s.EstadoId != 13)
						.OrderByDescending(s => s.FechaSolicitud)
						.FirstOrDefault();
					
					if (solicitudActiva != null)
					{
						// Redirigir autom√°ticamente a la solicitud activa
						Navigation.NavigateTo($"/solicitudes/prematricula/{solicitudActiva.Id}", forceLoad: true);
						return;
					}
				}

                var persona = await Http.GetFromJsonAsync<Persona>($"api/personaseducacion/{PersonaId}");
                // Cargar datos iniciales para nuevo registro
                formData = await MapPersonaToFormDataAsync(persona);
                tipoDocSeleccionado = formData.TipoDocumento ?? "62";
                editContext = new EditContext(formData);
                SyncPerfilFromForm();

                // Asegurar origen nacional por defecto y fijar Per√∫ como pa√≠s de universidad
                formData.UniversidadOrigen = string.IsNullOrEmpty(formData.UniversidadOrigen) ? "1" : formData.UniversidadOrigen;
                await OnTipoSeleccionado(formData.UniversidadOrigen);
                if (string.IsNullOrEmpty(formData.PaisUniversidad) && paisId > 0)
                {
                    formData.PaisUniversidad = paisId.ToString();
                }
                await JS.InvokeVoidAsync("console.log", new { tag = "Init-NuevaSolicitud", paisesCount = paises?.Count ?? 0, paisId, formPais = formData.PaisUniversidad });
            }

            await CargarUniversidades();
			await CargarUniversidadesPeruanas();

			await DeterminarPasoInicial();
			await RestaurarPoliticasDDJJSiAplicaAsync();

			// Cargar requisitos previos desde AppSettings (modificable en appsettings.json sin recompilar)
			await CargarRequisitosPreviosAsync();

			// Consulta Es M√©dico al inicio (antes del modal de requisitos): si hay DNI v√°lido, verificar si es m√©dico
			await ConsultarEsMedicoSiHayDniAsync();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en carga inicial: {ex.Message}");
		}
		finally
		{
			charging = false; // Ocultar el spinner
			StateHasChanged();
		}

		// var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		//       var user = authState.User;

		//       if (user.Identity?.IsAuthenticated ?? false)
		//       {
		// 	PersonaId = user.FindFirst("PersonaId")?.Value ?? "-";
		//       }

		// consejos = await Http.GetFromJsonAsync<List<Mat_ConsejoRegional>>("api/consejoregional");
		// tipodoc = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/23");
		// estacivil = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/21");
		// gruposang = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/19");
		// zonas = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/17");
		// vias = await Http.GetFromJsonAsync<List<MaestroRegistro>>("/api/MaestroRegistro/id/16");
		// matpaises = await Http.GetFromJsonAsync<List<Mat_Pais>>("/api/MatPais");
		// departamentos = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>("api/MatUbigeo/departamentos");
		// departamentosdm = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>("api/MatUbigeo/departamentos");
		// paises = await Http.GetFromJsonAsync<List<Pais>>("api/Pais");
		// var persona = await Http.GetFromJsonAsync<Persona>($"api/personaseducacion/{PersonaId}");
		// var peru = paises.FirstOrDefault(p => p.Nombre.ToLower().Contains("per√∫"));
		// if (peru != null)
		// {
		// 	paisId = peru.Id;
		// }

		// paisesFiltrados = paises; // Inicialmente todos, pero se ajusta m√°s abajo
		// formData = MapPersonaToFormData(persona);
		// editContext = new EditContext(formData);
		// // editContext.OnFieldChanged += async (_, __) => await VerificarFormularioValido();
		// // await VerificarFormularioValido();

		// await CargarUniversidades();
		// await CargarUniversidadesPeruanas();
	}

	private async Task CargarSolicitudExistente(int solicitudId)
	{
		try
		{
			var solicitud = await Http.GetFromJsonAsync<FormData>($"api/personaseducacion/solicituddet/{solicitudId}");
			if (solicitud != null)
			{
				var personaedit = await Http.GetFromJsonAsync<Persona>($"api/personaseducacion/{solicitud.PersonaId}");
				
				// Cargar datos iniciales para nuevo registro
				formData = await MapPersonaToFormDataAsync(personaedit);
				tipoDocSeleccionado = formData.TipoDocumento ?? "62";
				
				// Cargar datos de educaci√≥n si existen
				if (personaedit.Educaciones != null && personaedit.Educaciones.Any())
				{
					var educacion = personaedit.Educaciones.First();
					formData.UniversidadOrigen = educacion.UniversidadOrigen;
					formData.Universidad = educacion.UniversidadId.ToString();
					// Asignar fecha si tiene valor, de lo contrario dejar en default (blanco)
					formData.FechaEmisionTitulo = educacion.FechaEmisionTitulo != default(DateTime) ? educacion.FechaEmisionTitulo : default(DateTime);
					formData.PaisUniversidad = educacion.PaisUniversidadId.ToString() ?? "173";
					formData.TipoValidacion = educacion.TipoValidacion;
					formData.NumeroResolucion = educacion.NumeroResolucion;
					formData.UniversidadPeruana = educacion.UniversidadPeruanaId?.ToString();
					formData.NombreUniversidadExtranjera = educacion.NombreUniversidadExtranjera;
					formData.FechaReconocimiento = educacion.FechaReconocimiento;
					formData.FechaRevalidacion = educacion.FechaRevalidacion;
					tipoValidacionExtranjera = formData.TipoValidacion ?? "";
				}
				else
				{
					// Si no hay educaci√≥n, dejar fecha en blanco (default)
					formData.FechaEmisionTitulo = default(DateTime);
				}
				
				// Cargar perfil desde observaciones (si existe)
				try
				{
					var solicitudCompleta = await Http.GetAsync($"api/personaseducacion/solicituddet/{solicitudId}");
					if (solicitudCompleta.IsSuccessStatusCode)
					{
						var jsonString = await solicitudCompleta.Content.ReadAsStringAsync();
						var jsonDoc = JsonDocument.Parse(jsonString);
						var root = jsonDoc.RootElement;
						
						// Buscar observaciones para extraer el perfil
						if (root.TryGetProperty("observaciones", out var obsElement) || 
							root.TryGetProperty("Observaciones", out obsElement))
						{
							var observaciones = obsElement.GetString();
							if (!string.IsNullOrEmpty(observaciones) && observaciones.Contains("Perfil:"))
							{
								// Extraer el perfil de las observaciones
								var perfilMatch = System.Text.RegularExpressions.Regex.Match(observaciones, @"Perfil:\s*(\d+)");
								if (perfilMatch.Success)
									perfilSeleccionado = perfilMatch.Groups[1].Value;
							}
						}
						tieneCarnetEnServidor = false;
						_documentosCargadosServidor.Clear();
						if (root.TryGetProperty("persona", out var pEl) || root.TryGetProperty("Persona", out pEl))
						{
							var pathFoto = pEl.TryGetProperty("fotoPath", out var fp) ? fp.GetString() : (pEl.TryGetProperty("FotoPath", out var fp2) ? fp2.GetString() : null);
							if (!string.IsNullOrWhiteSpace(pathFoto))
								_documentosCargadosServidor["Foto"] = pathFoto;
							if ((pEl.TryGetProperty("educaciones", out var edEl) || pEl.TryGetProperty("Educaciones", out edEl)) && edEl.GetArrayLength() > 0)
							{
								var ed = edEl[0];
								if ((ed.TryGetProperty("documento", out var docEl) || ed.TryGetProperty("Documento", out docEl)) && docEl.ValueKind != JsonValueKind.Null)
								{
									var path = GetJsonString(docEl, "carnetExtranjeriaPath", "CarnetExtranjeriaPath");
									tieneCarnetEnServidor = !string.IsNullOrWhiteSpace(path);
									SetDocServidor("CarnetExtranjeria", path);
									SetDocServidor("TituloMedicoCirujano", GetJsonString(docEl, "tituloMedicoCirujanoPath", "TituloMedicoCirujanoPath"));
									SetDocServidor("CertificadoAntecedentesPenales", GetJsonString(docEl, "certificadoAntecedentesPenalesPath", "CertificadoAntecedentesPenalesPath"));
									SetDocServidor("ConstanciaInscripcionReconocimientoSunedu", GetJsonString(docEl, "constanciaInscripcionReconocimientoSuneduPath", "ConstanciaInscripcionReconocimientoSuneduPath"));
									SetDocServidor("ReconocimientoSunedu", GetJsonString(docEl, "reconocimientoSuneduPath", "ReconocimientoSuneduPath"));
									SetDocServidor("ConstanciaInscripcionRevalidacionUniversidadNacional", GetJsonString(docEl, "constanciaInscripcionRevalidacionUniversidadNacionalPath", "ConstanciaInscripcionRevalidacionUniversidadNacionalPath"));
									SetDocServidor("RevalidacionUniversidadNacional", GetJsonString(docEl, "revalidacionUniversidadNacionalPath", "RevalidacionUniversidadNacionalPath"));
								}
							}
						}
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error al cargar perfil/carnet/documentos: {ex.Message}");
				}
		
		editContext = new EditContext(formData);
		SyncPerfilFromForm();
		
		// Si es correcci√≥n por observaci√≥n, establecer pol√≠ticas y DDJJ autom√°ticamente
		if (esCorreccionPorObservacion)
		{
			formData.AceptaPoliticas = true;
			aceptaDDJJ = true;
			ddjjValida = true;
		}
				
				// Cargar combos dependientes
				await OnTipoSeleccionado(formData.UniversidadOrigen);
				
				// Cargar universidades seg√∫n el pa√≠s
                if (!string.IsNullOrEmpty(formData.PaisUniversidad))
                {
                    if (int.TryParse(formData.PaisUniversidad, out var parsedPais))
                    {
                        paisId = parsedPais;
						
						// Si es universidad extranjera y hay pa√≠s seleccionado, cargar universidades de la API
						if (formData.UniversidadOrigen == "0")
						{
							var paisSeleccionado = paises.FirstOrDefault(p => p.Id == parsedPais);
							if (paisSeleccionado != null)
							{
								nombrePaisSeleccionado = paisSeleccionado.Nombre;
								await CargarUniversidadesExtranjeras(paisSeleccionado.Nombre);
							}
						}
                    }
                    else
                    {
                        var peruLocal = paises.FirstOrDefault(p => NombreEsPeru(p.Nombre));
                        if (peruLocal != null)
                        {
                            paisId = peruLocal.Id;
                            formData.PaisUniversidad = peruLocal.Id.ToString();
                        }
                    }
                    await CargarUniversidades();
                }
                else
                {
                    var peruLocal = paises.FirstOrDefault(p => NombreEsPeru(p.Nombre));
                    if (peruLocal != null)
                    {
                        paisId = peruLocal.Id;
                        formData.PaisUniversidad = peruLocal.Id.ToString();
                        await CargarUniversidades();
                    }
                }
                // Sincronizar combo de universidad con valor existente si aplica
                if (tipoSeleccionado == "1")
                {
                    // Si hab√≠a universidad guardada, mantener selecci√≥n
                    if (!string.IsNullOrEmpty(formData.Universidad) && universidades.Any(u => u.Id.ToString() == formData.Universidad))
                    {
                        // No hacer nada, Blazor la mantendr√° por el bind como string
                    }
                }
				
				// Obtener informaci√≥n de la solicitud para mostrar observaciones
				await ObtenerObservacionesSolicitud(solicitudId);
				
				// Cargar estado de DDJJ firmada con ID Per√∫
				await CargarEstadoDDJJ(solicitudId);
			}
		}
		catch (Exception ex)
		{
			mensajeError = $"Error al cargar solicitud: {ex.Message}";
		}
	}
	
	/// <summary>
	/// Carga el estado de la DDJJ firmada con ID Per√∫ y pol√≠ticas aceptadas desde el servidor
	/// </summary>
	private async Task CargarEstadoDDJJ(int solicitudId)
	{
		try
		{
			var response = await Http.GetAsync($"api/DDJJ/estado/{solicitudId}");
			if (response.IsSuccessStatusCode)
			{
				var json = await response.Content.ReadAsStringAsync();
				using var doc = JsonDocument.Parse(json);
				var root = doc.RootElement;
				
				// Leer campos del estado DDJJ
				if (root.TryGetProperty("ddjjFirmadaIdPeru", out var firmadaProp) || 
				    root.TryGetProperty("DDJJFirmadaIdPeru", out firmadaProp))
				{
					tieneDDJJFirmadaEnServidor = firmadaProp.GetBoolean();
				}
				
				if (tieneDDJJFirmadaEnServidor)
				{
					// Marcar DDJJ como firmada
					ddjjFirmada = true;
					aceptaDDJJ = true;
					ddjjValida = true;
					
					// Obtener fecha de firma
					if (root.TryGetProperty("fechaFirmaDDJJ", out var fechaProp) || 
					    root.TryGetProperty("FechaFirmaDDJJ", out fechaProp))
					{
						if (fechaProp.ValueKind != JsonValueKind.Null)
						{
							fechaFirmaDDJJ = fechaProp.GetDateTime();
						}
					}
					
					// Obtener documento del firmante
					if (root.TryGetProperty("documentoFirmanteDDJJ", out var docProp) || 
					    root.TryGetProperty("DocumentoFirmanteDDJJ", out docProp))
					{
						if (docProp.ValueKind != JsonValueKind.Null)
						{
							documentoFirmanteDDJJ = docProp.GetString();
						}
					}
				}
				
				// Leer campo de pol√≠ticas de privacidad
				if (root.TryGetProperty("aceptaPoliticasPrivacidad", out var politicasProp) || 
				    root.TryGetProperty("AceptaPoliticasPrivacidad", out politicasProp))
				{
					tienePoliticasAceptadasEnServidor = politicasProp.GetBoolean();
					if (tienePoliticasAceptadasEnServidor)
					{
						formData.AceptaPoliticas = true;
					}
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error al cargar estado DDJJ: {ex.Message}");
			// No bloquear el flujo si falla la carga del estado DDJJ
		}
	}
	
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		// Alerta de requisitos previos: solo la primera vez en paso 1, cuando es nueva solicitud (SolicitudId <= 0),
		// no en correcci√≥n por observaci√≥n, y no se ha mostrado ya
		if (firstRender && currentStep == 1 && SolicitudId <= 0 && !esCorreccionPorObservacion && !yaMostramosAlertaRequisitos)
		{
			yaMostramosAlertaRequisitos = true;
			var htmlRequisitos = !string.IsNullOrWhiteSpace(requisitosPreviosHtml)
				? requisitosPreviosHtml
				: @"<div class=""text-start""><p class=""mb-2""><strong>Antes de iniciar el registro, aseg√∫rese de tener:</strong></p><ul class=""list-unstyled""><li>‚Ä¢ <strong>DNI electr√≥nico:</strong> Necesario para validar su DDJJ mediante ID PERU.</li><li>‚Ä¢ <strong>Paso 2 - Curso de √âtica:</strong> Debe completar el curso en el Aula Virtual antes de continuar al paso 3.</li><li>‚Ä¢ <strong>Paso 4 - Pago:</strong> Debe realizar el pago correspondiente para enviar su solicitud.</li><li>‚Ä¢ <strong>Documentos:</strong> Tenga a mano su t√≠tulo profesional, constancias y dem√°s documentos escaneados en formato PDF.</li><li>‚Ä¢ <strong>Foto reciente:</strong> Para cargar en el formulario (formato v√°lido, buena calidad).</li></ul><p class=""text-muted small mt-2 mb-0"">Esta informaci√≥n es solo de car√°cter informativo.</p></div>";
			await JS.InvokeVoidAsync("Swal.fire", new
			{
				title = requisitosPreviosTitulo,
				html = htmlRequisitos,
				icon = "info",
				confirmButtonText = requisitosPreviosConfirmar,
				width = "600"
			});
		}

		if (firstRender && !string.IsNullOrEmpty(ddjjCallbackResult))
		{
			// Limpiar los par√°metros de la URL sin recargar la p√°gina
			var uri = new Uri(Navigation.Uri);
			var cleanUrl = uri.GetLeftPart(UriPartial.Path);
			await JS.InvokeVoidAsync("eval", $"window.history.replaceState(null, '', '{cleanUrl}')");
			
			// Mostrar el modal correspondiente
			if (ddjjCallbackResult == "ok")
			{
				await JS.InvokeVoidAsync("Swal.fire", new { 
					title = "Validaci√≥n Exitosa", 
					text = "La DDJJ ha sido validada correctamente con ID PERU. Ahora puede enviar la solicitud.", 
					icon = "success" 
				});
			}
			else if (ddjjCallbackResult == "cancelled")
			{
				await JS.InvokeVoidAsync("Swal.fire", new { 
					title = "Firma Cancelada", 
					text = "Ha cancelado el proceso de firma con ID PERU. Puede intentarlo nuevamente.", 
					icon = "warning" 
				});
			}
			else if (ddjjCallbackResult == "error")
			{
				await JS.InvokeVoidAsync("Swal.fire", new { 
					title = "Advertencia", 
					text = "El DNI utilizado para la validaci√≥n no corresponde al solicitante. Puede intentarlo nuevamente.", 
					icon = "warning" 
				});
			}
			
			// Limpiar el resultado despu√©s de mostrar
			ddjjCallbackResult = null;
		}
	}
	
	private async Task ObtenerObservacionesSolicitud(int solicitudId)
	{
		try
		{
			// Usar el nuevo endpoint para obtener observaciones
			var response = await Http.GetAsync($"api/correccionsolicitud/observaciones-solicitud/{solicitudId}");
			
			if (response.IsSuccessStatusCode)
			{
				var jsonString = await response.Content.ReadAsStringAsync();
				var jsonDoc = JsonDocument.Parse(jsonString);
				var root = jsonDoc.RootElement;
				
				if (root.TryGetProperty("estadoActual", out var estadoActualElement))
				{
					estadoActual = estadoActualElement.GetString() ?? "Sin estado";
				}
				else
				{
					estadoActual = "Sin estado";
				}
				
				if (root.TryGetProperty("observaciones", out var observacionesElement))
				{
					observacionesSolicitud = observacionesElement.GetString() ?? "No hay observaciones registradas.";
				}
				else
				{
					observacionesSolicitud = "No hay observaciones registradas.";
				}
				
				// Mostrar modal si la solicitud est√° en estado rechazado
				if (root.TryGetProperty("estadoId", out var estadoIdElement))
				{
					estadoIdActual = estadoIdElement.GetInt32();
					// Estados de rechazo: 3, 5, 7
					if (estadoIdActual == 3 || estadoIdActual == 5 || estadoIdActual == 7)
					{
						mostrarObservaciones = true;
						StateHasChanged();
					}
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error al obtener observaciones: {ex.Message}");
		}
	}
	
	private void CerrarObservaciones()
	{
		mostrarObservaciones = false;
		StateHasChanged();
	}

	async Task OnTipoSeleccionado(string valorseleccionado)
	{
		formData.UniversidadOrigen = valorseleccionado;
		tipoSeleccionado = valorseleccionado ?? "1";
		
		// Determinar el ID del select de pa√≠s seg√∫n el paso actual
		var paisSelectId = currentStep == 1 ? "pais_uni_paso1" : "pais_uni_paso3";
		
        if (tipoSeleccionado == "1") // Nacional
		{
			// Destruir Select2 del campo pa√≠s si existe
			await JS.InvokeVoidAsync("destroySelect2", paisSelectId);
			
			paisBloqueado = true;

            var peru = paises.FirstOrDefault(p => NombreEsPeru(p.Nombre));
			if (peru != null)
			{
				paisId = peru.Id;
                formData.PaisUniversidad = peru.Id.ToString();
			}

            paisesFiltrados = paises.Where(p => NombreEsPeru(p.Nombre)).ToList();
            await JS.InvokeVoidAsync("console.log", new { tag = "OnTipoSeleccionado-Nacional", paisId, formPais = formData.PaisUniversidad });
		}
        else // Extranjera
		{
			paisBloqueado = false;

            paisesFiltrados = paises
                .Where(p => !NombreEsPeru(p.Nombre))
                .ToList();

			paisId = 0; // resetear
            formData.PaisUniversidad = string.Empty;
            await JS.InvokeVoidAsync("console.log", new { tag = "OnTipoSeleccionado-Extranjera", paisId, formPais = formData.PaisUniversidad });
		}

		await CargarUniversidades();
		// üîÑ Forzar re-render
		StateHasChanged();

		// üïí Esperar a que se actualice el DOM
		await Task.Delay(100);

		// Inicializar Select2 para el campo de pa√≠s si es extranjera
		if (tipoSeleccionado == "0")
		{
			await JS.InvokeVoidAsync("initSelect2Pais", paisSelectId);
		}

	}
	async Task OnTipoDocSeleccionado(string valseleccionado)
	{
		tipoDocSeleccionado = valseleccionado;
		formData.TipoDocumento = valseleccionado;
	}

	async Task OnPerfilSeleccionado(string valorPerfil)
	{
		perfilSeleccionado = valorPerfil;

		// Perfil 1: Profesional peruano con t√≠tulo de universidad peruana
		// Perfil 3: Profesional extranjero con t√≠tulo otorgado en el Per√∫
		if (valorPerfil == "1" || valorPerfil == "3")
		{
			// Tipo de documento: DNI (62)
			formData.TipoDocumento = "62";
			tipoDocSeleccionado = "62";

			// Origen de Universidad: Nacional
			formData.UniversidadOrigen = "1";
			await OnTipoSeleccionado("1");
		}
		// Perfil 2: Profesional peruano con t√≠tulo de universidad extranjera
		// Perfil 4: Profesional extranjero con t√≠tulo otorgado en el extranjero
		else if (valorPerfil == "2" || valorPerfil == "4")
		{
			// Tipo de documento: Carnet de Extranjer√≠a (64)
			formData.TipoDocumento = "64";
			tipoDocSeleccionado = "64";

			// Limpiar el n√∫mero de documento porque ya no es DNI
			formData.NumeroDocumento = string.Empty;

			// Origen de Universidad: Extranjera
			formData.UniversidadOrigen = "0";
			await OnTipoSeleccionado("0");
		}

		await JS.InvokeVoidAsync("console.log", new { tag = "OnPerfilSeleccionado", perfil = valorPerfil, tipoDoc = formData.TipoDocumento, uniOrigen = formData.UniversidadOrigen });
		StateHasChanged();
	}
	private bool consultandoReniec = false;

	// Consulta Es M√©dico (CMP): resultado y callout que se oculta en 15 s
	private bool? resultadoEsMedico = null;
	private string mensajeConsultaMedico = "";
	private bool mostrarCalloutEsMedico = false;
	private CancellationTokenSource? _calloutMedicoCts = null;

	/// <summary>Carga los requisitos previos desde AppSettings v√≠a API. Permite modificar el texto en appsettings.json sin recompilar.</summary>
	private async Task CargarRequisitosPreviosAsync()
	{
		try
		{
			var res = await Http.GetAsync("api/config/prematricula-requisitos");
			if (res.IsSuccessStatusCode)
			{
				var json = await res.Content.ReadAsStringAsync();
				using var doc = JsonDocument.Parse(json);
				var root = doc.RootElement;
				if (root.TryGetProperty("titulo", out var t)) requisitosPreviosTitulo = t.GetString() ?? requisitosPreviosTitulo;
				if (root.TryGetProperty("html", out var h)) requisitosPreviosHtml = h.GetString() ?? "";
				if (root.TryGetProperty("confirmar", out var c)) requisitosPreviosConfirmar = c.GetString() ?? requisitosPreviosConfirmar;
				if (root.TryGetProperty("mostrarCalloutEsMedicoContinuo", out var m)) mostrarCalloutEsMedicoContinuo = m.ValueKind == JsonValueKind.True;
			}
		}
		catch { /* usar valores por defecto */ }
	}

	/// <summary>Consulta si el DNI corresponde a un m√©dico colegiado. Se ejecuta al inicio (antes del modal de requisitos) y en blur del campo DNI.</summary>
	private async Task ConsultarEsMedicoSiHayDniAsync(string? dni = null)
	{
		var numDoc = dni ?? formData?.NumeroDocumento ?? "";
		var esDni = tipoDocSeleccionado == "62" || formData?.TipoDocumento == "62";
		if (!esDni || string.IsNullOrWhiteSpace(numDoc) || numDoc.Length != 8 || !numDoc.All(char.IsDigit))
			return;
		try
		{
			var resMedico = await Http.GetAsync($"api/reniec/consulta-es-medico/{numDoc}");
			var bodyMedico = await resMedico.Content.ReadAsStringAsync();
			using var docMedico = JsonDocument.Parse(bodyMedico);
			var root = docMedico.RootElement;
			var esMedico = root.TryGetProperty("esMedico", out var em) && em.ValueKind == JsonValueKind.True;
			resultadoEsMedico = esMedico;
			mensajeConsultaMedico = esMedico ? "El DNI corresponde a un m√©dico colegiado en el CMP." : "El DNI no corresponde a un m√©dico colegiado en el CMP.";
			mostrarCalloutEsMedico = true;

			// Si MostrarCalloutEsMedicoContinuo=false, ocultar despu√©s de 15 segundos
			if (!mostrarCalloutEsMedicoContinuo)
			{
				_calloutMedicoCts?.Cancel();
				_calloutMedicoCts = new CancellationTokenSource();
				var token = _calloutMedicoCts.Token;
				_ = Task.Run(async () =>
				{
					try
					{
						await Task.Delay(15000, token);
						if (!token.IsCancellationRequested)
						{
							mostrarCalloutEsMedico = false;
							await InvokeAsync(() => StateHasChanged());
						}
					}
					catch (OperationCanceledException) { }
				});
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("console.warn", new { tag = "ConsultaEsMedico-ERR", ex = ex.Message });
		}
	}

	private async Task OnNumeroDocumentoBlur(FocusEventArgs args)
	{
		try
		{
			// Solo si es DNI (62) y hay 8 d√≠gitos: consultar API en 2 tiempos (token ‚Üí consulta reniec/{DNI})
			var esDni = tipoDocSeleccionado == "62" || formData.TipoDocumento == "62";
			if (esDni
				&& !string.IsNullOrWhiteSpace(formData.NumeroDocumento)
				&& formData.NumeroDocumento.All(char.IsDigit)
				&& formData.NumeroDocumento.Length == 8)
			{
				consultandoReniec = true;
				StateHasChanged();
				try
				{
					// 1. Consulta RENIEC (opcional: puede fallar en localhost por IP)
					var url = $"api/reniec/consulta/{formData.NumeroDocumento}?personaId={PersonaId}";
					var res = await Http.GetAsync(url);
					var body = await res.Content.ReadAsStringAsync();
					if (res.IsSuccessStatusCode)
					{
						var result = JsonSerializer.Deserialize<ReniecResultDto>(body);
						if (result != null)
						{
							if (!string.IsNullOrWhiteSpace(result.Nombres)) formData.Nombres = result.Nombres;
							if (!string.IsNullOrWhiteSpace(result.ApellidoPaterno)) formData.ApellidoPaterno = result.ApellidoPaterno;
							if (!string.IsNullOrWhiteSpace(result.ApellidoMaterno)) formData.ApellidoMaterno = result.ApellidoMaterno;
							if (result.FechaNacimiento.HasValue)
							{
								formData.FechaNacimiento = result.FechaNacimiento.Value;
								ValidarFechaNacimiento();
							}
							if (!string.IsNullOrWhiteSpace(result.Sexo))
							{
								formData.Sexo = result.Sexo.Equals("MASCULINO", StringComparison.OrdinalIgnoreCase) ? "1"
									: result.Sexo.Equals("FEMENINO", StringComparison.OrdinalIgnoreCase) ? "0" : formData.Sexo;
							}
							if (!string.IsNullOrWhiteSpace(result.EstadoCivil) && estacivil?.Count > 0)
							{
								var ec = estacivil.FirstOrDefault(x => string.Equals(x.Nombre, result.EstadoCivil, StringComparison.OrdinalIgnoreCase));
								if (ec != null) formData.EstadoCivil = ec.MaestroRegistro_Key.ToString();
							}
						}
					}
					else
					{
						var msg = "No se pudo consultar RENIEC.";
						try
						{
							using var doc = JsonDocument.Parse(body);
							if (doc.RootElement.TryGetProperty("message", out var m)) msg = m.GetString() ?? msg;
						}
						catch { /* usar msg por defecto */ }
						await JS.InvokeVoidAsync("Swal.fire", new { title = "Consulta RENIEC", text = msg, icon = "warning" });
					}

					// 2. Consulta Es M√©dico (CMP): siempre ejecutar cuando hay DNI v√°lido
					await ConsultarEsMedicoSiHayDniAsync(formData.NumeroDocumento);
				}
				finally
				{
					consultandoReniec = false;
					StateHasChanged();
				}
			}
		}
		catch (Exception ex)
		{
			consultandoReniec = false;
			StateHasChanged();
			await JS.InvokeVoidAsync("console.warn", new { tag = "RENIEC-ERR", ex = ex.Message });
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Consulta RENIEC", text = "Error de red o del servidor. Si trabajas en localhost, RENIEC puede aceptar solo IPs autorizadas.", icon = "error" });
		}
	}
	async Task OnTipoValidacionSeleccionado(string valorseleccionado)
	{
		formData.TipoValidacion = valorseleccionado;
		tipoValidacionExtranjera = valorseleccionado ?? "";
		
		await JS.InvokeVoidAsync("console.log", new { 
			tag = "OnTipoValidacionSeleccionado", 
			valorSeleccionado = valorseleccionado, 
			tipoValidacionExtranjera = tipoValidacionExtranjera,
			tipoSeleccionado = tipoSeleccionado
		});

		// üîÑ Forzar re-render
		StateHasChanged();

		// üïí Esperar a que se actualice el DOM
		await Task.Delay(10);
	}
	async Task OnPaisSeleccionadoAsync(string valorPais)
	{
		formData.PaisUniversidad = valorPais;
		
		if (int.TryParse(valorPais, out int id))
		{
			paisId = id;
			
			// Si es universidad extranjera, cargar desde la API externa
			if (tipoSeleccionado == "0")
			{
				var paisSeleccionado = paises.FirstOrDefault(p => p.Id == id);
				if (paisSeleccionado != null)
				{
					nombrePaisSeleccionado = paisSeleccionado.Nombre;
					await CargarUniversidadesExtranjeras(paisSeleccionado.Nombre);
				}
			}
			else
			{
				// Si es universidad nacional, cargar desde el backend
				universidades = await Http.GetFromJsonAsync<List<Universidad>>($"api/universidad/{paisId}");
			}
			
			await JS.InvokeVoidAsync("console.log", new { tag = "OnPaisSeleccionadoAsync", paisId, formPais = formData.PaisUniversidad, universidadesCount = universidades?.Count ?? 0 });
		}
		
		StateHasChanged();
	}

	async Task CargarUniversidadesExtranjeras(string nombrePais)
	{
		try
		{
			cargandoUniversidadesExtranjeras = true;
			mostrarCampoTextoUniversidadExtranjera = false;
			StateHasChanged();

			// Limpiar la selecci√≥n anterior
			formData.NombreUniversidadExtranjera = string.Empty;

			// Convertir el nombre del pa√≠s a ingl√©s para la API
			var nombrePaisIngles = ObtenerNombrePaisIngles(nombrePais);
			
			await JS.InvokeVoidAsync("console.log", new { tag = "CargarUniversidadesExtranjeras", paisEspanol = nombrePais, paisIngles = nombrePaisIngles });

			// Llamar al endpoint del backend que hace proxy a la API externa
			var url = $"api/universidad/extranjeras/{Uri.EscapeDataString(nombrePaisIngles)}";
			
			universidadesExtranjeras = await Http.GetFromJsonAsync<List<UniversidadExtranjera>>(url) ?? new();
			
			await JS.InvokeVoidAsync("console.log", new { tag = "CargarUniversidadesExtranjeras-Resultado", pais = nombrePaisIngles, count = universidadesExtranjeras.Count });
			
			if (universidadesExtranjeras.Count == 0)
			{
				// No se encontraron universidades, mostrar campo de texto
				mostrarCampoTextoUniversidadExtranjera = true;
				cargandoUniversidadesExtranjeras = false;
				StateHasChanged();
			}
			else
			{
				// Inicializar Select2 despu√©s de cargar las universidades
				mostrarCampoTextoUniversidadExtranjera = false;
				cargandoUniversidadesExtranjeras = false; // Importante: desactivar loading ANTES de renderizar el select
				StateHasChanged();
				await Task.Delay(300); // Esperar a que el DOM se actualice
				await InicializarSelect2UniversidadesExtranjeras();
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("console.error", new { tag = "CargarUniversidadesExtranjeras-Error", message = ex.Message });
			// Si hay error, mostrar campo de texto
			mostrarCampoTextoUniversidadExtranjera = true;
			universidadesExtranjeras = new();
			cargandoUniversidadesExtranjeras = false;
			StateHasChanged();
		}
	}

	async Task InicializarSelect2UniversidadesExtranjeras()
	{
		// Solo inicializar si hay universidades y no estamos mostrando campo de texto
		if (universidadesExtranjeras.Count == 0 || mostrarCampoTextoUniversidadExtranjera || cargandoUniversidadesExtranjeras)
		{
			await JS.InvokeVoidAsync("console.log", new { tag = "InicializarSelect2-Skip", reason = "No hay universidades o se muestra campo de texto", count = universidadesExtranjeras.Count, mostrarTexto = mostrarCampoTextoUniversidadExtranjera });
			return;
		}

		try
		{
			// Esperar un poco m√°s para asegurar que el DOM est√© listo
			await Task.Delay(100);
			
			var elementId = currentStep == 1 ? "select_universidad_extranjera_paso1" : "select_universidad_extranjera";
			await JS.InvokeVoidAsync("console.log", new { tag = "InicializarSelect2-Intentando", elementId = elementId, currentStep = currentStep });
			await JS.InvokeVoidAsync("initSelect2UniversidadesExtranjeras", elementId);
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("console.error", new { tag = "InicializarSelect2-Error", message = ex.Message });
		}
	}

	async Task VolverABusquedaAutomaticaPaso1()
	{
		mostrarCampoTextoUniversidadExtranjera = false;
		StateHasChanged();
		await Task.Delay(100);
		await JS.InvokeVoidAsync("initSelect2UniversidadesExtranjeras", "select_universidad_extranjera_paso1");
	}

	async Task VolverABusquedaAutomatica()
	{
		mostrarCampoTextoUniversidadExtranjera = false;
		StateHasChanged();
		await Task.Delay(100);
		await InicializarSelect2UniversidadesExtranjeras();
	}

	async Task CambiarATextoManualPaso1()
	{
		// Destruir Select2 antes de ocultar
		await JS.InvokeVoidAsync("destroySelect2", "select_universidad_extranjera_paso1");
		mostrarCampoTextoUniversidadExtranjera = true;
		StateHasChanged();
	}

	async Task CambiarATextoManual()
	{
		// Destruir Select2 antes de ocultar
		await JS.InvokeVoidAsync("destroySelect2", "select_universidad_extranjera");
		mostrarCampoTextoUniversidadExtranjera = true;
		StateHasChanged();
	}

	async Task CargarUniversidades()
	{
		if (paisId > 0)
		{
			try
			{
				universidades = await Http.GetFromJsonAsync<List<Universidad>>("api/universidad/" + paisId) ?? new List<Universidad>();
				if (universidades.Count == 0)
				{
					try
					{
						await Http.GetAsync("api/universidad/llenaruniversidades");
						universidades = await Http.GetFromJsonAsync<List<Universidad>>("api/universidad/" + paisId) ?? new List<Universidad>();
					}
					catch { }
				}
				await JS.InvokeVoidAsync("console.log", new { tag = "CargarUniversidades", paisId, universidadesCount = universidades?.Count ?? 0 });
			}
			catch (Exception ex)
			{
				await JS.InvokeVoidAsync("console.log", new { tag = "CargarUniversidades-Error", message = ex.Message });
				universidades = new();
			}
		}
		else
		{
			universidades = new();
		}
		// await JS.InvokeVoidAsync("select2interop.refresh", "#pais_uni");
		// await JS.InvokeVoidAsync("select2interop.refresh", "#nombre_uni");
	}

	async Task CargarUniversidadesPeruanas()
	{		
        var peruselect = paises.FirstOrDefault(p => NombreEsPeru(p.Nombre));
		universidadesperuanas = await Http.GetFromJsonAsync<List<Universidad>>($"api/universidad/{peruselect.Id}");
		// universidadesperuanas = await PaisUniversidadesService.ObtenerUniversidadesAsync(peruselect.Id);
	}

	private async Task OnLoadProvincias(string selected)
	{
		formData.DepartamentoNacimiento = selected;
		provincias = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>($"api/MatUbigeo/provincias/{selected}");
	}
	private async Task OnLoadProvinciasdm(string selected)
	{
		formData.DepartamentoDomicilio = selected;
		provinciasdm = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>($"api/MatUbigeo/provincias/{selected}");
	}
	private async Task OnLoadDistritos(string selected)
	{
		formData.ProvinciaNacimiento = selected;
		distritos = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>($"api/MatUbigeo/distritos/{formData.DepartamentoNacimiento}/{selected}");
	}
	private async Task OnLoadDistritosdm(string selected)
	{
		formData.ProvinciaDomicilio = selected;
		distritosdm = await Http.GetFromJsonAsync<List<Mat_Ubigeo>>($"api/MatUbigeo/distritos/{formData.DepartamentoDomicilio}/{selected}");
	}
	public class SelectListItem
	{
		public string Value { get; set; }
		public string Text { get; set; }
	}

	private async Task<FormData> MapPersonaToFormDataAsync(Persona persona)
	{
		var form = new FormData
		{
			PersonaId	=	persona.Id,
			ConsejoRegional = persona.ConsejoRegionalId,
			Nombres = persona.Nombres,
			ApellidoPaterno = persona.ApellidoPaterno,
			ApellidoMaterno = persona.ApellidoMaterno,
			EstadoCivil = persona.EstadoCivilId,
			TipoDocumento = persona.TipoDocumentoId,
			NumeroDocumento = persona.NumeroDocumento,
			GrupoSanguineo = persona.GrupoSanguineoId.ToString(),
			FechaNacimiento = persona.FechaNacimiento.GetValueOrDefault(),
			PaisNacimiento = string.IsNullOrEmpty(persona.PaisNacimientoId) ? "173" : persona.PaisNacimientoId,
			DepartamentoNacimiento = persona.DepartamentoNacimientoId,
			ProvinciaNacimiento = persona.ProvinciaNacimientoId,
			DistritoNacimiento = persona.DistritoNacimientoId,
			Telefono = persona.Telefono,
			Celular = persona.Celular,
			Email = persona.Email,
			ZonaDomicilio = persona.ZonaDomicilioId,
			DescripcionZona = persona.DescripcionZona,
			ViaDomicilio = persona.ViaDomicilioId,
			DescripcionVia = persona.DescripcionVia,
			DepartamentoDomicilio = persona.DepartamentoDomicilioId,
			ProvinciaDomicilio = persona.ProvinciaDomicilioId,
			DistritoDomicilio = persona.DistritoDomicilioId,
			AceptaPoliticas = persona.AceptaPoliticas,
			FotoMedico = persona.FotoMedico
		};

		// Cargar combos relacionados
		if (!string.IsNullOrEmpty(persona.DepartamentoNacimientoId))
			await OnLoadProvincias(persona.DepartamentoNacimientoId);

		if (!string.IsNullOrEmpty(persona.ProvinciaNacimientoId))
			await OnLoadDistritos(persona.ProvinciaNacimientoId);

		if (!string.IsNullOrEmpty(persona.DepartamentoDomicilioId))
			await OnLoadProvinciasdm(persona.DepartamentoDomicilioId);

		if (!string.IsNullOrEmpty(persona.ProvinciaDomicilioId))
			await OnLoadDistritosdm(persona.ProvinciaDomicilioId);

		if (persona.FechaNacimiento != null)
		{
			formData.FechaNacimiento = persona.FechaNacimiento.Value;
		}
		else
		{
			var fechaPorDefecto = new DateTime(1990, 1, 1);
			formData.FechaNacimiento =  MaxFechaNacimiento;
		}
		
		return form;
	}


	private Persona MapFormDataToPersona(FormData formData)
	{
		return new Persona
		{
			Id = int.Parse(PersonaId),
			ConsejoRegionalId = formData.ConsejoRegional,
			Nombres = formData.Nombres?.Trim(),
			ApellidoPaterno = formData.ApellidoPaterno?.Trim(),
			ApellidoMaterno = formData.ApellidoMaterno?.Trim(),
			EstadoCivilId = formData.EstadoCivil,
			TipoDocumentoId = formData.TipoDocumento,
			NumeroDocumento = formData.NumeroDocumento?.Trim(),
			GrupoSanguineoId = int.Parse(formData.GrupoSanguineo),
			PaisNacimientoId = formData.PaisNacimiento,
			DepartamentoNacimientoId = formData.DepartamentoNacimiento,
			ProvinciaNacimientoId = formData.ProvinciaNacimiento,
			DistritoNacimientoId = formData.DistritoNacimiento,
			FechaNacimiento = formData.FechaNacimiento, // Nullable a Nullable: correcto
			ZonaDomicilioId = formData.ZonaDomicilio,
			DescripcionZona = formData.DescripcionZona?.Trim(),
			ViaDomicilioId = formData.ViaDomicilio,
			DescripcionVia = formData.DescripcionVia?.Trim(),
			DepartamentoDomicilioId = formData.DepartamentoDomicilio,
			ProvinciaDomicilioId = formData.ProvinciaDomicilio,
			DistritoDomicilioId = formData.DistritoDomicilio,
			Telefono = formData.Telefono?.Trim(),
			Celular = formData.Celular?.Trim(),
			Email = formData.Email?.Trim().ToLower(),
			AceptaPoliticas = formData.AceptaPoliticas,
			FotoMedico = formData.FotoMedico
		};
	}


	private async Task HandleValidSubmit()
	{
		try
		{
			intentadoEnviar = true;
			
			// Si la DDJJ ya est√° firmada con ID PER√ö y no hay cambios pendientes, avanzar directamente al paso 4
			if (tieneDDJJFirmadaEnServidor && SolicitudId > 0 && !esCorreccionPorObservacion)
			{
				// Verificar si hay archivos nuevos o cambios pendientes
				bool hayArchivosNuevos = _fileBuffers.Count > 0 || fotoFile != null || (_fotoBuffer != null && _fotoBuffer.Length > 0);
				
				if (!hayArchivosNuevos)
				{
					// No hay cambios pendientes, avanzar directamente al paso 4
					estadoActual = "Pendiente de pago";
					currentStep = 4;
					StateHasChanged();
					
					await JS.InvokeVoidAsync("Swal.fire", new
					{
						title = "Continuar al Pago",
						text = "La DDJJ ya est√° validada con ID PER√ö y los datos est√°n guardados. Puede continuar con el pago.",
						icon = "success",
						confirmButtonText = "Continuar"
					});
					return;
				}
				else
				{
					// Hay archivos nuevos, guardarlos primero
					await JS.InvokeVoidAsync("Swal.fire", new
					{
						title = "Guardando cambios",
						text = "Se detectaron archivos nuevos. Guardando cambios antes de continuar...",
						icon = "info",
						timer = 2000,
						showConfirmButton = false
					});
				}
			}
			
			// DDJJ solo es obligatoria si NO viene de observaci√≥n
			if (!esCorreccionPorObservacion)
			{
				ddjjValida = aceptaDDJJ;
				if (!ddjjValida)
				{
					mensajeError = "Debe aceptar la Declaraci√≥n Jurada para continuar.";
					return;
				}
			}

			// Validaci√≥n b√°sica de archivos: foto requerida si no hay en servidor ni en formulario
			if (!TieneFotoEnServidorOBuffer())
			{
				mostrarErrorFoto = true;
				mensajeError = "Debe seleccionar una foto v√°lida";
				return;
			}
			var tieneCarnetEnFormulario = _fileBuffers.ContainsKey("CarnetExtranjeria") || (pdfCarnetExtranjeria != null || formData.CarnetExtranjeriaPath != null);
			if (formData.TipoDocumento == "64" && !tieneCarnetEnServidor && !tieneCarnetEnFormulario)
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Debe cargar el PDF escaneado del Carnet de Extranjer√≠a (ambas caras).", icon = "warning" });
				return;
			}
			// Universidad: requerida solo si origen Nacional; si Extranjera se usa NombreUniversidadExtranjera
			if (formData.UniversidadOrigen == "1" && string.IsNullOrWhiteSpace(formData.Universidad))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Universidad.", icon = "warning" });
				return;
			}
			if (formData.UniversidadOrigen == "0" && string.IsNullOrWhiteSpace(formData.NombreUniversidadExtranjera))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Ingrese el nombre de la Universidad extranjera.", icon = "warning" });
				return;
			}
			if (formData.FechaEmisionTitulo == default(DateTime))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la fecha de titulaci√≥n.", icon = "warning" });
				return;
			}

			var esExtranjero = formData.UniversidadOrigen == "0" || formData.TipoDocumento == "64";
			if (esExtranjero && !string.IsNullOrWhiteSpace(formData.TipoValidacion))
			{
				if (formData.TipoValidacion == "reconocimiento")
				{
					var tieneConstanciaRecon = TieneDocEnServidorOBuffer("ConstanciaInscripcionReconocimientoSunedu");
					var tieneReconocimiento = TieneDocEnServidorOBuffer("ReconocimientoSunedu");
					if (!tieneConstanciaRecon || !tieneReconocimiento)
					{
						await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Debe cargar la Constancia de Inscripci√≥n Reconocimiento Sunedu y el Reconocimiento Sunedu (PDF).", icon = "warning" });
						return;
					}
					if (!formData.FechaReconocimiento.HasValue)
					{
						await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Fecha de reconocimiento.", icon = "warning" });
						return;
					}
				}
				else if (formData.TipoValidacion == "revalidacion")
				{
					var tieneConstanciaRev = TieneDocEnServidorOBuffer("ConstanciaInscripcionRevalidacionUniversidadNacional");
					var tieneRevalidacion = TieneDocEnServidorOBuffer("RevalidacionUniversidadNacional");
					if (!tieneConstanciaRev || !tieneRevalidacion)
					{
						await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Debe cargar la Constancia de Inscripci√≥n Revalidaci√≥n y la Revalidaci√≥n Universidad Nacional (PDF).", icon = "warning" });
						return;
					}
					if (string.IsNullOrWhiteSpace(formData.UniversidadPeruana))
					{
						await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Universidad Peruana.", icon = "warning" });
						return;
					}
					if (!formData.FechaRevalidacion.HasValue)
					{
						await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Fecha de revalidaci√≥n.", icon = "warning" });
						return;
					}
				}
			}

			// Mapeo a modelos
			var persona = MapFormDataToPersona(formData);
			var educacion = new Educacion
				{
					UniversidadOrigen=formData.UniversidadOrigen,
					UniversidadId = int.TryParse(formData.Universidad, out var uId) ? uId : 0,
					FechaEmisionTitulo = formData.FechaEmisionTitulo,
					PaisUniversidadId = int.TryParse(formData.PaisUniversidad, out var paisId) ? paisId : 0,
					TipoValidacion = formData.TipoValidacion,
					NumeroResolucion = formData.NumeroResolucion?.Trim(),
					UniversidadPeruanaId = int.TryParse(formData.UniversidadPeruana, out var uniId) ? uniId : null,
					NombreUniversidadExtranjera= formData.NombreUniversidadExtranjera?.Trim(),
					FechaReconocimiento = formData.FechaReconocimiento,
					FechaRevalidacion = formData.FechaRevalidacion
				};
			// Serializar objetos a JSON
			string personaJson = JsonSerializer.Serialize(persona);
			string educacionJson = JsonSerializer.Serialize(educacion);

			// Crear contenido multipart
			using var content = new MultipartFormDataContent();

			// Agregar datos JSON
			content.Add(new StringContent(personaJson), "Persona");
			content.Add(new StringContent(educacionJson), "Educacion");
			// Agregar datos de DDJJ (el backend debe registrar fecha/hora e IP del request)
			var ddjj = new
			{
				Aceptada = true,
				PersonaId,
				Version = ddjjVersion,
				Texto = ddjjTexto,
				AceptadaEnClienteUtc = DateTime.UtcNow
			};
			string ddjjJson = JsonSerializer.Serialize(ddjj);
			content.Add(new StringContent(ddjjJson), "DDJJ");

			// Agregar archivos desde buffers (evita _blazorFilesById null al enviar)
			AddFotoFromBufferIfPresent(content);

			// 3.3 PDF comunes (nacionales y extranjeros)
			AddPdfFromBufferIfPresent(content, "TituloMedicoCirujano");
			AddPdfFromBufferIfPresent(content, "ConstanciaInscripcionSunedu");
			AddPdfFromBufferIfPresent(content, "CertificadoAntecedentesPenales");

			// 3.4 PDF solo‚Äëextranjeros (Carnet tambi√©n cuando tipo doc = 64)
			if (formData.UniversidadOrigen == "0" || formData.TipoDocumento == "64")
				AddPdfFromBufferIfPresent(content, "CarnetExtranjeria");
			if (formData.UniversidadOrigen == "0")
			{
				if (formData.TipoValidacion == "reconocimiento")
				{
					AddPdfFromBufferIfPresent(content, "ConstanciaInscripcionReconocimientoSunedu");
					AddPdfFromBufferIfPresent(content, "ReconocimientoSunedu");
				}
				else if (formData.TipoValidacion == "revalidacion")
				{
					AddPdfFromBufferIfPresent(content, "ConstanciaInscripcionRevalidacionUniversidadNacional");
					AddPdfFromBufferIfPresent(content, "RevalidacionUniversidadNacional");
				}
				AddPdfFromBufferIfPresent(content, "ResolucionFile");
			}

			// Realizar petici√≥n HTTP
			// Determinar endpoint seg√∫n sea creaci√≥n o edici√≥n
			var endpoint = SolicitudId > 0
				? $"api/matricula/editar/{SolicitudId}"
				: "api/matricula/guardar";

			var response = await Http.PostAsync(endpoint, content);
			//var response = await Http.PostAsync("api/matricula/guardar", content);

			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<ResponseModel>();

				if (result?.Success == true)
				{
					string mensajeExito = result?.Message ?? "Operaci√≥n completada exitosamente";
					string tituloExito = "√âxito";
					bool esActualizacionPorObservacion = SolicitudId > 0 && (estadoIdActual == 3 || estadoIdActual == 5 || estadoIdActual == 7);
					bool esCompletandoFormulario = SolicitudId > 0 && estadoIdActual == -1; // Viene de curso completado
					
					// Determinar mensaje seg√∫n el contexto
					if (esActualizacionPorObservacion)
					{
						// Viene de una observaci√≥n (estado rechazado)
						tituloExito = "Solicitud Actualizada";
						mensajeExito = "Solicitud actualizada exitosamente. Ahora debe regresar al listado de solicitudes y hacer clic en el bot√≥n 'Reenviar' para continuar con el proceso.";
					}
					else if (esCompletandoFormulario || SolicitudId > 0)
					{
						// Completando paso 3: datos guardados. NO se actualiza a Registrado;
						// el estado Registrado se asigna al verificar el pago (paso 4).
						tituloExito = "Datos guardados";
						mensajeExito = "Sus datos se han guardado correctamente. Contin√∫e con el pago en el siguiente paso.";
						
						if (currentStep == 3)
						{
							estadoActual = "Pendiente de pago";
							currentStep = 4;
							if (SolicitudId > 0)
							{
								try { await JS.InvokeVoidAsync("premaSetPaso4", SolicitudId); } catch { }
								try { await JS.InvokeVoidAsync("premaSetPoliticasDDJJ", SolicitudId); } catch { }
							}
							StateHasChanged();
						}
						else
						{
							await DeterminarPasoInicial();
							if (currentStep == 3)
							{
								currentStep = 4;
								estadoActual = "Pendiente de pago";
								if (SolicitudId > 0)
								{
									try { await JS.InvokeVoidAsync("premaSetPaso4", SolicitudId); } catch { }
									try { await JS.InvokeVoidAsync("premaSetPoliticasDDJJ", SolicitudId); } catch { }
								}
								StateHasChanged();
							}
						}
					}
					
                    await JS.InvokeVoidAsync("Swal.fire", new
                    {
                        title = tituloExito,
                        text = mensajeExito,
                        icon = "success",
                        confirmButtonText = esActualizacionPorObservacion ? "Ir al listado" : "Aceptar"
                    });

                    if (SolicitudId == 0)
                    {
                        LimpiarFormulario();
						aceptaDDJJ = false; // finalizar marcado DDJJ tras completar proceso
                    }

                    // Solo redirigir si es actualizaci√≥n por observaci√≥n
                    if (esActualizacionPorObservacion)
                    {
                        Navigation.NavigateTo("/solicitudes/seguimiento", forceLoad: true);
                    }
				}
				else
				{
					await JS.InvokeVoidAsync("Swal.fire", new
					{
						title = "Error",
						text = result?.Message ?? "Ocurri√≥ un error al guardar los datos",
						icon = "error"
					});
				}
			}
			else
			{
				var errorContent = await response.Content.ReadAsStringAsync();
				var errorMessage = $"Error: {response.StatusCode}";

				try
				{
					// Intentar deserializar el error como un objeto { message }
					var errorObj = JsonSerializer.Deserialize<ResponseModel>(errorContent);
					if (!string.IsNullOrEmpty(errorObj?.Message))
					{
						errorMessage = errorObj.Message;
					}
				}
				catch
				{
					// Si no se puede deserializar, usar el contenido como texto plano
					if (!string.IsNullOrEmpty(errorContent))
					{
						errorMessage += $" - {errorContent}";
					}
				}

				await JS.InvokeVoidAsync("Swal.fire", new
				{
					title = "Error",
					text = errorMessage,
					icon = "error"
				});
			}
		}
		catch (Exception ex)
		{
			mensajeError = $"Error inesperado: {ex.Message}";
			Console.WriteLine($"Error en HandleSubmit: {ex}");
		}
		finally
		{
			enviando = false;
			StateHasChanged();
		}
	}

	private void AbrirPoliticasModal()
	{
		mostrarPoliticasModal = true;
	}

	/// <summary>
	/// Maneja el cambio del checkbox de pol√≠ticas y lo persiste en BD
	/// </summary>
	private async Task OnTogglePoliticas(ChangeEventArgs e)
	{
		var aceptado = e?.Value is bool b && b;
		formData.AceptaPoliticas = aceptado;
		
		// Solo guardar en BD si hay solicitud y se est√° aceptando
		if (aceptado && SolicitudId > 0 && !tienePoliticasAceptadasEnServidor)
		{
			try
			{
				var response = await Http.PostAsync($"api/DDJJ/aceptar-politicas/{SolicitudId}", null);
				if (response.IsSuccessStatusCode)
				{
					tienePoliticasAceptadasEnServidor = true;
					StateHasChanged();
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error al guardar pol√≠ticas: {ex.Message}");
				// No bloquear el flujo si falla
			}
		}
	}

	private async Task OnToggleDDJJ(ChangeEventArgs e)
	{
		if (!ddjjFirmada)
		{
			ActualizarDdjjPdfUrl();
			mostrarDDJJModal = true;
			StateHasChanged();
			return;
		}

		aceptaDDJJ = e?.Value is bool b && b;
		ddjjValida = aceptaDDJJ;
	}

	private void OnLabelDDJJClick()
	{
		if (!ddjjFirmada)
		{
			ActualizarDdjjPdfUrl();
			mostrarDDJJModal = true;
		}
	}

	private void CancelarFirmaDDJJ()
	{
		mostrarDDJJModal = false;
	}

	private async Task IniciarFirmaIdPeru()
	{
		ddjjFirmaEnProceso = true;
		StateHasChanged();

		try
		{
			// Si hay SolicitudId, guardar autom√°ticamente los datos del paso 3 antes de ir a ID PER√ö
			// Esto asegura que al retornar, los datos est√©n persistidos
			if (SolicitudId > 0)
			{
				var guardadoExitoso = await GuardarDatosPaso3Automatico();
				if (!guardadoExitoso)
				{
					// Si falla el guardado, preguntar si quiere continuar
					var continuar = await JS.InvokeAsync<bool>("confirm", 
						"Error al guardar datos", 
						"No se pudieron guardar los datos del formulario. ¬øDesea continuar con la validaci√≥n ID PER√ö de todos modos?");
					if (!continuar)
					{
						ddjjFirmaEnProceso = false;
						StateHasChanged();
						return;
					}
				}
			}

			// Iniciar flujo de firma con ID PER√ö (redirecci√≥n completa)
			// Asegurar que el returnUrl siempre incluya el SolicitudId
			var returnUrl = Navigation.Uri;
			if (SolicitudId > 0 && !returnUrl.Contains($"/prematricula/{SolicitudId}"))
			{
				// Si la URL no tiene el SolicitudId, agregarlo
				if (returnUrl.EndsWith("/solicitudes/prematricula") || returnUrl.EndsWith("/solicitudes/prematricula/"))
				{
					returnUrl = $"{returnUrl.TrimEnd('/')}/{SolicitudId}";
				}
				else
				{
					// Si tiene query params, insertar el ID antes de los params
					var uri = new Uri(returnUrl);
					var path = uri.GetLeftPart(UriPartial.Path);
					if (!path.Contains($"/prematricula/{SolicitudId}"))
					{
						path = path.TrimEnd('/');
						if (path.EndsWith("/prematricula"))
						{
							path = $"{path}/{SolicitudId}";
						}
						returnUrl = path + uri.Query;
					}
				}
			}
			var url = $"api/DDJJ/firmar?returnUrl={Uri.EscapeDataString(returnUrl)}";
			Navigation.NavigateTo(url, true);
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Error", 
				text = $"Error al iniciar firma: {ex.Message}", 
				icon = "error" 
			});
			ddjjFirmaEnProceso = false;
			StateHasChanged();
		}
	}

	/// <summary>
	/// Guarda autom√°ticamente los datos del paso 3 sin validar DDJJ (para persistir antes de ID PER√ö)
	/// </summary>
	private async Task<bool> GuardarDatosPaso3Automatico()
	{
		try
		{
			// Validaciones b√°sicas (sin DDJJ)
			if (!TieneFotoEnServidorOBuffer())
			{
				// Foto es opcional para guardado autom√°tico, solo loguear
				Console.WriteLine("[AutoGuardado] Advertencia: No hay foto cargada");
			}

			// Mapeo a modelos
			var persona = MapFormDataToPersona(formData);
			var educacion = new Educacion
			{
				UniversidadOrigen = formData.UniversidadOrigen,
				UniversidadId = int.TryParse(formData.Universidad, out var uId) ? uId : 0,
				FechaEmisionTitulo = formData.FechaEmisionTitulo,
				PaisUniversidadId = int.TryParse(formData.PaisUniversidad, out var paisId) ? paisId : 0,
				TipoValidacion = formData.TipoValidacion,
				NumeroResolucion = formData.NumeroResolucion?.Trim(),
				UniversidadPeruanaId = int.TryParse(formData.UniversidadPeruana, out var uniId) ? uniId : null,
				NombreUniversidadExtranjera = formData.NombreUniversidadExtranjera?.Trim(),
				FechaReconocimiento = formData.FechaReconocimiento,
				FechaRevalidacion = formData.FechaRevalidacion
			};

			// Serializar objetos a JSON
			string personaJson = JsonSerializer.Serialize(persona);
			string educacionJson = JsonSerializer.Serialize(educacion);

			// Crear contenido multipart
			using var content = new MultipartFormDataContent();

			// Agregar datos JSON
			content.Add(new StringContent(personaJson), "Persona");
			content.Add(new StringContent(educacionJson), "Educacion");
			
			// Agregar datos de DDJJ (sin validar, solo para guardar)
			var ddjj = new
			{
				Aceptada = aceptaDDJJ, // Usar el valor actual
				PersonaId,
				Version = ddjjVersion,
				Texto = ddjjTexto,
				AceptadaEnClienteUtc = DateTime.UtcNow
			};
			string ddjjJson = JsonSerializer.Serialize(ddjj);
			content.Add(new StringContent(ddjjJson), "DDJJ");

			// Agregar archivos desde buffers
			AddFotoFromBufferIfPresent(content);
			AddPdfFromBufferIfPresent(content, "TituloMedicoCirujano");
			AddPdfFromBufferIfPresent(content, "ConstanciaInscripcionSunedu");
			AddPdfFromBufferIfPresent(content, "CertificadoAntecedentesPenales");

			// PDF solo-extranjeros
			if (formData.UniversidadOrigen == "0" || formData.TipoDocumento == "64")
				AddPdfFromBufferIfPresent(content, "CarnetExtranjeria");
			if (formData.UniversidadOrigen == "0")
			{
				if (formData.TipoValidacion == "reconocimiento")
				{
					AddPdfFromBufferIfPresent(content, "ConstanciaInscripcionReconocimientoSunedu");
					AddPdfFromBufferIfPresent(content, "ReconocimientoSunedu");
				}
				else if (formData.TipoValidacion == "revalidacion")
				{
					AddPdfFromBufferIfPresent(content, "ConstanciaInscripcionRevalidacionUniversidadNacional");
					AddPdfFromBufferIfPresent(content, "RevalidacionUniversidadNacional");
				}
				AddPdfFromBufferIfPresent(content, "ResolucionFile");
			}

			// Guardar usando endpoint de edici√≥n
			var response = await Http.PostAsync($"api/matricula/editar/{SolicitudId}", content);

			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<ResponseModel>();
				if (result?.Success == true)
				{
					Console.WriteLine("[AutoGuardado] Datos guardados exitosamente antes de ID PER√ö");
					return true;
				}
			}

			var errorContent = await response.Content.ReadAsStringAsync();
			Console.WriteLine($"[AutoGuardado] Error al guardar: {errorContent}");
			return false;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"[AutoGuardado] Excepci√≥n: {ex.Message}");
			return false;
		}
	}

	private async Task SimularFirmaIdPeru()
	{
		try
		{
			ddjjFirmaEnProceso = true;
			StateHasChanged();

			// Simular delay de proceso de firma
			await Task.Delay(1500);

			// Marcar como firmada exitosamente
			ddjjFirmada = true;
			aceptaDDJJ = true;
			ddjjValida = true;
			ddjjFirmaEnProceso = false;
			mostrarDDJJModal = false;

			// Mostrar mensaje de √©xito
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Simulaci√≥n Exitosa", 
				text = "DDJJ firmada correctamente (modo testing). Ahora puede enviar la solicitud.", 
				icon = "success",
				timer = 2500,
				showConfirmButton = false
			});

			StateHasChanged();
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Error", text = ex.Message, icon = "error" });
			ddjjFirmaEnProceso = false;
			StateHasChanged();
		}
	}

	/// <summary>
	/// Descarga el PDF de DDJJ firmada con ID Per√∫
	/// </summary>
	private async Task DescargarDDJJFirmada()
	{
		if (SolicitudId <= 0) return;
		
		try
		{
			var url = $"api/DDJJ/descargar-firmada/{SolicitudId}";
			await JS.InvokeVoidAsync("open", url, "_blank");
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Error", 
				text = $"No se pudo descargar la DDJJ: {ex.Message}", 
				icon = "error" 
			});
		}
	}

	private async Task SimularCursoCompletado()
	{
		try
		{
			verificandoCurso = true;
			StateHasChanged();

			// Simular delay de verificaci√≥n
			await Task.Delay(1000);

			// Llamar al endpoint para marcar como completado en BD
			var response = await Http.PostAsync($"api/aulavirtual/marcar-completado/{SolicitudId}", null);
			
			if (response.IsSuccessStatusCode)
			{
				// Marcar curso como completado localmente
				cursoEticaCompletado = true;
				estadoActual = "Curso completado (simulado)";
				avanceCursoDetalle = "‚úì Curso aprobado (100%) - SIMULADO";
				currentStep = 3;

				await JS.InvokeVoidAsync("Swal.fire", new 
				{ 
					title = "Simulaci√≥n Exitosa", 
					text = "Curso marcado como completado en la base de datos (modo desarrollo). Ahora puede continuar al paso 3.", 
					icon = "success",
					timer = 2500,
					showConfirmButton = false
				});
			}
			else
			{
				var errorMsg = await response.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new 
				{ 
					title = "Error", 
					text = $"No se pudo marcar el curso como completado: {errorMsg}", 
					icon = "error" 
				});
			}

			verificandoCurso = false;
			StateHasChanged();
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Error", text = ex.Message, icon = "error" });
			verificandoCurso = false;
			StateHasChanged();
		}
	}

	private void DescargarDDJJ()
	{
		// Construir URL de descarga dedicada (sin afectar la vista previa inline)
		var tipo = formData?.TipoDocumento ?? "";
		var doc = formData?.NumeroDocumento ?? "";
		var nombres = (formData?.Nombres ?? "").Trim();
		var apellidos = $"{(formData?.ApellidoPaterno ?? "").Trim()} {(formData?.ApellidoMaterno ?? "").Trim()}".Trim();

		var url = $"api/DDJJ/download?nombre={Uri.EscapeDataString(nombres)}&apellidos={Uri.EscapeDataString(apellidos)}&tipoDoc={Uri.EscapeDataString(tipo)}&numeroDoc={Uri.EscapeDataString(doc)}&version={Uri.EscapeDataString(ddjjVersion)}";
		// Descargar en la misma pesta√±a para evitar pausar el depurador en una nueva
		Navigation.NavigateTo(url, true);
	}

	private void ActualizarDdjjPdfUrl()
	{
		var tipo = formData?.TipoDocumento ?? "";
		var doc = formData?.NumeroDocumento ?? "";
		var nombres = (formData?.Nombres ?? "").Trim();
		var apellidos = $"{(formData?.ApellidoPaterno ?? "").Trim()} {(formData?.ApellidoMaterno ?? "").Trim()}".Trim();
		ddjjPdfUrl = $"api/DDJJ/preview?nombre={Uri.EscapeDataString(nombres)}&apellidos={Uri.EscapeDataString(apellidos)}&tipoDoc={Uri.EscapeDataString(tipo)}&numeroDoc={Uri.EscapeDataString(doc)}&version={Uri.EscapeDataString(ddjjVersion)}";
	}
 
	void AddPdfFromBufferIfPresent(MultipartFormDataContent content, string formFieldName)
	{
		if (!_fileBuffers.TryGetValue(formFieldName, out var buf)) return;
		var bytes = buf.Bytes;
		var fileName = buf.FileName;
		if (bytes == null || bytes.Length == 0) return;
		var byteContent = new ByteArrayContent(bytes);
		byteContent.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");
		content.Add(byteContent, formFieldName, fileName);
	}

	void AddFotoFromBufferIfPresent(MultipartFormDataContent content)
	{
		if (_fotoBuffer == null || _fotoBuffer.Length == 0 || string.IsNullOrEmpty(_fotoFileName)) return;
		var byteContent = new ByteArrayContent(_fotoBuffer);
		byteContent.Headers.ContentType = new MediaTypeHeaderValue(_fotoContentType ?? "image/jpeg");
		content.Add(byteContent, "Foto", _fotoFileName);
	}

	static string? GetJsonString(JsonElement el, string camel, string pascal)
	{
		if (el.TryGetProperty(camel, out var a)) return a.GetString();
		if (el.TryGetProperty(pascal, out var b)) return b.GetString();
		return null;
	}

	void SetDocServidor(string key, string? path)
	{
		if (string.IsNullOrWhiteSpace(path)) return;
		_documentosCargadosServidor[key] = path;
	}

	string TextoArchivo(string bufferKey, IBrowserFile? pdfFile, string label)
	{
		if (pdfFile != null) return pdfFile.Name;
		if (_fileBuffers.TryGetValue(bufferKey, out var b)) return b.FileName;
		if (_documentosCargadosServidor.TryGetValue(bufferKey, out var path))
			return "Archivo cargado: " + Path.GetFileName(path);
		return "Seleccione " + label;
	}

	string TextoFoto()
	{
		if (fotoFile != null) return fotoFile.Name;
		if (!string.IsNullOrEmpty(_fotoFileName)) return _fotoFileName;
		if (_documentosCargadosServidor.TryGetValue("Foto", out var path))
			return "Archivo cargado: " + Path.GetFileName(path);
		return "Seleccione foto";
	}

	bool TieneDocEnServidorOBuffer(string bufferKey)
	{
		if (_fileBuffers.ContainsKey(bufferKey)) return true;
		return _documentosCargadosServidor.ContainsKey(bufferKey);
	}

	bool TieneFotoEnServidorOBuffer()
	{
		if (fotoFile != null || (_fotoBuffer != null && _fotoBuffer.Length > 0)) return true;
		return _documentosCargadosServidor.ContainsKey("Foto");
	}

	private void LimpiarFormulario()
	{
		formData = new FormData();

		fotoFile = null;
		_fotoBuffer = null;
		_fotoFileName = null;
		_fotoContentType = null;
		_fileBuffers.Clear();
		_documentosCargadosServidor.Clear();
		resolucionFile = null;
		pdfTituloMedicoCirujano = null;
		pdfConstanciaInscripcionSunedu = null;
		pdfCertificadoAntecedentesPenales = null;
		pdfCarnetExtranjeria = null;
		pdfConstanciaInscripcionReconocimientoSunedu = null;
		pdfReconocimientoSunedu = null;
		pdfConstanciaInscripcionRevalidacionUniversidadNacional = null;
		pdfRevalidacionUniversidadNacional = null;
		imagePreviewUrl = null;
		mensajeError = string.Empty;
		mensajeValidacion = string.Empty;
		mostrarErrorFoto = false;

		StateHasChanged();
	}

	public class ResponseModel
	{
		public bool Success { get; set; }
		public string? Message { get; set; }
	}
	// Clase para manejar la respuesta
	public class ApiResponse
	{
		public string message { get; set; }
	}

	private async Task OnResolucionSelected(InputFileChangeEventArgs e)
	{
		var file = e.File;
		resolucionFile = file;
		if (file != null)
		{
			try
			{
				await using var stream = file.OpenReadStream(maxAllowedSize: _pdfMaxBytes);
				using var ms = new MemoryStream();
				await stream.CopyToAsync(ms);
				_fileBuffers["ResolucionFile"] = (ms.ToArray(), file.Name);
			}
			catch
			{
				_fileBuffers.Remove("ResolucionFile");
			}
		}
		else
			_fileBuffers.Remove("ResolucionFile");
	}
		

	private string GetImageUrl(string imageName)
	{
		return $"/api/fotovalidator/reference-image/{imageName}";
	}

	private void ValidarFechaNacimiento()
	{
		if (formData.FechaNacimiento > MaxFechaNacimiento)
		{
			fechaInvalida = true;
			formData.FechaNacimiento = MaxFechaNacimiento; // Opcional: Corregir autom√°ticamente
		}
		else
		{
			fechaInvalida = false;
		}
	}

	// Manejador gen√©rico para archivos; bufferiza al seleccionar para evitar _blazorFilesById en submit.
	private async Task OnFileSelected(InputFileChangeEventArgs e, string propertyName)
	{
		var file = e.File;
		if (file == null) return;

		typeof(FormData).GetProperty(propertyName)?.SetValue(formData, file);

		var key = propertyName switch
		{
			nameof(formData.TituloMedicoCirujanoPath) => "TituloMedicoCirujano",
			nameof(formData.ConstanciaInscripcionSuneduPath) => "ConstanciaInscripcionSunedu",
			nameof(formData.CertificadoAntecedentesPenalesPath) => "CertificadoAntecedentesPenales",
			nameof(formData.CarnetExtranjeriaPath) => "CarnetExtranjeria",
			nameof(formData.ConstanciaInscripcionReconocimientoSuneduPath) => "ConstanciaInscripcionReconocimientoSunedu",
			nameof(formData.ReconocimientoSuneduPath) => "ReconocimientoSunedu",
			nameof(formData.ConstanciaInscripcionRevalidacionUniversidadNacionalPath) => "ConstanciaInscripcionRevalidacionUniversidadNacional",
			nameof(formData.RevalidacionUniversidadNacionalPath) => "RevalidacionUniversidadNacional",
			_ => null
		};

		if (!string.IsNullOrEmpty(key))
		{
			try
			{
				await using var stream = file.OpenReadStream(maxAllowedSize: _pdfMaxBytes);
				using var ms = new MemoryStream();
				await stream.CopyToAsync(ms);
				_fileBuffers[key] = (ms.ToArray(), file.Name);
			}
			catch
			{
				_fileBuffers.Remove(key);
			}
		}

		switch (propertyName)
		{
			case nameof(formData.TituloMedicoCirujanoPath): pdfTituloMedicoCirujano = file; break;
			case nameof(formData.ConstanciaInscripcionSuneduPath): pdfConstanciaInscripcionSunedu = file; break;
			case nameof(formData.CertificadoAntecedentesPenalesPath): pdfCertificadoAntecedentesPenales = file; break;
			case nameof(formData.CarnetExtranjeriaPath): pdfCarnetExtranjeria = file; break;
			case nameof(formData.ConstanciaInscripcionReconocimientoSuneduPath): pdfConstanciaInscripcionReconocimientoSunedu = file; break;
			case nameof(formData.ConstanciaInscripcionRevalidacionUniversidadNacionalPath): pdfConstanciaInscripcionRevalidacionUniversidadNacional = file; break;
			case nameof(formData.ReconocimientoSuneduPath): pdfReconocimientoSunedu = file; break;
			case nameof(formData.RevalidacionUniversidadNacionalPath): pdfRevalidacionUniversidadNacional = file; break;
		}
		StateHasChanged();
	}

	// Helpers Stepper
	private bool IsCompleted(int step)
	{
		// Un paso est√° completado si es menor al actual
		if (step < currentStep) return true;
		if (step == 2 && cursoEticaCompletado && currentStep >= 3) return true;
		if (step == 4 && pagoCompletado && currentStep >= 5) return true;
		return false;
	}

	private string StepClass(int step)
	{
		if (IsCompleted(step)) return "completed";
		if (step == currentStep) return "current";
		return "upcoming";
	}

	private bool ShouldShowCheck(int step)
	{
		// Mostrar check en pasos completados y en el paso actual
		if (step < currentStep) return true;
		if (step == currentStep) return true;
		if (step == 2 && cursoEticaCompletado && currentStep >= 3) return true;
		if (step == 4 && pagoCompletado && currentStep >= 5) return true;
		return false;
	}

	private string GetConsejoNombre(string? consejoId)
	{
		if (string.IsNullOrWhiteSpace(consejoId)) return "-";
		if (int.TryParse(consejoId, out var id))
		{
			var item = consejos?.FirstOrDefault(c => c.ConsejoRegional_Key == id);
			return item?.Nombre ?? "-";
		}
		return "-";
	}

	private bool EsConsejoInvalido()
	{
		if (!int.TryParse(Convert.ToString(formData.ConsejoRegional), out var consejoId))
			return true;
		return consejoId <= 0;
	}

	private string GetMaestroNombre(List<MaestroRegistro> lista, string? key)
	{
		if (lista == null || string.IsNullOrWhiteSpace(key)) return "-";
		// claves pueden ser string o int representado en string
		if (int.TryParse(key, out var kint))
		{
			var item = lista.FirstOrDefault(x => x.MaestroRegistro_Key == kint);
			return item?.Nombre ?? "-";
		}
		else
		{
			var item = lista.FirstOrDefault(x => x.MaestroRegistro_Key.ToString() == key);
			return item?.Nombre ?? "-";
		}
	}

	// Determina el paso a mostrar al cargar
	private async Task DeterminarPasoInicial()
	{
		if (SolicitudId <= 0)
		{
			currentStep = 1;
			return;
		}

		try
		{
			// Obtener la solicitud con su estado actual
			var response = await Http.GetAsync($"api/personaseducacion/solicituddet/{SolicitudId}");
			if (response.IsSuccessStatusCode)
			{
				var json = await response.Content.ReadAsStringAsync();
				using var doc = JsonDocument.Parse(json);
				var root = doc.RootElement;
				
				int estadoId = 0;
				if (root.TryGetProperty("estadoSolicitudId", out var estadoProp))
				{
					estadoId = estadoProp.GetInt32();
				}
				else if (root.TryGetProperty("EstadoSolicitudId", out var estadoProp2))
				{
					estadoId = estadoProp2.GetInt32();
				}

				// Guardar el estadoIdActual para detectar observaciones
				estadoIdActual = estadoId;
				
				// Determinar paso seg√∫n estado
				if (estadoId == 0)
				{
					// Estado 0: "Pendiente de curso √âtica" ‚Üí Paso 2
					currentStep = 2;
					cursoEticaCompletado = false;
					estadoActual = "Pendiente de curso √âtica";
				}
				else if (estadoId == -1)
				{
					// Estado -1: curso completado. Si ya envi√≥ paso 3 y est√° en pago ‚Üí Paso 4; si no ‚Üí Paso 3
					var yaEnPaso4 = "";
					try
					{
						yaEnPaso4 = await JS.InvokeAsync<string>("premaGetPaso4", SolicitudId) ?? "";
					}
					catch
					{
						// JS no disponible o error: quedarse en paso 3, no en 2
					}
					if (yaEnPaso4 == "1")
					{
						currentStep = 4;
						cursoEticaCompletado = true;
						estadoActual = "Pendiente de pago";
					}
					else
					{
						currentStep = 3;
						cursoEticaCompletado = true;
						estadoActual = "Curso completado, pendiente de documentos";
					}
				}
				else if (estadoId == 7)
				{
					// Estado de observaci√≥n (7 - Rechazado por Of. Matr√≠cula) ‚Üí Paso 3 para permitir correcci√≥n
					currentStep = 3;
					cursoEticaCompletado = true;
					estadoActual = "Con observaciones - Requiere correcci√≥n";
					// Cargar observaciones autom√°ticamente
					await ObtenerObservacionesSolicitud(SolicitudId);
					
					// En modo correcci√≥n, aceptar autom√°ticamente pol√≠ticas y DDJJ
					// para evitar validaciones innecesarias
					if (formData != null)
					{
						formData.AceptaPoliticas = true;
					}
					aceptaDDJJ = true;
					ddjjValida = true;
				}
				else if (estadoId == 3 || estadoId == 5)
				{
					// Estados 3 y 5 ya no se usan, pero si existen, mostrar solo resumen
					currentStep = 5;
					cursoEticaCompletado = true;
					pagoCompletado = true;
					estadoActual = "En proceso";
				}
				else if (estadoId == 1)
				{
					// Estado 1: Registrado. Solo se llega aqu√≠ tras pago (real o simulado).
					// Ir directo al paso 5; no usar VerificarEstadoPago (a√∫n en desarrollo).
					currentStep = 5;
					pagoCompletado = true;
					cursoEticaCompletado = true;
					estadoActual = "Registrado";
					try { await JS.InvokeVoidAsync("premaClearPaso4", SolicitudId); } catch { }
					try { await JS.InvokeVoidAsync("premaClearPoliticasDDJJ", SolicitudId); } catch { }
				}
				else if (estadoId > 1 && estadoId != 3 && estadoId != 5 && estadoId != 7 && estadoId != 6)
				{
					// Otros estados avanzados (2, 4, 6, etc.) ‚Üí Paso 5 (solo resumen)
					currentStep = 5;
					cursoEticaCompletado = true;
					pagoCompletado = true; // Asumir que si est√° en estado avanzado, ya pag√≥
					estadoActual = "En proceso";
				}
			}
			else
			{
				// Si falla la petici√≥n: con solicitud existente no enviar al paso 2
				if (SolicitudId > 0)
				{
					currentStep = 3;
					cursoEticaCompletado = true;
					estadoActual = "Curso completado, pendiente de documentos";
				}
				else
				{
					currentStep = 2;
					cursoEticaCompletado = false;
				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en DeterminarPasoInicial: {ex.Message}");
			if (SolicitudId > 0)
			{
				currentStep = 3;
				cursoEticaCompletado = true;
				estadoActual = "Curso completado, pendiente de documentos";
			}
			else
			{
				currentStep = 2;
				cursoEticaCompletado = false;
			}
		}
	}

	private async Task RestaurarPoliticasDDJJSiAplicaAsync()
	{
		if (SolicitudId <= 0 || currentStep != 3) return;
		try
		{
			var v = await JS.InvokeAsync<string>("premaGetPoliticasDDJJ", SolicitudId);
			if (v != "1") return;
			formData.AceptaPoliticas = true;
			aceptaDDJJ = true;
			ddjjValida = true;
		}
		catch { /* premaGetPoliticasDDJJ no disponible o error */ }
	}

	// Registro inicial m√≠nimo (consejo, datos personales y universidad)
	private async Task RegistrarInicialAsync()
	{
		try
		{
			isSavingInicial = true;
			mensajeError = string.Empty;
			intentadoEnviar = true; // Marcar que se intent√≥ enviar para mostrar errores

			// Validaciones de campos obligatorios (*)
			if (string.IsNullOrWhiteSpace(perfilSeleccionado))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione el perfil del solicitante", icon = "warning" });
				return;
			}
			int consejoRegionalId;
			if (!int.TryParse(Convert.ToString(formData.ConsejoRegional), out consejoRegionalId) || consejoRegionalId <= 0)
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione Consejo Regional", icon = "warning" });
				return;
			}
			if (string.IsNullOrWhiteSpace(formData.TipoDocumento) || string.IsNullOrWhiteSpace(formData.NumeroDocumento))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Ingrese Tipo y N√∫mero de Documento", icon = "warning" });
				return;
			}
			if (string.IsNullOrWhiteSpace(formData.GrupoSanguineo))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione Grupo Sangu√≠neo", icon = "warning" });
				return;
			}
			if (string.IsNullOrWhiteSpace(formData.Nombres) || string.IsNullOrWhiteSpace(formData.ApellidoPaterno) || string.IsNullOrWhiteSpace(formData.ApellidoMaterno))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Complete nombres y apellidos", icon = "warning" });
				return;
			}
			if (string.IsNullOrWhiteSpace(formData.Sexo))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione Sexo", icon = "warning" });
				return;
			}
			if (string.IsNullOrWhiteSpace(formData.EstadoCivil))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione Estado Civil", icon = "warning" });
				return;
			}
			if (string.IsNullOrWhiteSpace(formData.UniversidadOrigen) || string.IsNullOrWhiteSpace(formData.PaisUniversidad))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Complete los datos de universidad", icon = "warning" });
				return;
			}
			if (formData.UniversidadOrigen == "1" && string.IsNullOrWhiteSpace(formData.Universidad))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Universidad", icon = "warning" });
				return;
			}
			if (formData.UniversidadOrigen == "0" && string.IsNullOrWhiteSpace(formData.NombreUniversidadExtranjera))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Ingrese el nombre de la Universidad extranjera", icon = "warning" });
				return;
			}
			var tieneCarnetEnFormularioReg = _fileBuffers.ContainsKey("CarnetExtranjeria") || (pdfCarnetExtranjeria != null || formData.CarnetExtranjeriaPath != null);
			if (formData.TipoDocumento == "64" && !tieneCarnetEnServidor && !tieneCarnetEnFormularioReg)
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Debe cargar el PDF escaneado del Carnet de Extranjer√≠a (ambas caras).", icon = "warning" });
				return;
			}
			// Extranjero (universidad extranjera o Carnet): obligar Tipo de validaci√≥n
			var esExtranjero = formData.UniversidadOrigen == "0" || formData.TipoDocumento == "64";
			if (esExtranjero && string.IsNullOrWhiteSpace(formData.TipoValidacion))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione el Tipo de validaci√≥n (Reconocimiento de Sunedu o Revalidaci√≥n).", icon = "warning" });
				return;
			}
			if (formData.TipoValidacion == "reconocimiento")
			{
				if (string.IsNullOrWhiteSpace(formData.NumeroResolucion))
				{
					await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Ingrese la Resoluci√≥n de Reconocimiento Universidad Nacional.", icon = "warning" });
					return;
				}
			}
			if (formData.TipoValidacion == "revalidacion")
			{
				if (string.IsNullOrWhiteSpace(formData.NumeroResolucion))
				{
					await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Ingrese la Resoluci√≥n de Revalidaci√≥n Universidad Nacional.", icon = "warning" });
					return;
				}
				if (string.IsNullOrWhiteSpace(formData.UniversidadPeruana))
				{
					await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Universidad Peruana.", icon = "warning" });
					return;
				}
				if (!formData.FechaRevalidacion.HasValue)
				{
					await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Fecha de revalidaci√≥n.", icon = "warning" });
					return;
				}
			}
			if (formData.TipoValidacion == "reconocimiento" && !formData.FechaReconocimiento.HasValue)
			{
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Validaci√≥n", text = "Seleccione la Fecha de reconocimiento.", icon = "warning" });
				return;
			}

			var persona = MapFormDataToPersona(formData);
			var educacion = new Educacion
			{
				UniversidadOrigen = formData.UniversidadOrigen,
				UniversidadId = int.TryParse(formData.Universidad, out var uniId) ? uniId : 0,
				FechaEmisionTitulo = formData.FechaEmisionTitulo,
				PaisUniversidadId = int.TryParse(formData.PaisUniversidad, out var pId) ? pId : 0,
				TipoValidacion = formData.TipoValidacion,
				NumeroResolucion = formData.NumeroResolucion?.Trim(),
				UniversidadPeruanaId = int.TryParse(formData.UniversidadPeruana, out var uniPer) ? uniPer : null,
				NombreUniversidadExtranjera = formData.NombreUniversidadExtranjera?.Trim(),
				FechaReconocimiento = formData.FechaReconocimiento,
				FechaRevalidacion = formData.FechaRevalidacion
			};

		string personaJson = JsonSerializer.Serialize(persona);
		string educacionJson = JsonSerializer.Serialize(educacion);

		using var content = new MultipartFormDataContent();
		content.Add(new StringContent(personaJson), "Persona");
		content.Add(new StringContent(educacionJson), "Educacion");
		content.Add(new StringContent(perfilSeleccionado), "PerfilSeleccionado");
		if (formData.TipoDocumento == "64")
			AddPdfFromBufferIfPresent(content, "CarnetExtranjeria");

		// Si ya existe una solicitud, actualizarla en lugar de crear una nueva
			HttpResponseMessage response;
			if (SolicitudId > 0)
			{
				// Actualizar solicitud existente
				response = await Http.PostAsync($"api/matricula/editar/{SolicitudId}", content);
			}
			else
			{
				// Crear registro inicial en estado "Pendiente de curso √âtica"
				response = await Http.PostAsync("api/matricula/crear-inicial", content);
				if (!response.IsSuccessStatusCode)
				{
					// Fallback si a√∫n no existe el endpoint dedicado
					response = await Http.PostAsync("api/matricula/guardar?modo=inicial", content);
				}
			}

			var raw = await response.Content.ReadAsStringAsync();
			GuardarResponse? resp = null;
			try { resp = JsonSerializer.Deserialize<GuardarResponse>(raw, new JsonSerializerOptions { PropertyNameCaseInsensitive = true }); } catch { }

			// Verificar que la respuesta sea exitosa (tanto HTTP como en el body JSON)
			if (response.IsSuccessStatusCode && resp?.Success == true)
			{
				var newId = resp?.SolicitudId ?? resp?.Id ?? 0;
				var eraNuevaSolicitud = SolicitudId <= 0; // Guardar si era nueva antes de asignar el ID
				
				if (newId > 0 && eraNuevaSolicitud) 
				{
					SolicitudId = newId;
				}

				if (eraNuevaSolicitud)
				{
					// Creaci√≥n exitosa - avanzar al paso 2
					estadoActual = "Pendiente de curso √âtica";
					currentStep = 2;
					StateHasChanged(); // Forzar actualizaci√≥n de la UI
					await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro creado", text = "Se cre√≥ el registro inicial. Contin√∫e con el curso de √âtica.", icon = "success" });
				}
					else
					{
						// Actualizaci√≥n exitosa - avanzar al siguiente paso seg√∫n el paso actual
						var pasoAnterior = currentStep;
						
						// Avanzar al siguiente paso seg√∫n el paso actual
						switch (pasoAnterior)
						{
							case 1:
								currentStep = 2;
								estadoActual = "Pendiente de curso √âtica";
								StateHasChanged();
								await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente. Contin√∫e con el curso de √âtica.", icon = "success" });
								break;
							case 2:
								// Si el curso ya est√° completado, avanzar al paso 3
								if (cursoEticaCompletado)
								{
									currentStep = 3;
									estadoActual = "Curso completado, pendiente de documentos";
									StateHasChanged();
									await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente. Contin√∫e completando la solicitud.", icon = "success" });
								}
								else
								{
									await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente.", icon = "success" });
								}
								break;
							case 3:
								// Si se actualiza desde el paso 3, avanzar al paso 4 (pago)
								currentStep = 4;
								StateHasChanged();
								await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente. Contin√∫e con el pago.", icon = "success" });
								break;
							case 4:
								// Si se actualiza desde el paso 4 y el pago est√° completado, avanzar al paso 5
								if (pagoCompletado)
								{
									currentStep = 5;
									StateHasChanged();
									await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente.", icon = "success" });
								}
								else
								{
									await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente.", icon = "success" });
								}
								break;
							default:
								await JS.InvokeVoidAsync("Swal.fire", new { title = "Registro actualizado", text = "Los datos se actualizaron correctamente.", icon = "success" });
								break;
						}
					}
				return;
			}

			// Mostrar error con el mensaje del servidor
			var errorMessage = resp?.Message ?? raw;
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Error", text = string.IsNullOrWhiteSpace(errorMessage) ? (SolicitudId > 0 ? "No se pudo actualizar el registro" : "No se pudo crear el registro inicial") : errorMessage, icon = "error" });
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Error", text = ex.Message, icon = "error" });
		}
		finally
		{
			isSavingInicial = false;
			StateHasChanged();
		}
	}

	private async Task IrAlAulaVirtual()
	{
		if (SolicitudId <= 0)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Atenci√≥n", text = "Primero cree el registro inicial.", icon = "warning" });
			return;
		}

		try
		{
			abriendonAulaVirtual = true;
			StateHasChanged();

			// Autenticar con el Aula Virtual
			var loginResponse = await Http.PostAsync($"api/aulavirtual/autenticar?solicitudId={SolicitudId}", null);
			
			if (loginResponse.IsSuccessStatusCode)
			{
				var loginResult = await loginResponse.Content.ReadFromJsonAsync<AulaVirtualLoginResponse>();
				
				if (loginResult?.success == true && !string.IsNullOrEmpty(loginResult.token))
				{
					tokenAulaVirtual = loginResult.token;
					
					// Construir URL del aula virtual con token
					var aulaUrl = loginResult.urlAulaVirtual ?? $"{loginResult.token}";
					
					// Abrir en nueva pesta√±a
					await JS.InvokeVoidAsync("open", aulaUrl, "_blank");
					
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "Aula Virtual", 
						text = "Se ha abierto el Aula Virtual en una nueva pesta√±a. Complete el curso y luego presione 'Verificar avance'.", 
						icon = "info",
						timer = 4000
					});
				}
				else
				{
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "Error", 
						text = loginResult?.mensaje ?? "No se pudo autenticar con el Aula Virtual", 
						icon = "error" 
					});
				}
			}
			else
			{
				var errorMsg = await loginResponse.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new 
				{ 
					title = "Error", 
					text = $"Error al conectar con el Aula Virtual: {errorMsg}", 
					icon = "error" 
				});
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Error", 
				text = $"Error inesperado: {ex.Message}", 
				icon = "error" 
			});
		}
		finally
		{
			abriendonAulaVirtual = false;
			StateHasChanged();
		}
	}

	private async Task VerificarCursoEticaAsync()
	{
		if (SolicitudId <= 0) return;

		try
		{
			verificandoCurso = true;
			StateHasChanged();
			
			// Verificar el avance del curso en el Aula Virtual
			var response = await Http.GetAsync($"api/aulavirtual/verificar-avance?solicitudId={SolicitudId}");
			
			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<VerificarAvanceResponse>();
				
				if (result?.success == true)
				{
					// Actualizar informaci√≥n de avance
					// Los estados que devuelve el API son: "No inscrito", "En curso", "aprobado", "desaprobado"
					var estado = result.estado ?? "";
					avanceCursoDetalle = estado switch
					{
						"aprobado" => $"‚úì Curso aprobado ({result.porcentajeAvance ?? 100}%)",
						"En curso" => $"En curso - Avance: {result.porcentajeAvance ?? 0}%",
						"desaprobado" => $"Desaprobado - Avance: {result.porcentajeAvance ?? 0}%",
						"No inscrito" => "No inscrito - Debe inscribirse al curso",
						_ => estado != "" ? estado : "Estado desconocido"
					};
					
					// Curso completado si est√° aprobado (el API devuelve "aprobado" en min√∫sculas)
					cursoEticaCompletado = estado.Equals("aprobado", StringComparison.OrdinalIgnoreCase);
					
					if (cursoEticaCompletado)
					{
						estadoActual = "Curso completado, pendiente de documentos";
						// Si estamos en el paso 2, avanzar al paso 3
						if (currentStep == 2)
						{
							currentStep = 3;
							StateHasChanged();
						}
						
						await JS.InvokeVoidAsync("Swal.fire", new 
						{ 
							title = "¬°Curso Completado!", 
							text = "Ha completado exitosamente el curso de √âtica. Ahora puede continuar con el resto de la solicitud.", 
							icon = "success" 
						});
					}
					else if (estado.Equals("En curso", StringComparison.OrdinalIgnoreCase))
					{
						await JS.InvokeVoidAsync("Swal.fire", new 
						{ 
							title = "Curso en Progreso", 
							text = $"Su avance actual es del {result.porcentajeAvance ?? 0}%. Complete el curso para continuar.", 
							icon = "info" 
						});
					}
					else if (estado.Equals("desaprobado", StringComparison.OrdinalIgnoreCase))
					{
						await JS.InvokeVoidAsync("Swal.fire", new 
						{ 
							title = "Curso Desaprobado", 
							text = "Debe volver a realizar el curso para continuar con el proceso.", 
							icon = "warning" 
						});
					}
					else if (estado.Equals("No inscrito", StringComparison.OrdinalIgnoreCase))
					{
						await JS.InvokeVoidAsync("Swal.fire", new 
						{ 
							title = "No Inscrito", 
							text = "Debe inscribirse al curso de √âtica primero. Use el bot√≥n 'Ir al Aula Virtual' para acceder.", 
							icon = "info" 
						});
					}
				}
				else
				{
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "Error", 
						text = result?.mensaje ?? "No se pudo verificar el estado del curso", 
						icon = "error" 
					});
				}
			}
			else
			{
				var errorMsg = await response.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new 
				{ 
					title = "Error", 
					text = $"Error al verificar avance: {errorMsg}", 
					icon = "error" 
				});
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Error", 
				text = $"Error inesperado: {ex.Message}", 
				icon = "error" 
			});
		}
		finally
		{
			verificandoCurso = false;
			StateHasChanged();
		}
	}

	private async Task AbrirPasarelaPago()
	{
		if (SolicitudId <= 0)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Atenci√≥n", text = "Primero debe completar los pasos anteriores.", icon = "warning" });
			return;
		}

		try
		{
			abriendoPasarela = true;
			StateHasChanged();

			var response = await Http.PostAsync($"api/pago/abrir-pasarela?solicitudId={SolicitudId}", null);
			
			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<PasarelaPagoResponse>();
				
				if (result?.success == true && !string.IsNullOrEmpty(result.url))
				{
					// La pasarela exige POST: enviar form en nueva pesta√±a
					await JS.InvokeVoidAsync("premaAbrirPasarelaPost", result.url, result.postParams ?? new Dictionary<string, string>());
					
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "Pasarela de Pago", 
						text = "Se ha abierto la pasarela de pago en una nueva pesta√±a. Complete el pago y luego presione 'Verificar Pago'.", 
						icon = "info",
						timer = 4000
					});
				}
				else
				{
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "Error", 
						text = result?.mensaje ?? "No se pudo abrir la pasarela de pago", 
						icon = "error" 
					});
				}
			}
			else
			{
				var errorMsg = await response.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new 
				{ 
					title = "Error", 
					text = $"Error al abrir pasarela: {errorMsg}", 
					icon = "error" 
				});
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Error", 
				text = $"Error inesperado: {ex.Message}", 
				icon = "error" 
			});
		}
		finally
		{
			abriendoPasarela = false;
			StateHasChanged();
		}
	}

	private async Task VerificarPagoAsync()
	{
		if (SolicitudId <= 0)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Atenci√≥n", text = "No hay solicitud asociada.", icon = "warning" });
			return;
		}

		try
		{
			verificandoPago = true;
			StateHasChanged();

			var response = await Http.GetAsync($"api/pago/verificar?solicitudId={SolicitudId}");
			
			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<VerificarPagoResponse>();
				
				if (result?.pagado == true)
				{
					pagoCompletado = true;
					comprobantePago = result.comprobante ?? "Comprobante registrado";
					if (SolicitudId > 0)
					{
						try { await JS.InvokeVoidAsync("premaClearPaso4", SolicitudId); } catch { }
						try { await JS.InvokeVoidAsync("premaClearPoliticasDDJJ", SolicitudId); } catch { }
					}
					
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "¬°Pago Verificado!", 
						text = "El pago ha sido verificado correctamente. Puede continuar con el siguiente paso.", 
						icon = "success" 
					});
					
					if (currentStep == 4)
						currentStep = 5;
				}
				else
				{
					pagoCompletado = false;
					comprobantePago = string.Empty;
					
					await JS.InvokeVoidAsync("Swal.fire", new 
					{ 
						title = "Pago Pendiente", 
						text = result?.mensaje ?? "El pago a√∫n no ha sido registrado. Complete el pago en la pasarela y vuelva a verificar.", 
						icon = "info" 
					});
				}
			}
			else
			{
				var errorMsg = await response.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new 
				{ 
					title = "Error", 
					text = $"Error al verificar pago: {errorMsg}", 
					icon = "error" 
				});
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new 
			{ 
				title = "Error", 
				text = $"Error inesperado: {ex.Message}", 
				icon = "error" 
			});
		}
		finally
		{
			verificandoPago = false;
			StateHasChanged();
		}
	}

	private async Task SimularPagoDesarrolloAsync()
	{
		if (SolicitudId <= 0)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Atenci√≥n", text = "No hay solicitud asociada.", icon = "warning" });
			return;
		}

		try
		{
			simulandoPagoDev = true;
			StateHasChanged();

			var response = await Http.PostAsync($"api/pago/marcar-pagado-desarrollo?solicitudId={SolicitudId}", null);

			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<ResponseModel>();
				pagoCompletado = true;
				comprobantePago = "Simulado (DEV)";
				estadoIdActual = 1;
				estadoActual = "En revisi√≥n";
				if (SolicitudId > 0)
				{
					try { await JS.InvokeVoidAsync("premaClearPaso4", SolicitudId); } catch { }
					try { await JS.InvokeVoidAsync("premaClearPoliticasDDJJ", SolicitudId); } catch { }
				}

				await JS.InvokeVoidAsync("Swal.fire", new
				{
					title = "Pago simulado (DEV)",
					text = result?.Message ?? "Estado actualizado a Registrado. Se envi√≥ el correo de notificaci√≥n.",
					icon = "success"
				});

				if (currentStep == 4)
					currentStep = 5;
			}
			else
			{
				var errorMsg = await response.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new { title = "Error", text = errorMsg ?? "No se pudo simular el pago.", icon = "error" });
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { title = "Error", text = $"Error inesperado: {ex.Message}", icon = "error" });
		}
		finally
		{
			simulandoPagoDev = false;
			StateHasChanged();
		}
	}

	private async Task VerificarEstadoPago()
	{
		try
		{
			var response = await Http.GetAsync($"api/pago/verificar?solicitudId={SolicitudId}");
			if (response.IsSuccessStatusCode)
			{
				var result = await response.Content.ReadFromJsonAsync<VerificarPagoResponse>();
				if (result?.pagado == true)
				{
					pagoCompletado = true;
					comprobantePago = result.comprobante ?? "";
					currentStep = 5;
					if (SolicitudId > 0)
					{
						try { await JS.InvokeVoidAsync("premaClearPaso4", SolicitudId); } catch { }
						try { await JS.InvokeVoidAsync("premaClearPoliticasDDJJ", SolicitudId); } catch { }
					}
				}
				else
				{
					pagoCompletado = false;
					currentStep = 4;
				}
			}
			else
			{
				// Si no se puede verificar, asumir que no hay pago
				pagoCompletado = false;
				currentStep = 4;
			}
		}
		catch
		{
			// Si hay error, asumir que no hay pago
			pagoCompletado = false;
			currentStep = 4;
		}
	}
}

