@page "/decanato/lista"
@using MatriculaCMP.Shared
@using static MatriculaCMP.Shared.FirmaDigitalDTO
@inject IJSRuntime JS
@inject HttpClient Http


<div class="container-fluid">
	@if (mostrarPdf)
	{
		<div class="modal fade show" style="display:block;" tabindex="-1">
			<div class="modal-dialog modal-xl">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Vista previa del Diploma</h5>
						<button type="button" class="btn-close" @onclick="CerrarModalPdf"></button>
					</div>
					<div class="modal-body" style="height:75vh;background-color:#f8f9fa;">
						@if (!string.IsNullOrEmpty(pdfUrl))
						{
							<object data="@pdfUrl" type="application/pdf" width="100%" height="100%">
								<embed src="@pdfUrl" type="application/pdf" width="100%" height="100%" />
							</object>
						}
						else
						{
							<div class="text-center p-4">Cargando PDF...</div>
						}
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" @onclick="CerrarModalPdf">Cerrar</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal-backdrop fade show"></div>
	}
    <!-- start page title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                <h4 class="mb-sm-0">Decanato - Listado Diplomas</h4>

                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript: void(0);">Inicio</a></li>
                        <li class="breadcrumb-item active">Listado Diplomas</li>
                    </ol>
                </div>

            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body  pt-0">
					@if (iniciandoFirma)
					{
						<div style="position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index: 1000;display:flex;align-items:center;justify-content:center;color:#fff;">
							<div style="text-align:center">
								<div class="spinner-border text-light" role="status"></div>
								<div style="margin-top:12px;font-size:1.1rem;">Iniciando proceso de firma...<br/>Por favor espere hasta finalizar o cancelar.</div>
							</div>
						</div>
					}
					<div class="d-flex flex-wrap align-items-center mb-3 mt-2 gap-2">
						<span class="badge bg-primary d-flex align-items-center">
							<i class="ri-award-line me-1"></i> Decano
						</span>
						<div class="form-check ms-2">
							<input type="checkbox" id="chkTodos" class="form-check-input" checked="@seleccionarTodos" @onchange="SeleccionarTodasFilas" />
							<label class="form-check-label" for="chkTodos">Seleccionar todos (estado 10)</label>
						</div>
						<button type="button" class="btn btn-primary d-flex align-items-center" @onclick="FirmarSeleccionados">
							<i class="ri-fingerprint-fill align-middle me-2"></i> Firmar seleccionados
                                </button>
						<div class="text-muted small ms-2">Seleccionados: @alumnos.Count(a=>a.Seleccionado)</div>
						<div class="ms-auto" style="min-width:260px;max-width:340px;">
							<div class="input-group">
								<span class="input-group-text"><i class="ri-search-2-line"></i></span>
								<input class="form-control" placeholder="Buscar DNI, nombre o N° solicitud" @bind="Filtro" @bind:event="oninput" />
							</div>
                            </div>
                        </div>
                        <div class="table-responsive">
						<table class="table table-hover align-middle mb-0">
                                <thead class="thead-light">
                                    <tr>
									<th style="width:42px">
                                            <input type="checkbox" class="form-check-input" checked="@seleccionarTodos" @onchange="SeleccionarTodasFilas" />
                                        </th>
									<th>N° Solicitud</th>
									<th class="d-none d-sm-table-cell">Fecha Solicitud</th>
									<th>Estado</th>
									<th class="d-none d-md-table-cell">DNI</th>
                                        <th>Nombres Completos</th>
									<th class="d-none d-lg-table-cell">N° Colegiatura</th>
									<th class="d-none d-md-table-cell">Fecha Emisión Diploma</th>
									<th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
								@if(!alumnos.Any())
								{
									<tr>
										<td colspan="9" class="text-center text-muted py-4">No hay registros pendientes de firma.</td>
                                        </tr>
                                    }
								else
								{
									@foreach (var alumno in alumnos)
									{
										<tr>
											<td>
												<input type="checkbox" class="form-check-input" @bind="alumno.Seleccionado" disabled="@(alumno.EstadoId != 10)" />
                                            </td>
											<td>@alumno.NumeroSolicitud</td>
											<td class="d-none d-sm-table-cell">@alumno.FechaSolicitud.ToString("dd/MM/yyyy")</td>
											<td><span class="badge bg-info">@alumno.EstadoNombre</span></td>
											<td class="d-none d-md-table-cell">@alumno.NumeroDocumento</td>
                                            <td>@alumno.NombreCompleto</td>
											<td class="d-none d-lg-table-cell">@alumno.NumeroColegiatura</td>
											<td class="d-none d-md-table-cell">@alumno.DiplomaFechaEmision.ToString("dd/MM/yyyy")</td>
											<td class="text-nowrap">
												<button class="btn btn-sm btn-outline-info me-1" title="Ver Diploma" @onclick="(async ()=> await VerDiploma(alumno.SolicitudId, true))">
													<i class="ri-eye-fill"></i>
												</button>
												@if (alumno.EstadoId == 10)
												{
													<button class="btn btn-sm btn-outline-primary" title="Firma Decano" @onclick="(async ()=> await IniciarFirmaRol(alumno.SolicitudId, 4))">
														<i class="ri-quill-pen-line"></i>
													</button>
                                                }
                                            </td>
                                        </tr>
									}
                                    }
                                </tbody>
                            </table>
                        </div>

                    <!-- Modal Loading -->
                    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content text-center p-4">
                                <div class="spinner-border text-primary" role="status">
									<span class="visualmente-hidden">Cargando...</span>
                                </div>
                                <p class="mt-3">Descargando Formato...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>


@code {
    private bool seleccionarTodos = false;
	private string? pdfUrl;
	private bool mostrarPdf = false;
	private bool iniciandoFirma = false;
	private DotNetObjectReference<ListaDiplomas>? dotNetRef;
	private bool esFirmaLoteActual = false;
	private List<ItemFirma> paraFirma = new();
	private List<ItemFirmaView> alumnos = new();
	private List<ItemFirmaView> alumnosMaster = new();
	private string filtro = string.Empty;
	private string Filtro
	{
		get => filtro;
		set { filtro = value ?? string.Empty; AplicarFiltro(); }
	}

	protected override async Task OnInitializedAsync()
	{
		await CargarParaFirma();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
			dotNetRef = DotNetObjectReference.Create(this);
			await JS.InvokeVoidAsync("registrarInstanciaDotNet", dotNetRef);
        }
    }

    private void SeleccionarTodasFilas(ChangeEventArgs e)
    {
        seleccionarTodos = (bool)e.Value;
        foreach (var alumno in alumnos)
        {
			if (alumno.EstadoId == 10)
            alumno.Seleccionado = seleccionarTodos;
			else
				alumno.Seleccionado = false;
		}
	}

	private async Task CargarParaFirma()
	{
		try
		{
			var url = $"api/diploma/decanato-para-firma?ts={DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}";
			paraFirma = await Http.GetFromJsonAsync<List<ItemFirma>>(url);
			alumnosMaster = paraFirma.Select(x => new ItemFirmaView
			{
				SolicitudId = x.SolicitudId,
				NumeroSolicitud = x.NumeroSolicitud,
				FechaSolicitud = x.FechaSolicitud,
				EstadoId = x.EstadoId,
				EstadoNombre = x.EstadoNombre,
				NumeroDocumento = x.NumeroDocumento,
				NombreCompleto = x.NombreCompleto,
				NumeroColegiatura = x.NumeroColegiatura,
				DiplomaFechaEmision = x.DiplomaFechaEmision
			}).ToList();
			AplicarFiltro();
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("console.error", new { tag = "CargarParaFirmaDecanato", error = ex.Message });
		}
	}

	private void AplicarFiltro()
	{
		if (string.IsNullOrWhiteSpace(filtro))
		{
			alumnos = alumnosMaster.ToList();
			return;
		}
		var f = filtro.Trim().ToLowerInvariant();
		alumnos = alumnosMaster.Where(a =>
			a.NumeroSolicitud.ToString().Contains(f)
			|| (!string.IsNullOrEmpty(a.NumeroDocumento) && a.NumeroDocumento.ToLower().Contains(f))
			|| (!string.IsNullOrEmpty(a.NombreCompleto) && a.NombreCompleto.ToLower().Contains(f))
			|| (!string.IsNullOrEmpty(a.NumeroColegiatura) && a.NumeroColegiatura.ToLower().Contains(f))
		).ToList();
	}

	private async Task VerDiploma(int solicitudId, bool mostrarEnModal = false)
	{
		try
		{
			// Buscar siempre la versión más firmada [F]...[F]
			var basePath = $"/firmas_digitales/documento_{solicitudId}";
			string? firmadoMasReciente = null;
			var candidatos = new[] { "[F][F][F][F]", "[F][F][F]", "[F][F]", "[F]", "_firmado" };
			foreach (var suf in candidatos)
			{
				var url = $"{basePath}{suf}.pdf";
				var resp = await Http.GetAsync(url);
				if (resp.IsSuccessStatusCode)
				{
					firmadoMasReciente = url;
					break;
				}
			}
			if (!string.IsNullOrEmpty(firmadoMasReciente))
			{
				if (mostrarEnModal)
				{
					pdfUrl = firmadoMasReciente;
					mostrarPdf = true;
					StateHasChanged();
				}
				else
				{
					await JS.InvokeVoidAsync("open", firmadoMasReciente, "_blank");
				}
				return;
			}

			var prep = await Http.PostAsync($"api/diploma/preparar-firma/{solicitudId}", null);
			if (!prep.IsSuccessStatusCode)
			{
				var txt = await prep.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error", text = txt });
				return;
			}

			var json = await prep.Content.ReadFromJsonAsync<RespPrep>();
			if (mostrarEnModal)
			{
				pdfUrl = json?.url;
				mostrarPdf = true;
				StateHasChanged();
			}
			else
			{
				await JS.InvokeVoidAsync("open", json?.url, "_blank");
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error", text = ex.Message });
		}
	}

	private async Task IniciarFirmaRol(int solicitudId, int tipoDocumentoFirmado)
	{
		try
		{
			esFirmaLoteActual = false;
			iniciandoFirma = true;
			StateHasChanged();
			var preparar = await Http.PostAsync($"api/diploma/preparar-firma/{solicitudId}", null);
			if (!preparar.IsSuccessStatusCode)
			{
				var errPrep = await preparar.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "No se pudo preparar el PDF para firma", html = errPrep });
				iniciandoFirma = false;
				StateHasChanged();
				return;
			}

			var firmaRequest = new { IdExpedienteDocumento = solicitudId, IdExpedienteDocumentoFirmante = 0, TipoDocumentoFirmado = tipoDocumentoFirmado };
			var resp1 = await Http.PostAsJsonAsync("api/firmadigital/firmar", firmaRequest);
			if (!resp1.IsSuccessStatusCode)
			{
				var err = await resp1.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error al iniciar firma", html = err });
				iniciandoFirma = false;
				StateHasChanged();
				return;
			}
			var up = await resp1.Content.ReadFromJsonAsync<UploadResponse>();
			if (up?.codigoFirma <= 0)
			{
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Firma", text = up?.descripcion ?? "Sin código de firma" });
				iniciandoFirma = false;
				StateHasChanged();
				return;
			}

			await JS.InvokeVoidAsync("mostrarFormularioFirma", up.codigoFirma);
			firmaActualSolicitudId = solicitudId;
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error", text = ex.Message });
			iniciandoFirma = false;
			StateHasChanged();
		}
	}

	[JSInvokable]
	public async Task SubirDocumentoFirmado(string rptJsonStr)
	{
		try
		{
			var codigoFirma = await JS.InvokeAsync<string>("obtenerCodigoFirmaDesdeFormulario");
			if (string.IsNullOrWhiteSpace(codigoFirma) || !int.TryParse(codigoFirma, out var codigo))
			{
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Código de firma inválido" });
            return;
        }

			var seleccionados = alumnos.Where(a => a.Seleccionado && a.EstadoId == 10).Select(a => a.SolicitudId).ToList();
			HttpResponseMessage responseUpload;
			if (esFirmaLoteActual)
			{
				// Lote para Decano (tipo 4)
				responseUpload = await Http.PostAsJsonAsync("api/firmadigital-lote/upload", new { CodigoFirma = codigo, TipoDocumentoFirmado = 4 });
			}
			else
			{
				var targetId = firmaActualSolicitudId ?? (seleccionados.Count == 1 ? seleccionados[0] : 0);
				if (targetId <= 0 && seleccionados.Count > 0)
				{
					targetId = seleccionados[0];
				}
				if (targetId <= 0)
				{
					await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "No hay documento objetivo para subir la firma" });
					iniciandoFirma = false;
					esFirmaLoteActual = false;
					StateHasChanged();
					return;
				}
				var uploadRequest = new { IdExpedienteDocumento = targetId, IdExpedienteDocumentoFirmante = 0, CodigoFirma = codigo, TipoDocumentoFirmado = 4 };
				responseUpload = await Http.PostAsJsonAsync("api/firmadigital/upload", uploadRequest);
			}
			if (responseUpload.IsSuccessStatusCode)
			{
				var resultadoUpload = await responseUpload.Content.ReadFromJsonAsync<DownloadResponse>();
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "success", title = "Documento firmado y disponible en el servidor", showConfirmButton = true });
				await CargarParaFirma();
				iniciandoFirma = false;
				esFirmaLoteActual = false;
				StateHasChanged();
        }
        else
        {
				var error = await responseUpload.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error al subir documento firmado", html = error });
				iniciandoFirma = false;
				esFirmaLoteActual = false;
				StateHasChanged();
			}
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error inesperado", text = ex.Message });
			iniciandoFirma = false;
			esFirmaLoteActual = false;
			StateHasChanged();
		}
	}

	[JSInvokable]
	public async Task OnFirmaCancelada(string mensaje)
	{
		await JS.InvokeVoidAsync("Swal.fire", new { icon = "info", title = "Firma cancelada", html = mensaje, showConfirmButton = true });
		iniciandoFirma = false;
		esFirmaLoteActual = false;
		StateHasChanged();
	}

	private void CerrarModalPdf()
	{
		mostrarPdf = false;
		pdfUrl = null;
		StateHasChanged();
	}

	private int? firmaActualSolicitudId = null;

	public class RespPrep { public bool success { get; set; } public string url { get; set; } }
	public class ItemFirma { public int SolicitudId { get; set; } public int NumeroSolicitud { get; set; } public DateTime FechaSolicitud { get; set; } public int EstadoId { get; set; } public string EstadoNombre { get; set; } public int PersonaId { get; set; } public string NumeroDocumento { get; set; } public string NombreCompleto { get; set; } public string NumeroColegiatura { get; set; } public DateTime DiplomaFechaEmision { get; set; } public string RutaPdf { get; set; } }
	public class ItemFirmaView { public int SolicitudId { get; set; } public int NumeroSolicitud { get; set; } public DateTime FechaSolicitud { get; set; } public int EstadoId { get; set; } public string EstadoNombre { get; set; } public string NumeroDocumento { get; set; } public string NombreCompleto { get; set; } public string NumeroColegiatura { get; set; } public DateTime DiplomaFechaEmision { get; set; } public bool Seleccionado { get; set; } }

	private async Task FirmarSeleccionados()
	{
		var seleccionados = alumnos.Where(a => a.Seleccionado && a.EstadoId == 10).Select(a => a.SolicitudId).ToList();
		if (!seleccionados.Any())
		{
			await JS.InvokeVoidAsync("Swal.fire", new { icon = "warning", title = "Seleccione al menos un registro" });
			return;
		}
		try
		{
			esFirmaLoteActual = true;
			iniciandoFirma = true;
			StateHasChanged();

			var fallidos = new List<int>();
			foreach (var id in seleccionados)
			{
				var prep = await Http.PostAsync($"api/diploma/preparar-firma/{id}", null);
				if (!prep.IsSuccessStatusCode) fallidos.Add(id);
			}
			if (fallidos.Any())
			{
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "No se pudo preparar algunos PDFs", html = $"IDs: {string.Join(", ", fallidos)}" });
				iniciandoFirma = false;
				StateHasChanged();
				return;
			}

			// Firma en lote para Decano (tipo 4)
			var dto = new { Ids = seleccionados, TipoDocumentoFirmado = 4 };
			var resp = await Http.PostAsJsonAsync("api/firmadigital-lote/firmar", dto);
			if (!resp.IsSuccessStatusCode)
			{
				var err = await resp.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error al iniciar firma en lote", html = err });
				iniciandoFirma = false;
				StateHasChanged();
				return;
			}
			var up = await resp.Content.ReadFromJsonAsync<UploadResponse>();
			if (up?.codigoFirma <= 0)
			{
				await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Firma Lote", text = up?.descripcion ?? "Sin código de firma" });
				iniciandoFirma = false;
				StateHasChanged();
				return;
			}
			await JS.InvokeVoidAsync("mostrarFormularioFirma", up.codigoFirma);
		}
		catch (Exception ex)
		{
			await JS.InvokeVoidAsync("Swal.fire", new { icon = "error", title = "Error", text = ex.Message });
			iniciandoFirma = false;
			StateHasChanged();
		}
	}
}

<!-- Formulario oculto para SignNet (igual a CR/SG) -->
<center>
	<form type="post" id="ssoForm" name="ssoForm" target="iframeFirma" action="https://firmadorsignnet.cmp.org.pe:8443/SignnetSignature/Servicio" accept-charset="ISO-8859-1" style="display:none">
		<input type="text" id="codigoFirma" name="codigoFirma" value="" size="40" />
		<input type="button" id="btnFirma" name="btnFirma" value="Firma" />
	</form>
	<div id="dvIframe" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-body">
					<iframe frameborder="0" name="iframeFirma" id="iframeFirma" width="550px" height="320px"></iframe>
				</div>
			</div>
		</div>
	</div>
</center>
<script>
	let componenteRazor;
	window.registrarInstanciaDotNet = function (instancia) {
		componenteRazor = instancia;
	};
	window.mostrarFormularioFirma = function (codigoFirma) {
		console.log("DEC.mostrarFormularioFirma", { codigoFirma });
		document.getElementById("codigoFirma").value = codigoFirma;
		$('#dvIframe').modal({ backdrop: 'static', keyboard: false, show: true });
		console.log("DEC.submit.ssoForm");
		document.getElementById("ssoForm").submit();
	}
	window.obtenerCodigoFirmaDesdeFormulario = function () {
		return document.getElementById("codigoFirma").value;
	};

	// Escucha del mensaje desde el iframe (respuesta de SignNet)
	window.addEventListener("message", function (e) {
		try {
			var rptJSON = JSON.parse(e.data);
			console.log("DEC.postMessage recibido", rptJSON);
			console.log("DEC.postMessage.codigoRespuesta:", rptJSON.resultado);
			$('#dvIframe').modal('hide');
			if (componenteRazor && rptJSON.resultado === "0") {
				console.log("DEC.invocando SubirDocumentoFirmado (OK)");
				componenteRazor.invokeMethodAsync('SubirDocumentoFirmado', JSON.stringify(rptJSON))
					.then(() => console.log("DEC.SubirDocumentoFirmado invocado"))
					.catch(err => console.error("DEC.error invoke SubirDocumentoFirmado", err));
			} else if (componenteRazor) {
				console.warn("DEC.postMessage: Firma fallida o instancia no disponible");
				componenteRazor.invokeMethodAsync('OnFirmaCancelada', 'La firma fue cancelada por el usuario.')
					.catch(err => console.error('DEC.error invoke OnFirmaCancelada', err));
			}
		} catch (ex) {
			console.error("DEC.error parse postMessage", e.data);
		}
	});
</script>

